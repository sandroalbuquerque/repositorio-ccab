#include "Protheus.ch"
#Define cENTER      Chr(13) + Chr(10)
/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³SF1100I   ºAutor  ³Valdemir Jose       º Data ³  14/02/13   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³ Ponto de Entrada para Atualizar o Financeiro, Referente a  º±±
±±º          ³ Data de Vencimento                                         º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ CCAB                                                       º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
User Function SF1100I()
Local _cArea	:= GetArea()
Local _cQry     := ''
Local aVencto   := {}
Local lTrue     := .T.   
Local nI        := 1


	IF !EMPTY(SD1->D1_PEDIDO)                                                            
	   lTrue     := (SC7->C7_NUM = SD1->D1_PEDIDO)      // Verifica se as tabelas estão posicionadas no mesmo registro
	   if !lTrue
	      SC7->( dbSetOrder(1) )
	      lTrue := SC7->( dbSeek(xFilial('SC7')+SD1->D1_PEDIDO) )
	   Endif   
	   // Gera uma Lista com vencimentos 
	   if lTrue
	      aVencto   := GeraVencto(SC7->C7_XVENCTO) 
	      if Len(aVencto)=0
	      	Return
	      endif
	   Endif
		// Verifica Titulos Gerado
		_cQry += "SELECT * FROM "+RETSQLNAME('SE2')+" SE2 "+cENTER
		_cQry += "WHERE SE2.D_E_L_E_T_ = ' '         "+cENTER
		_cQry += " AND SE2.E2_FILIAL = '"+SF1->F1_FILIAL+"'   "	+cENTER
		_cQry += " AND SE2.E2_NUM='"+SF1->F1_DOC+"'	 "+cENTER
		_cQry += " AND SE2.E2_PREFIXO = '"+SF1->F1_PREFIXO+"' "	+cENTER
		_cQry += " AND SE2.E2_FORNECE = '"+SF1->F1_FORNECE+"' "+cENTER
		_cQry += " AND SE2.E2_LOJA = '"+SF1->F1_LOJA+"'       "+cENTER
	                              
		dbUseArea(.T., "TOPCONN", TCGenQry(,,_cQry), "TMPSE2", .F., .T.)
		
		dbSelectArea("TMPSE2")   
		WHILE !TMPSE2->( EOF() )
		    SE2->( dbSetOrder(1) )
		    if SE2->( dbSeek(xFilial('SE2')+TMPSE2->E2_PREFIXO+TMPSE2->E2_NUM) )
		    	Reclock('SE2',.F.)  
		    	SE2->E2_VENCTO := aVencto[nI]
		    	MsUnlock()                  
		    	nI += 1
		    Endif
			TMPSE2->( dbSkip() )
		ENDDO
		
    Endif

	RestArea(_cArea)
	
Return 



/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³GeraVenctoºAutor  ³Valdemir Jose       º Data ³  14/02/13   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³ Rotina ira gerar uma lista de vencimentos com base no      º±±
±±º          ³ campo C7_XVENCTO                                           º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ CCAB                                                       º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function GeraVencto(pC7_XVENCTO)
Local aRET    := {'','','','','','','','','','','','','','','','','','','',''}   
Local cString := Alltrim(pC7_XVENCTO)
Local cTMP    := ''                                        
Local nPosIni := 0
Local nI      := 1

While Len(cString) > 0                                        
    nPosIni := AT('/',cString)-2
    if nPosIni = 0
       cString := ''
       Exit
    endif
	cTMP    := Substr(cString,nPosIni,8)
	cString := Alltrim(Substr(cString,nPosIni+9,Len(cString)))
	if !Empty(cTMP)
		aRET[nI] := cTMP
		cTMP     := ''
		ni += 1
	Endif
EndDo


Return aRET