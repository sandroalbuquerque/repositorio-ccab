#INCLUDE "protheus.ch"
#INCLUDE "rwmake.ch"
#INCLUDE "topconn.ch"
#Include "Xmlxfun.ch"
//#INCLUDE "bitmap.ch"
#INCLUDE "ap5mail.ch"
#INCLUDE "shell.ch"


#define ENTER Chr(13)+Chr(10)
#IFDEF WINDOWS
#ENDIF

Static lTipo

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммммммяммммммммммкмммммммяммммммммммммммммммммкммммммяммммммммммммм╩╠╠
╠╠╨Programa  ЁLERXML    ╨Autor  ЁRoberto Recifae     ╨ Data Ё  02/07/10   ╨╠╠
╠╠лммммммммммьммммммммммймммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc.     ЁImportacao arquivo xml nota eletronica                      ╨╠╠
╠╠лддддддддддадддддддбддддддддддддбддддддддддддддддддддддддддддддддддддддд╧╠╠
╠╠╨ PROGRAMADOR      Ё  DATA      Ё MOTIVO DA ALTERACAO                   ╨╠╠
╠╠лддддддддддддддддддеддддддддддддеддддддддддддддддддддддддддддддддддддддд╧╠╠
╠╠╨Eduardo Cseh      Ё 27/11/2012 Ё #ECV20121127 - Mudanca na forma de    ╨╠╠
╠╠╨(Agility)         Ё            Ё buscar o valor dos itens de pedido com╨╠╠
╠╠╨                  Ё            Ё moeda diferente de REAL.              ╨╠╠
╠╠лддддддддддддддддддеддддддддддддеддддддддддддддддддддддддддддддддддддддд╧╠╠
╠╠╨Eduardo Cseh      Ё 04/01/2013 Ё #ECV20130104 - Alteracao da TAG do XML╨╠╠
╠╠╨(Agility)         Ё            Ё pois estava buscando incorretamente.  ╨╠╠
╠╠╨                  Ё            Ё nas operacoes de CT-e.                ╨╠╠
╠╠хммммммммммммммммммоммммммммммммоммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╨ VersЦo: Valdemir Jose - 23/05/2013                                    ╨╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
User Function LERXML()
Local nComboBo1     := 1   
Local oComboBo1      
Local oSay1
Local oBTExecuta  
Local oBTSair      
Local oResName

Private oXml
Private __cTES 		:= space(len(SD1->D1_TES))
Private __Cond 		:= space(len(SF1->F1_COND))
Private cEmissao    := "" //#ECV20121127.n    
Private aHeader     := {}
Private aCols       := {}
Private OBRWI                             
Private aFldCBAtu   := {}       
Private aNFITEM     := {}
Private cNatOp      := ''
Private cServer     := GetSrvProfString( 'ROOTPATH', '' ) + GetSrvProfString( 'STARTPATH', '' )  
Private cXML        := '\XML'
Private cServ       := '' 
Private _cLocal     := ''
Private aXML        := {}
Private cSerie      := ''
Private cSerieNF    := ''
Private cZeros      := .F.
Private cUnidades   := ''
Private cPedCom     := .F. 
Private cAlmox      := ''
Private cCamSel     := ''
Private cCamLoc     := ''
Private cEspecie    := '' 
Private cNDF        := .F.
Private aTituloX    := {}
Private aTitulo     := {} 
Private aCores      := {}  
Private cChave         
Private _cFornecedor:= ''
Private _cCNPJ      := ''
Private cNota
Private _cEnd
Private _cCidade
Private cNatOP
Private _cEmissao
Private nTotalNF
Private nTotIt
Private _cOpcao 
Private _nMoeda
Private _nTxMoeda
Private xSel       := .F.

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Fontes do windows usadas											Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
DEFINE FONT oFont1 NAME "Arial Black" SIZE 6,17
DEFINE FONT oFont2 NAME "Courier New" SIZE 8,14
DEFINE FONT oFont3 NAME "Arial Black" SIZE 13,20
DEFINE FONT oFont4 NAME "Arial Black" SIZE 13,15
DEFINE FONT oFont5 NAME "Arial Black" SIZE 7,17
DEFINE FONT oFont6 NAME "Courier New" SIZE 6,20
DEFINE FONT oFont7 NAME "Courier New" SIZE 7,20

_cUsuario := ALLTRIM(UPPER(SUBSTR(CUSUARIO,7,15)))
_cEmpresa := SM0->M0_CODIGO                                        
_cEmpCorr := _cEmpresa
_cCorrente:= SM0->M0_CODFIL
cArqTxt   := "\xml\config\cfgxml.txt"
       
// Caminhos a serem transitados
cServ   := "\XML\EMP_"+_cEmpCorr+"\"+_cCorrente
cXML    := '\XML'  
_cLocal := "C:\microsiga\EMP_"+_cEmpresa+"\"+_cCorrente
aXML    := {} 

cCamSel := ''  //cServ

// Valida XML para ser movido para pasta da filial correta
Processa({ || ValidaMoveXML(,_cLocal,cSERV)}, 'Validando arquivos da raiz...')


//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Criando parametro do programa										Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
DbSelectArea("SX6")
DbSetorder(1)
DbgoTop()
Dbseek(xFilial("SD1")+"MV_GRVPEDI")
If !Found()
	Reclock("SX6",.T.)
	SX6->X6_FIL:=xFilial("SD1")
	SX6->X6_VAR:="MV_GRVPEDI"
	SX6->X6_TIPO:="C"
	SX6->X6_DESCRIC:="Controle de gravacao pedidos de compras"
	MsUnlock()
Endif

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Controle de validade do programa									Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
//If DDATABASE>STOD("20101002") .or. DATE()>STOD("20101002")
//	msgbox("Este programa expirou, contate o proprietАrio para legalizaГЦo!")
//	Return
//Endif

// Valida Pastas Obrigatorias para ImportaГЦo - Valdemir 22/02/2013
ValidEmpresas()

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Verificando se o usuario ficou preco na ultima gravacao do pedido	Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
_lGrava:=ALLTRIM(UPPER(Getmv("MV_GRVPEDI")))
If _lGrava==_cUsuario
	DbSelectArea("SX6")
	DbgoTop()
	While ! eof()
		If Alltrim(SX6->X6_VAR)=="MV_GRVPEDI" .and. SX6->X6_FIL==xFilial("SC7")
			RecLock("SX6",.F.)
			SX6->X6_CONTEUD:=""
			MsUnlock()
		Endif
		DbSkip()
	End
Endif

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Manipulando arquivo de configuracao									Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If !File(cArqTxt) .OR. _cUsuario=="ADMINISTRADOR" .OR. _cUsuario=="ROBERTO" .OR. _cUsuario=="BETO"  .OR. _cUsuario=="DENISON"
	CONFARQ()
Endif

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Filial e empresa atual												Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
DbSelectarea("SM0")
Dbsetorder(1)
Dbgotop()
Dbseek(_cEmpCorr+_cCorrente)

// Ler ConfiguraГЦo Sistema
LerConfigura()

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Recebendo emails dos fornecedores									Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
///MsgRun("Recebendo XML "+xCONTA,,{||POPEMAIL()})
                           

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Produto alterados													Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
aCampos5:= {{"PRODUTO","C",15,0 }}

if Select('LS5')=0
	cArqTrab5  := CriaTrab(aCampos5)
	dbUseArea( .T.,, cArqTrab5, "LS5", .F., .F. )     //if(.F. .OR. .F., !.F., NIL)
	IndRegua("LS5",cArqTrab5,"PRODUTO",,,)
	dbSetIndex( cArqTrab5 +OrdBagExt())
Endif
dbSelectArea("LS5")
//{"CAIXAS","N",9,0 },;
aCampos	:= {{"SEQ","N",5,0 },;
{"OK","C",1,0 },;
{"CODBAR","C",15,0 },;
{"PRODUTO","C",15,0 },;
{"PRODFOR","C",15,0 },;
{"DESCRICAO","C",50,0 },;
{"DESCORI","C",50,0 },;
{"UM","C",2,0 },;
{"UMXML","C",2,0 },;
{"QE","N",4,0 },;
{"QUANTIDADE","N",11,3 },;
{"UM2","C",2,0 },;
{"QUANT2","N",11,3 },;
{"PRECO","N",18,7 },;
{"CUSTO","N",9,2 },;
{"PRECOFOR","N",18,7 },;
{"TOTAL","N",14,2 },;
{"DESCONTO","N",12,2 },;
{"EMISSAO","C",8,0 },;
{"PEDIDO","C",6,0 },;
{"ITEM","C",4,0 },;
{"TES","C",3,0 },;
{"ALMOX","C",2,0 },;
{"ALTERADO","C",1,0 },;
{"NOME","C",35,0 },;
{"NOTA","C",9,0 },;
{"LOTEFOR","C",18,0},;
{"LOTECTL","C",10,0 },;
{"OP","C",13,0 };
}
              
if Select('LS1')=0
	cArqTrab  := CriaTrab(aCampos)
	dbUseArea( .T.,, cArqTrab, "LS1",.f. , .F. )   //if(.F. .OR. .F., !.F., NIL)
	IndRegua("LS1",cArqTrab,"SEQ",,,)
	dbSetIndex( cArqTrab +OrdBagExt())
Endif
dbSelectArea("LS1")

aCampos3:= {{"EMISSAO","D",8,0 },;
{"NATOPER","C",30,0 },;							// Valdemir Jose 22/02/2013
{"FORNEC","C",6,0 },;
{"LOJA","C",2,0 },;        
{"NOTA","C",9,0 },;
{"NOME","C",35,0 },;
{"VENDEDOR","C",30,0 },;
{"TELEFONE","C",20,0 },;
{"XML","C",150,0 },;
{"CHAVE","C",150,0 },;
{"MOEDA","N",1,0 },;
{"TXMOEDA","N",6,2 } }

if Select('LS3')=0
	cArqTrab3  := CriaTrab(aCampos3)
	dbUseArea( .T.,, cArqTrab3, "LS3", .f., .F. )  //if(.F. .OR. .F., !.F., NIL)
	IndRegua("LS3",cArqTrab3,"NOME+NOTA",,,)
	dbSetIndex( cArqTrab3 +OrdBagExt())
Endif
dbSelectArea("LS3")

_cCNPJ:=''
lAchou:=.F.

#IFDEF WINDOWS
	Processa({|| XMLFOUND()})
	Return
	Static Function XMLFOUND()
#ENDIF      

aCampos4:= {{"NOTA","C",9,0 },;
{"FORNECEDOR","C",6,0 },;
{"LOJA","C",2,0 },;
{"BLQ","C",1}}

if Select('LS4')=0
	cArqTrab4  := CriaTrab(aCampos4)
	dbUseArea( .T.,, cArqTrab4, "LS4", if(.F. .OR. .F., !.F., NIL), .F. )
	IndRegua("LS4",cArqTrab4,"FORNECEDOR+LOJA+NOTA",,,)
	dbSetIndex( cArqTrab4 +OrdBagExt())
Endif
dbSelectArea("LS4")

// Limpa Variaveis
cNota   :=''
cEmissao:=''
cChave  :=''
_cOpcao :=''

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Tratamento conquista												Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If "CONQUISTA" $ ALLTRIM(UPPER(SM0->M0_NOME))
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁGrupos de compras										             	Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	aGrupos:={}
	cQuery:=" SELECT A2_GRPCOM GRUPO FROM "+RetSqlName("SA2")+" WHERE A2_FILIAL=' ' AND A2_GRPCOM<>' ' AND D_E_L_E_T_<>'*' GROUP BY A2_GRPCOM ORDER BY A2_GRPCOM "
	TCQUERY cQuery NEW ALIAS "TCQ"
	DbSelectarea("TCQ")
	While !Eof()
		AADD(aGrupos,TCQ->GRUPO)
		DbSkip()
	End
	DbClosearea("TCQ")
	AADD(aGrupos,"TODOS")
	
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁIdentificacao do Grupo										Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	@ 070,070 TO 150,280 dialog oGrupo title "Escolha o Grupo..."
	@ 005,010 SAY "Grupos Compras"
	@ 015,010 COMBOBOX _cOpcao ITEMS aGrupos SIZE 40,10
	@ 015,060 BUTTON "Confirma" SIZE 40,10 ACTION oGrupo:end()
	Activate Dialog oGrupo CENTERED
Endif
                  
// Zera Tabelas
If lAchou==.F.
   dbSelectArea('LS1')
   Zap

   dbSelectArea('LS3')
   Zap

   dbSelectArea('LS5')
   Zap
   
endif

// Limpa Variaveis
cNota	:=space(09)
cNatOp	:=''
_cCNPJ	:=space(18)
_cMensag:=''
nTotalNF:=0
nTotIt	:=0
_cFornecedor:=''
_cTelefone	:=''
_cInscr	:=''
_cEnd	:=''
_cCidade:=''
_cEmissao:=''
cUm		:=''
nDescont:=0

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё aHeaders 															Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
aTitulo := {}
AADD(aTitulo,{"PRODFOR",,"CСd.For."})
AADD(aTitulo,{"PRODUTO",,"Produto"})
AADD(aTitulo,{"DESCRICAO",,"DescriГЦo"})
AADD(aTitulo,{"UM",,"UM 1"})
AADD(aTitulo,{"QE",,"Emb.","@E 9999"})
//AADD(aTitulo,{"CAIXAS",,"Caixas","@E 99,999"})
AADD(aTitulo,{"QUANTIDADE",,"Quant. UM 1","@E 99,999.999"})
AADD(aTitulo,{"UM2",,"UM 2"})
AADD(aTitulo,{"QUANT2",,"Quant. UM 2"})
AADD(aTitulo,{"PRECO",,"PreГo R$","@E 9,999.9999999"})
AADD(aTitulo,{"CUSTO",,"Custo R$","@E 9,999.99"})
AADD(aTitulo,{"DESCONTO",,"Desc.R$","@E 99,999.99"})
AADD(aTitulo,{"TOTAL",,"Total R$","@E 9,999,999.99"})
AADD(aTitulo,{"PEDIDO",,"Pedido"})
AADD(aTitulo,{"ITEM",,"Item"})
AADD(aTitulo,{"ALMOX",,"ALMOX"})
AADD(aTitulo,{"TES",,"Tes"})
AADD(aTitulo,{"OP",,"OP"})

// Valdemir Jose 21/02/2013
aHeader := aClone(aTitulo)

aTituloX := {}
AADD(aTituloX,{"EMISSAO","EmissЦo"})
AADD(aTituloX,{"NATOPER","Nat.OperaГЦo"})
AADD(aTituloX,{"FORNEC","Fornec/Cliente"})
AADD(aTituloX,{"LOJA","Loja"})
AADD(aTituloX,{"NOME","Nome"})
AADD(aTituloX,{"VENDEDOR","Vendedor"})
AADD(aTituloX,{"TELEFONE","Telefone"})
AADD(aTituloX,{"CHAVE","Chave - Nota Fiscal EletrТnica"})
AADD(aTituloX,{"XML","Arquivo XML"})

DbSelectarea("LS3")
Dbgotop()

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё legenda de cores													Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
aCores := {{ 'LS1->OK=="X" ', 'BR_VERMELHO'  },;
{ 'EMPTY(LS1->OK) ', 'BR_VERDE'  },;
{ 'LS1->OK=="O" ', 'BR_CANCEL'  }}

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Resolucao da tela													Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
aSize := MsAdvSize()
IF aSize[5] >=1220
	_nTop:=760
	_nRight:=1225
	_nSize:=590
Else
	@ 120,040 TO 750,1010 DIALOG oTela TITLE "ImportaГЦo nota fiscal eletrТnica - "+SM0->M0_CODIGO+"/"+SM0->M0_CODFIL+"-"+SM0->M0_FILIAL
	_nTop:=750
	_nRight:=1010
	_nSize:=485
Endif

cMarca    := GetMark()
linverte  :=.f.          
nComboBo1 := 1
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Tela principal da rotina											Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
@ 120,040 TO _nTop,_nRight DIALOG oTela TITLE "ImportaГЦo nota fiscal eletrТnica - "+SM0->M0_CODIGO+"/"+SM0->M0_CODFIL+"-"+SM0->M0_FILIAL
@ 004,005 BITMAP oResName PROMPT ResName "OPEN" OF oTela Size 15,15 ON CLICK (MsgRun("Verificando pedidos em aberto...",,{|| IMPORTA() })) NoBorder  Pixel
@ 005,025 BUTTON "Recusar Recebimento" SIZE 65,10 ACTION RECUSAR()
@ 005,095 BUTTON "Re_fazer Nota Fiscal" SIZE 65,10 ACTION MsgRun("Restaurando informaГУes originais...",,{||REFAZER()})
@ 005,165 BUTTON "Excluir IdentificaГЦo" SIZE 65,10 ACTION EXCAMA()
@ 005,235 BUTTON "Cons_ultar SEFAZ" SIZE 65,10 ACTION MsgRun("Processando NFE no site da SEFAZ...",,{||SEFAZ()})
@ 005,305 BUTTON "HistСrico" SIZE 65,10 ACTION MsgRun("Processando histСrico do fornecedor...",,{||HISTFOR()})
//---------------------- Adicionado por Valdemir Jose 22/02/2013
@ 006, 401 COMBOBOX oComboBo1 VAR nComboBo1 ITEMS {"Vendas","Retorno Armazenagem","DevoluГЦo Compras","DevoluГЦo de Troca"} SIZE 072, 010 PIXEL OF oTela  //ON CHANGE U_Selecao() 
@ 008, 375 SAY oSay1 PROMPT "SeleГЦo" SIZE 025, 007 OF oTela COLORS 0, 16777215 PIXEL
@ 005, 474 BUTTON oBTExecuta PROMPT "Carregar" SIZE 026, 011 OF oTela ACTION ExecSelecao(oComboBo1:nAT) PIXEL
oBTExecuta:cToolTip := "Carregar o arquivo correspondente a seleГЦo"
oResName:cToolTip := "Verifica pedidos em aberto"
//-------------------------------------------------------------
@ 005,510 say "NOTA FISCAL ELETRтNICA" FONT oFont5 OF oTela PIXEL COLOR CLR_HRED

@ 020,005 TO 110,_nSize BROWSE "LS3" OBJECT OBRWP FIELDS aTituloX
OBRWP:oBrowse:BCHANGE := {|| PROCESS(), REAPRESENTA()}
OBRWP:oBrowse:oFont := TFont():New ("Arial", 06, 18)
OBRWP:oBrowse:nAt   := 1
OBRWP:oBrowse:REFRESH()

OBRWI:=MsSelect():New("LS1","","",aTitulo,@lInverte,@cMarca,{125,005,240,_nSize},,,,,aCores)
OBRWI:oBrowse:bLDblClick := {|| CORRIGE() }
OBRWI:oBrowse:oFont := TFont():New ("Arial", 05, 18)
OBRWI:oBrowse:nAt   := 1
OBRWI:oBrowse:REFRESH()

@ 245,003 TO 315,235
@ 250,005 say "FORNECEDOR" SIZE 150,40 FONT oFont4 OF oTela PIXEL COLOR CLR_GREEN
@ 260,005 say _cFornecedor size 200,20 FONT oFont3 OF oTela PIXEL COLOR CLR_HBLUE
@ 270,005 say "CNPJ" FONT oFont1 OF oTela PIXEL
@ 270,040 say _cCNPJ size 80,20 size 50,20 FONT oFont2 OF oTela PIXEL
@ 280,005 say "EndereГo" FONT oFont1 OF oTela PIXEL
@ 280,040 say _cEnd size 170,20 FONT oFont2 OF oTela PIXEL
@ 300,005 say "Cidade/UF" FONT oFont1 OF oTela PIXEL
@ 300,040 say _cCidade size 150,20 size 100,20 FONT oFont2 OF oTela PIXEL

@ 245,240 TO 315,435
@ 250,250 say "NOTA FISCAL" FONT oFont4 OF oTela PIXEL COLOR CLR_GREEN
@ 260,250 say "EmissЦo" FONT oFont1 OF oTela PIXEL
@ 260,290 say _cEmissao size 80,40 picture "@D 99/99/99" FONT oFont3 OF oTela PIXEL
@ 270,250 say "Total R$" FONT oFont1 OF oTela PIXEL
@ 270,290 say nTotalNF size 80,40 picture "@E 9,999,999.99" FONT oFont3 OF oTela PIXEL
@ 280,250 say "Qtd.Itens" FONT oFont1 OF oTela PIXEL
@ 280,290 say nTotIt size 40,40 picture "@E 9999" FONT oFont3 OF oTela PIXEL
@ 290,250 say "Nat.OperaГЦo" FONT oFont1 OF oTela PIXEL
@ 290,290 say SUBSTR(alltrim(cNatOP),1,32) size 180,40 picture "@!" FONT oFont2 OF oTela PIXEL COLOR CLR_HRED
@ 300,250 say "SИrie/Nota Fiscal" FONT oFont1 OF oTela PIXEL
@ 300,310 say ALLTRIM(cSerie)+"-"+cNota size 80,40 picture "@!" FONT oFont3 OF oTela PIXEL COLOR CLR_MAGENTA
@ 112,005 BUTTON "_HistСrico" SIZE 65,10 ACTION xMaCom()
@ 112,075 BUTTON "CСd.Barras" SIZE 65,10 ACTION CODBAR()
@ 112,145 BUTTON "_Mensagem Nota" SIZE 65,10 ACTION MSGNF(_cMensag)
@ 112,215 BUTTON "Legenda" SIZE 65,10 ACTION LEGENDA()
@ 112,285 BUTTON "_Selecionar Pedido" SIZE 65,10 ACTION PROCPED()
@ 112,355 BUTTON "_Eliminar Pedido do item" SIZE 65,10 ACTION ELIMPED()
@ 112,425 BUTTON "Eliminar _Todos Pedidos" SIZE 65,10 ACTION ELIMPEDT()
@ 112,495 BUTTON "Origem Pedido" SIZE 65,10 ACTION B103NFORI()     // Valdemir 21/02/2013
@ 245,530 BUTTON oBTSair PROMPT "Sair" SIZE 55,30 OF oTela ACTION {|| SairTela(), oTela:End()} PIXEL
oBTSair:cToolTip := "Sair da importaГЦo"

If aSize[5] >=1220
	@ 018,055 BITMAP SIZE 110,110 FILE "NFE.BMP" NOBORDER
	//	@ 018,065 BITMAP SIZE 110,110 FILE alltrim(cLogo)+".BMP" NOBORDER
Endif

ACTIVATE DIALOG oTela CENTER //VALID ValidaMoveXML()

Return
        



//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Gerando pre nota													Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function IMPORTA()
                          
IF EMPTY(cCamSel)
	msgbox("NЦo foi processado nenhuma importaГЦo no momento","AtenГЦo...","ALERT")
	RETURN
ENDIF
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Verifico se existe a nota fiscal									Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
IF !file(cCamSel+"\"+lower(LS3->XML)) .and. !file(cServ+"\"+lower(LS3->XML))
	msgbox("Este arquivo jА foi processado por outro usuАrio!","AtenГЦo...","ALERT")
	Reclock("LS3",.F.)
	dbdelete()
	MsUnlock()
	
	DbSelectarea("LS3")
	Dbgotop()
	PROCESS()
	Return
Endif

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Verificando se todas as variaveis foram preenchidas					Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If Empty(cNota)
	Msgbox("Numero de nota fiscal nЦo encontrada!")
	Return
Endif
If Empty(_cCNPJ)
	Msgbox("Dados do fornecedor nЦo encontradosNumero de nota fiscal nЦo encontrada!")
	Return
Endif
If nTotIt<=0
	Msgbox("Nota fiscal nЦo contem itens!")
	Return
Endif
If nTotalNF<=0
	Msgbox("Nota fiscal sem valores das mercadorias!")
	Return
Endif

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Verificando se todos os produtos foram identificados				Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
lIdent:=.F.
DbSelectarea("LS1")
Dbgotop()
While !Eof()
	IF LS1->OK=="X"
		lIdent := .T.
	Endif
	Dbskip()
End
Dbgotop()

If lIdent
	Msgbox("Existem produtos nЦo identificados, corrija primeiro!","AtenГЦo...","ALERT")
	Return
Endif

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Verificando se o pedido foi feito por item							Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If cPedCom
	lItem:=.F.
	DbSelectarea("LS1")
	Dbgotop()
	While !Eof()
		IF !Empty(LS1->PEDIDO)
			lItem := .T.
		Endif
		Dbskip()
	End
	
	If lItem
		DbSelectarea("LS1")
		Dbgotop()
		While !Eof()
			IF Empty(LS1->PEDIDO)
				Dbgotop()
				Msgbox("Existem produtos sem o pedido de compras, favor corrigi-los primeiro!","AtenГЦo...","ALERT")
				Return
			Endif
			Dbskip()
		End
	Endif
	
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Gerar pedido itens sem pedidos de compras							Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	lSemPed:=.F.
	If lItem
		DbSelectarea("LS1")
		Dbgotop()
		While !Eof()
			IF ALLTRIM(LS1->PEDIDO)=="CRIAR"
				lSemPed:=.T.
			Endif
			Dbskip()
		End
	Endif
	//rafael 05-07
	
	If lSemped
		//cResp:=msgbox("Deseja gerar o pedido para os itens que nЦo tem pedido de compra?","AtenГЦo...","YESNO")
		//	If cResp
		//		NEWPED2()
		//	Else
		DbSelectarea("LS1")
		dbgotop()
		Return
		//	Endif
	Endif
	
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Verificando se os produtos existem saldos no pedidos				Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If lItem
		DbSelectarea("LS1")
		Dbgotop()
		//	While !Eof()
		If !Eof()
			IF !Empty(LS1->PEDIDO)
				aProdutos	:= {{"PRODUTO","C",15,0 },;
				{"DESCRICAO","C",50,0 },;
				{"QUANTIDADE","N",12,3 },;
				{"PEDIDO","C",6,0 },;
				{"ITEM","C",4,0 },;
				{"PRECO","N",18,7 }}
				
				If Select("PRO") > 0
					DbSelectArea("PRO")
					DbCloseArea()
				EndIf
				
				cArqTrabp  := CriaTrab(aProdutos)
				dbUseArea( .T.,, cArqTrabp, "PRO", if(.F. .OR. .F., !.F., NIL), .F. )
				IndRegua("PRO",cArqTrabp,"PEDIDO+PRODUTO+ITEM",,,)
				dbSetIndex( cArqTrabp +OrdBagExt())
				dbSelectArea("PRO")
				
				//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Aglutinando produtos iguais											Ё
				//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				/*DbSelectarea("LS1") //rafael 05-07
				Dbsetorder(1)
				Dbgotop()
				While !Eof()
				DbSelectarea("PRO")
				DbSetorder(1)
				Dbgotop()
				Dbseek(LS1->PEDIDO+LS1->PRODUTO+LS1->ITEM)
				If !Found()
				Reclock("PRO",.T.)
				PRO->PRODUTO:=LS1->PRODUTO
				PRO->QUANTIDADE:=LS1->QUANTIDADE
				PRO->DESCRICAO:=LS1->DESCRICAO
				PRO->PRECO:=LS1->PRECO
				PRO->PEDIDO:=LS1->PEDIDO
				PRO->ITEM:=LS1->ITEM
				MsUnlock()
				Else
				Reclock("PRO",.F.)
				PRO->QUANTIDADE:=(PRO->QUANTIDADE+LS1->QUANTIDADE)
				MsUnlock()
				Endif
				DbSelectarea("LS1")
				Dbskip()
				End
				*/
			Endif
			//	DbSelectarea("LS1")
			//		Dbskip()
			//End
		EndIf
		
		cMsg:=''
		DbSelectArea("PRO")
		Dbgotop()
		While !Eof()
			cQuery:=" SELECT (C7_QUANT-C7_QUJE-C7_QTDACLA) QUANT FROM "+RetSqlName("SC7")+" WHERE C7_FILIAL='"+xFilial("SC7")+"' "
			cQuery:=cQuery + " AND C7_NUM='"+PRO->PEDIDO+"' "
			cQuery:=cQuery + " AND C7_PRODUTO='"+PRO->PRODUTO+"' "
			cQuery:=cQuery + " AND C7_ITEM='"+PRO->ITEM+"' "
			cQuery:=cQuery + " AND (C7_QUANT-C7_QUJE-C7_QTDACLA>0) "
			cQuery:=cQuery + " AND D_E_L_E_T_<>'*' "
			cQuery:=cQuery + " AND C7_RESIDUO<>'S' "
			cQuery:=cQuery + " ORDER BY C7_EMISSAO DESC "
			TCQUERY cQuery NEW ALIAS "TCQ"
			DbSelectarea("TCQ")
			IF PRO->QUANTIDADE>TCQ->QUANT
				cMsg:=cMsg+PRO->PEDIDO+"   "+PRO->ITEM+"   "+alltrim(PRO->PRODUTO)+"   "+PRO->DESCRICAO+CHR(13)+CHR(10)
			Endif
			Dbclosearea("TCQ")
			DbSelectArea("PRO")
			Dbskip()
		End
		
		If !Empty(cMsg)
			DEFINE MSDIALOG oProdd FROM 0,0 TO 300,420 PIXEL TITLE "produto sem estoque no momento..."
			@ 005,005 say " Pedido       Item       Produto    DescriГЦo" SIZE 150,40 FONT oFont1 OF oProdd PIXEL COLOR CLR_HBLUE
			@ 015,005 GET oMemo VAR cMsg MEMO SIZE 200,135 FONT oFont6 PIXEL OF oProdd
			ACTIVATE MSDIALOG oProdd CENTER
			
			Dbselectarea("PRO")
			dbCloseArea("PRO")
			fErase( cArqTrabp+ ".DBF" )
			fErase( cArqTrabp+ OrdBagExt() )
			
			DbSelectarea("LS1")
			Dbgotop()
			Return
		Endif
	Endif
Endif

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Valida se o preco esta proximo do correto							Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
cMsg:=''
DbSelectarea("LS1")
Dbgotop()
While !Eof()
	IF LS1->CUSTO>0
		IF (LS1->PRECO-LS1->CUSTO)>=1 .or. (LS1->CUSTO-LS1->PRECO)>=1
			cMsg:=cMsg+ALLTRIM(LS1->PRODUTO)+"  "+SUBSTR(LS1->DESCRICAO,1,35)+CHR(13)+CHR(10)
			cMsg:=cMsg+"PreГo Nota R$ "+transform(LS1->PRECO,"@E 9,999.99")+"   PreГo Pedido R$"+transform(LS1->CUSTO,"@E 9,999.99")+CHR(13)+CHR(10)
			cMsg:=cMsg+CHR(13)+CHR(10)
			
			Reclock("LS1",.F.)
			LS1->OK:="O"
			MsUnlock()
		Endif
	Endif
	Dbskip()
End
Dbgotop()

If !Empty(cMsg)
	lSaida:=.F.
	DEFINE MSDIALOG oProdd FROM 0,0 TO 330,420 PIXEL TITLE "Produtos com divergЙncia de preГos..."
	@ 005,005 GET oMemo VAR cMsg MEMO SIZE 200,135 FONT oFont6 PIXEL OF oProdd
	@ 150,005 BUTTON "<< Voltar" SIZE 55,10 ACTION oProdd:end()
	@ 150,070 BUTTON "Continuar >>" SIZE 55,10 ACTION (lsaida:=.T.,oProdd:end())
	ACTIVATE MSDIALOG oProdd CENTER
	
	If lSaida==.F.
		Return
	Endif
Endif

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Controla pedidos de compras											Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If cPedCom
	
	if lItem==.F.
		aProdutos	:= {{"PRODUTO","C",15,0 },;
		{"DESCRICAO","C",50,0 },;
		{"QUANTIDADE","N",12,3 },;
		{"PRECO","N",18,7 }}
		
		
		If Select("PRO") > 0
			DbSelectArea("PRO")
			DbCloseArea()
		EndIf
		cArqTrabp  := CriaTrab(aProdutos)
		dbUseArea( .T.,, cArqTrabp, "PRO", if(.F. .OR. .F., !.F., NIL), .F. )
		IndRegua("PRO",cArqTrabp,"PRODUTO",,,)
		dbSetIndex( cArqTrabp +OrdBagExt())
		dbSelectArea("PRO")
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Aglutinando produtos iguais											Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		DbSelectarea("LS1") //rafael 05-07
		Dbsetorder(1)
		Dbgotop()
		While !Eof()
			DbSelectarea("PRO")
			DbSetorder(1)
			Dbgotop()
			Dbseek(LS1->PRODUTO)
			If !Found()
				Reclock("PRO",.T.)
				PRO->PRODUTO    := LS1->PRODUTO
				PRO->QUANTIDADE := LS1->QUANTIDADE
				PRO->DESCRICAO  := LS1->DESCRICAO
				PRO->PRECO      := LS1->PRECO
				MsUnlock()
			Else
				Reclock("PRO",.F.)
				PRO->QUANTIDADE := (PRO->QUANTIDADE+LS1->QUANTIDADE)
				MsUnlock()
			Endif
			DbSelectarea("LS1")
			Dbskip()
		End
		
		
		aCampos2	:= {{"OK"		,"C",1,0 },;
						{"EMISSAO"	,"D",8,0 },;
						{"PEDIDO"	,"C",6,0 },;
						{"LOJA"		,"C",2,0 },;
						{"ITENS"	,"N",5,0 },;
						{"ENTREGA"	,"D",8,0 },;
						{"QTDIT"	,"N",5,0 },;
						{"VALIDO"	,"N",5,0 }}
		
		cArqTrab2  := CriaTrab(aCampos2)
		cIndice:="Descend(DTOS(EMISSAO))"
		dbUseArea( .T.,, cArqTrab2, "LS2", if(.F. .OR. .F., !.F., NIL), .F. )
		IndRegua("LS2",cArqTrab2,cIndice,,,)
		dbSetIndex( cArqTrab2 +OrdBagExt())
		dbSelectArea("LS2")
		
		lAchou:=.f.
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Verificando pedidos em aberto										Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		cQuery:=" SELECT C7_EMISSAO EMISSAO,C7_LOJA LOJA,C7_NUM PEDIDO,MAX(C7_DATPRF) ENTREGA,COUNT(*) QTD FROM "+RetSqlName("SC7")+" WHERE C7_FILIAL='"+xFilial("SC7")+"' "
		cQuery:=cQuery + " AND C7_FORNECE='"+LS3->FORNEC+"' "
		cQuery:=cQuery + " AND C7_EMISSAO>='"+DTOS(DDATABASE-60)+"' "
		cQuery:=cQuery + " AND (C7_QUANT-C7_QUJE-C7_QTDACLA>0) "
		cQuery:=cQuery + " AND D_E_L_E_T_<>'*' "
		cQuery:=cQuery + " AND C7_RESIDUO<>'S' "
		cQuery:=cQuery + " GROUP BY C7_EMISSAO,C7_NUM,C7_LOJA "
		cQuery:=cQuery + " ORDER BY C7_EMISSAO DESC "
		TCQUERY cQuery NEW ALIAS "TCQ"
		DbSelectarea("TCQ")
		While !Eof()
			Reclock("LS2",.T.)
			LS2->EMISSAO:=STOD(TCQ->EMISSAO)
			LS2->PEDIDO:=TCQ->PEDIDO
			LS2->LOJA:=TCQ->LOJA
			LS2->ITENS:=TCQ->QTD
			LS2->ENTREGA:=STOD(TCQ->ENTREGA)
			Msunlock()
			lAchou:=.T.
			DbSelectarea("TCQ")
			Dbskip()
		End
		DbClosearea("TCQ")
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Verifico quantidade de itens do pedidos e usados					Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		DbSelectarea("LS2")
		Dbgotop()
		While !Eof()
			cQuery:=" SELECT COUNT(*) QTD FROM "+RetSqlName("SC7")+" WHERE C7_FILIAL='"+xFilial("SC7")+"' AND C7_NUM='"+LS2->PEDIDO+"' "
			cQuery:=cQuery + " AND D_E_L_E_T_<>'*' "
			TCQUERY cQuery NEW ALIAS "TCQ"
			DbSelectarea("TCQ")
			_nUsados:=TCQ->QTD
			DbClosearea("TCQ")
			
			DbSelectarea("LS2")
			Reclock("LS2",.F.)
			LS2->QTDIT:=_nUsados
			MsUnlock()
			Dbskip()
		End
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Verifico Itens validos												Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		DbSelectarea("LS2")
		Dbgotop()
		While !Eof()
			_nItem:=0
			Dbselectarea("PRO")
			Dbgotop()
			While !Eof()
				DbSelectarea("SC7")
				DbSetorder(4)
				Dbgotop()
				Dbseek(xFilial("SC7")+PRO->PRODUTO+LS2->PEDIDO)
				If Found() .and. (SC7->C7_QUANT - SC7->C7_QUJE - SC7->C7_QTDACLA>0) .AND. (SC7->C7_QUANT - SC7->C7_QUJE - SC7->C7_QTDACLA >= PRO->QUANTIDADE) .AND. SC7->C7_RESIDUO <> "S"
					_nItem:=_nItem+1
				Endif
				Dbselectarea("PRO")
				Dbskip()
			End
			
			DbSelectarea("LS2")
			Reclock("LS2",.F.)
			IF _nItem==nTotIt
				LS2->OK:="X"
			Endif
			LS2->VALIDO:=_nItem
			MsUnlock()
			Dbskip()
		End
		
		Dbselectarea("LS1")
		Dbgotop()
		
		Dbselectarea("LS2")
		Dbgotop()
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё aHeader dos pedidos													Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		aTitulo2 := {}
		AADD(aTitulo2,{"EMISSAO","EmissЦo"})
		AADD(aTitulo2,{"PEDIDO","Pedido"})
		AADD(aTitulo2,{"LOJA","Lj"})
		AADD(aTitulo2,{"QTDIT","Itens","@E 9999"})
		AADD(aTitulo2,{"ITENS","Abertos","@E 9999"})
		AADD(aTitulo2,{"VALIDO","VАlidos","@E 9999"})
		AADD(aTitulo2,{"ENTREGA","Dt.Entrega"})
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Tela dos pedidos em aberto											Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If lAchou
			@ 120,040 TO 400,590 DIALOG oPedido TITLE "Pedidos em aberto..."
			@ 005,005 BITMAP ResName "CHECKED" OF oPedido Size 15,15 ON CLICK (VALIDA())  NoBorder  Pixel
			@ 005,035 BUTTON "A_tualizar Pedido" SIZE 55,10 ACTION PEDIDOS()
			@ 005,095 BUTTON "_Abrir Pedido" SIZE 55,10 ACTION ABREPED()
			@ 005,155 BUTTON "_DivergЙncias" SIZE 55,10 ACTION DIVERG()
			@ 005,215 BUTTON "_Eliminar" SIZE 55,10 ACTION ELIMINAR()
			@ 020,005 TO 140,275 BROWSE "LS2" ENABLE " LS2->OK<>'X' " OBJECT OBRWT FIELDS aTitulo2
			OBRWT:oBrowse:oFont := TFont():New ("Arial", 05, 18)
			OBRWT:oBrowse:REFRESH()
			ACTIVATE DIALOG oPedido CENTER
		Else
			//Msgbox("NЦo existem pedidos em aberto para este fornecedor!")
			If MsgYesNo("NЦo existem pedidos em aberto para este fornecedor. Deseja gerar a pre-nota sem pedido?")
				cRet:=.T.
			 	GeraPre()	
			EndIf			
			//rafael 05-07
			//cResp:=Msgbox("Deseja gerar um pedido automaticamente para esta nota eletrТnica?","AtenГЦo...","YESNO")
			//If cResp
			//		NEWPED()
			//	Endif
		Endif
		Dbselectarea("LS2")
		dbCloseArea("LS2")
		fErase( cArqTrab2+ ".DBF" )
		fErase( cArqTrab2+ OrdBagExt() )
	Else
		@ 120,040 TO 170,285 DIALOG oPedido TITLE "Pedidos por item..."
		@ 005,005 BUTTON "Gerar PrИ-Nota" SIZE 55,10 ACTION VALIDA()
		@ 005,065 BUTTON "_DivergЙncias" SIZE 55,10 ACTION DIVERG()
		ACTIVATE DIALOG oPedido CENTER
	Endif
	Dbselectarea("PRO")
	dbCloseArea("PRO")
	fErase( cArqTrabp+ ".DBF" )
	fErase( cArqTrabp+ OrdBagExt() )
Else
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Nao controla pedidos de compras										Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	cRet:=.T.
	If msgbox("Deseja gerar a prИ nota agora?","AtenГЦo...","YESNO")
		GeraPre()
	EndIf	
Endif

Dbselectarea("LS1")
Dbgotop()
Return

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Valida pedido														Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function VALIDA()

iF lItem==.F.
	If LS2->OK<>"X"
		Msgbox("Este pedido nЦo atende as necessidades da nota fiscal!")
		Return
	Endif
Endif

Dbselectarea("LS1")
Dbgotop()
While !Eof()
	cQuery:=" SELECT C7_NUM PEDIDO,C7_LOCAL ALMOX,C7_TES TES,C7_ITEM ITEM,(C7_QUANT-C7_QUJE-C7_QTDACLA) QUANT FROM "+RetSqlName("SC7")+" WHERE C7_FILIAL='"+xFilial("SC7")+"' "
	IF lItem==.F.
		cQuery:=cQuery + " AND C7_NUM='"+LS2->PEDIDO+"' "
	Else
		cQuery:=cQuery + " AND C7_NUM='"+LS1->PEDIDO+"' "
		cQuery:=cQuery + " AND C7_ITEM='"+LS1->ITEM+"' "
	Endif
	cQuery:=cQuery + " AND C7_PRODUTO='"+LS1->PRODUTO+"' "
	cQuery:=cQuery + " AND (C7_QUANT-C7_QUJE-C7_QTDACLA>0) "
	cQuery:=cQuery + " AND C7_RESIDUO<>'S' "
	cQuery:=cQuery + " AND D_E_L_E_T_<>'*' "
	TCQUERY cQuery NEW ALIAS "TCQ"
	DbSelectarea("TCQ")
	While !Eof()
		IF (TCQ->QUANT>=LS1->QUANTIDADE) .AND. TCQ->QUANT>0 .AND. LS1->QUANTIDADE>0
			Reclock("LS1",.F.)
			__xPedido   := TCQ->PEDIDO
			LS1->PEDIDO := TCQ->PEDIDO
			LS1->ITEM   := TCQ->ITEM
			LS1->TES    := TCQ->TES    
			LS1->ALMOX  := TCQ->ALMOX
			MsUnlock()
		Endif
		DbSelectarea("TCQ")
		Dbskip()
	End
	DbClosearea("TCQ")
	Dbselectarea("LS1")
	Dbskip()
End

lEntrou:=.f.
DbSelectarea("LS1")
Dbgotop()
While !Eof()
	IF Empty(LS1->PEDIDO) .or. Empty(LS1->ITEM)
		Msgbox("O Produto "+alltrim(LS1->PRODUTO)+" nЦo possui pedido/Item!")
		lEntrou:=.T.
	Endif
	Dbskip()
End

If lEntrou
	Msgbox("Existem produtos sem o pedido/item!")
	Return
Endif

cRet:=.F.

cResp:=msgbox("Deseja gerar a prИ nota agora?","AtenГЦo...","YESNO")

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Manipulando numero da nota fiscal									Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If cZeros
	cNota:=strzero(val(cNota),9)
Endif
cSpaco:=9-len(alltrim(cNota))

If cResp
	
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Verifico se a pre nota ja existe									Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	dbSelectArea("SF1")
	DbSetorder(2)
	Dbgotop()
	Dbseek(xFilial("SF1")+LS3->FORNEC+LS3->LOJA+alltrim(cNota)+Space(cSpaco))
	If Found() .and. SF1->F1_TIPO=="N"
		
		Msgbox("Nota fiscal jА existe!","AtenГЦo...","ALERT")
		FRename("\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\"+lower(ALLTRIM(LS3->XML)),"\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\"+lower(ALLTRIM(LS3->XML))+".imp")
		FRename("\XML\"+ALLTRIM(LS3->XML),"\xml\"+ALLTRIM(LS3->XML)+".imp")
		__CopyFile("\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\*.imp","\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\importados\")
		ferase("\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\"+ALLTRIM(LS3->XML)+".imp")
		
		Reclock("LS3",.F.)
		dbdelete()
		MsUnlock()
		
		DbSelectarea("LS3")
		Dbgotop()
		
		DbSelectarea("LS1")
		Dbsetorder(1)
		Dbgotop()
		While !Eof()
			Reclock("LS1",.F.)
			dbdelete()
			MsUnlock()
			Dbskip()
		End
		
		DbSelectarea("LS5")
		Dbsetorder(1)
		Dbgotop()
		While !Eof()
			Reclock("LS5",.F.)
			dbdelete()
			MsUnlock()
			Dbskip()
		End
		
		PROCESS()
		oPedido:end()
		Return
	Endif
	
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Gravando pre nota entrada											Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	
	SEFAZ()
	If !FS_CONSER(LS3->CHAVE)
		Return
	Endif
	
	MsgRun("Gerando prИ nota entrada No.:"+cNota,,{|| PRENOTA() })
	cNotaAtu:=cNota
	
	If cRet
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Gravando amarracao produto x fornecedor								Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		DbSelectarea("LS1")
		Dbsetorder(1)
		Dbgotop()
		While !Eof()
			If !Empty(LS1->PRODFOR)
				DbSelectarea("SA5")
				DbSetorder(1)
				Dbgotop()
				Dbseek(xFilial("SA5")+LS3->FORNEC+LS3->LOJA+LS1->PRODUTO)
				If !Found()
					Reclock("SA5",.T.)
					SA5->A5_FILIAL   := xFilial("SA5")
					SA5->A5_FORNECE  := LS3->FORNEC
					SA5->A5_LOJA     := LS3->LOJA
					SA5->A5_CODPRF   := LS1->PRODFOR
					SA5->A5_PRODUTO  := LS1->PRODUTO
					SA5->A5_NOMPROD  := SUBSTR(POSICIONE("SB1",1,xFilial("SB1")+LS1->PRODUTO,"B1_DESC"),1,30)
					If lItem==.F.
						SA5->A5_NOMEFOR := POSICIONE("SA2",1,xFilial("SA2")+LS3->FORNEC+LS2->LOJA,"A2_NREDUZ")
					Else
						SA5->A5_NOMEFOR := POSICIONE("SA2",1,xFilial("SA2")+LS3->FORNEC+LS3->LOJA,"A2_NREDUZ")
					Endif
					MsUnlock()
				Else
					Reclock("SA5",.F.)
					SA5->A5_CODPRF := LS1->PRODFOR
					MsUnlock()
				Endif
			Endif
			DbSelectarea("LS1")
			Reclock("LS1",.F.)
			dbdelete()
			MsUnlock()
			Dbskip()
		End
		
		DbSelectarea("LS3")
		FRename("\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\"+ALLTRIM(LS3->XML),"\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\"+ALLTRIM(LS3->XML)+".imp")
		__CopyFile("\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\*.imp","\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\importados\")
		ferase("\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\"+ALLTRIM(LS3->XML)+".imp")
		
		Reclock("LS3",.F.)
		dbdelete()
		MsUnlock()
		
		DbSelectarea("LS3")
		Dbgotop()
		oPedido:end()
		
		Msgbox("PrИ-Nota "+cNotaAtu+" gerada com sucesso!","AtenГЦo...","INFO")
		FS_EXINF()
		
		PROCESS()
	Endif
Endif
Return

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Corrigir produto													Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function CORRIGE()

nSeek:=LS1->SEQ

If LS1->OK=="X"
	aCampos6:= {{"PRODUTO","C",15,0 },;
	{"DESCRICAO","C",45,0 },;
	{"QE","N",6,2 },;
	{"SALDO","N",12,2 },;
	{"PEDIDO","C",3,0 },;
	{"BLQ","C",5,0 }}
	
	IF SELECT("LS4") > 0  
		dbSelectArea('LS4')
		LS4->( dbCloseArea() )
		fErase( cArqTrab4+ ".DBF" )
		fErase( cArqTrab4+ OrdBagExt() )	
	ENDIF
	cArqTrab6  := CriaTrab(aCampos6)
	dbUseArea( .T.,, cArqTrab6, "LS4", if(.F. .OR. .F., !.F., NIL), .F. )
	IndRegua("LS4",cArqTrab6,"DESCRICAO",,,)
	dbSetIndex( cArqTrab6 +OrdBagExt())
	dbSelectArea("LS4")
	
	lTem:=.F.
	cQuery:=" SELECT B1_MSBLQL BLQ,B1_CODBAR CODBAR,B1_COD PRODUTO,B1_DESC DESCRICAO FROM "+RetSqlName("SB1")+" "
	cQuery:=cQuery + " WHERE B1_FILIAL='"+xFilial("SB1")+"' "
	cQuery:=cQuery + " AND B1_DESC LIKE '"+'%'+SUBSTR(LS1->DESCRICAO,1,4)+'%'+"' "
	cQuery:=cQuery + " AND B1_PROC='"+LS3->FORNEC+"' "
	cQuery:=cQuery + " AND D_E_L_E_T_<>'*' "
	TCQUERY cQuery NEW ALIAS "TCQ"
	DbSelectarea("TCQ")
	While !Eof()
		If Empty(cAlmox)
			cAlmox:=Posicione("SB1",1,xFilial("SB1")+TCQ->PRODUTO,"B1_LOCPAD")
		Endif
		
		Reclock("LS4",.T.)
		LS4->PRODUTO:=TCQ->PRODUTO
		IF "SAIU" $ TCQ->DESCRICAO
			LS4->DESCRICAO:=SUBSTR(TCQ->DESCRICAO,6,45)
		Else
			LS4->DESCRICAO:=TCQ->DESCRICAO
		Endif
		LS4->SALDO:=POSICIONE("SB2",2,xFilial("SB2")+cAlmox+TCQ->PRODUTO,"B2_QATU-B2_RESERVA-B2_QEMP")
		LS4->QE:=POSICIONE("SB1",1,xFilial("SB1")+TCQ->PRODUTO,"B1_QE")
		LS4->PEDIDO:=TEMPED(TCQ->PRODUTO)
		LS4->BLQ:=IIF(TCQ->BLQ=="1","Bloq.","Ativo")
		MsUnlock()
		DbSelectarea("TCQ")
		Dbskip()
	End
	DbClosearea("TCQ")
	
	_cProduto:=Space(15)
	
	aTitulo6 := {}
	AADD(aTitulo6,{"BLQ","Sit."})
	AADD(aTitulo6,{"PRODUTO","Produto"})
	AADD(aTitulo6,{"DESCRICAO","DescriГЦo"})
	AADD(aTitulo6,{"QE","Qtd.Emb.","@E 99999"})
	AADD(aTitulo6,{"SALDO","Saldo Atual","@e 99,999.99"})
	AADD(aTitulo6,{"PEDIDO","Possui Pedido?"})
	
	DbSelectarea("LS4")
	Dbgotop()
	
	_cFiltrox	:=SUBSTR(LS1->DESCRICAO,1,4)+space(30)
	lCheck1		:=.F.

	if !xSel
		@ 120,040 TO 450,880 DIALOG oAmarra TITLE "Produto do fornecedor..."
		@ 005,005 say LS1->DESCRICAO SIZE 200,40 FONT oFont1 OF oAmarra PIXEL
		@ 020,005 TO 140,417 BROWSE "LS4" OBJECT OBRWX FIELDS aTitulo6
		OBRWX:OBROWSE:bLDblClick   := {|| SELECIONA(LS4->PRODUTO,2) }
		OBRWX:oBrowse:oFont := TFont():New ("Arial", 07, 18)
		OBRWX:oBrowse:REFRESH()
		
		@ 005,210 say "Filtro" SIZE 200,40 FONT oFont1 OF oAmarra PIXEL COLOR CLR_HRED
		@ 005,230 get _cFiltrox SIZE 70,20 Picture "@!"
		@ 005,300 BUTTON "_Filtrar" SIZE 35,10 ACTION MsgRun("Processando produtos...",,{||FILTRE()})
		If cPedCom                            	
			@ 005,340 CHECKBOX "Somente com Pedidos" VAR lCheck1
		Endif
		@ 150,010 BUTTON "Reativar Produto" SIZE 60,12 ACTION DESBLOQ()
		ACTIVATE DIALOG oAmarra CENTER
	ELSE
	  xSel := .F.
	endif
	
	Dbselectarea("LS4")
	dbCloseArea("LS4")
	fErase( cArqTrab6+ ".DBF" )
	fErase( cArqTrab6+ OrdBagExt() )


	Return
Endif

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Corrigir produtos encontrados automaticamente						Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If Empty(LS1->OK) .OR. LS1->OK=="O"
	SELECIONA(LS1->PRODUTO,1)
Endif

Return
                 


//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Processando arquivos												Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function XML(pSelecao,pArq,pCaminho)
Local iSelecao   := if(pSelecao<>2,0,2)
private _oXml    := NIL
private cError   := ''
private cWarning := ''

nXmlStatus := XMLError()
cFile	   := pCaminho+"\"+lower(ALLTRIM(pArq))
oXml 	   := XmlParserFile(cFile,"_",@cError, @cWarning )
lTipo	   :=3

If ALLTRIM(TYPE("oxml:_NFE:_INFNFE"))=="O"
	lTipo:=1
ElseIf ALLTRIM(TYPE("oxml:_NFEPROC:_NFE:_INFNFE"))=="O"
	lTipo:=2
ElseIf AllTrim(Type("oXml:_CTEPROC:_CTE:_INFCTE")) == "O"
	lTipo := 4
EndIf

If Empty(@cError) .and. lTipo<>3
	
	If lTipo==1
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Sem _NFEPROC															Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If SUBSTR(alltrim(oxml:_NFE:_INFNFE:_DEST:_IE:TEXT),1,1) $ "0/1/2/3/4/5/6/7/8/9"
			_cCNPJ2:=alltrim(oxml:_NFE:_INFNFE:_DEST:_CNPJ:TEXT)
		Endif
		_cCNPJ:=alltrim(oxml:_NFE:_INFNFE:_EMIT:_CNPJ:TEXT)
		cEmissao:=oxml:_NFE:_INFNFE:_IDE:_DEMI:TEXT
		cEmissao:=SUBSTR(cEmissao,1,4)+SUBSTR(cEmissao,6,2)+SUBSTR(cEmissao,9,2)
		cNota:=oxml:_NFE:_INFNFE:_IDE:_NNF:TEXT
		If Empty(cSerieNF)
			cSerie:=oxml:_NFE:_INFNFE:_IDE:_SERIE:TEXT
		Endif
		cNatOp:=oxml:_NFE:_INFNFE:_IDE:_NATOP:TEXT
		cChave:=ALLTRIM(SUBSTR(oxml:_NFE:_INFNFE:_ID:TEXT,4,200))
	ElseIf lTipo==2
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Com_NFEPROC											     			Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If SUBSTR(alltrim(oxml:_NFEPROC:_NFE:_INFNFE:_DEST:_IE:TEXT),1,1) $ "0/1/2/3/4/5/6/7/8/9" //oXml:_CTEPROC:_CTE:_INFCTE:_DEST:_IE:TEXT
			_cCNPJ2:=alltrim(oxml:_NFEPROC:_NFE:_INFNFE:_DEST:_CNPJ:TEXT) //oXml:_CTEPROC:_CTE:_INFCTE:_DEST:_CNPJ:TEXT
		Endif
		_cCNPJ:=alltrim(oxml:_NFEPROC:_NFE:_INFNFE:_EMIT:_CNPJ:TEXT)//oXml:_CTEPROC:_CTE:_INFCTE:_EMIT:_CNPJ:TEXT
		cNota:=oxml:_NFEPROC:_NFE:_INFNFE:_IDE:_NNF:TEXT//oXml:_CTEPROC:_CTE:_INFCTE:_IDE:_NCT:TEXT
		If Empty(cSerieNF)
			cSerie:=oxml:_NFEPROC:_NFE:_INFNFE:_IDE:_SERIE:TEXT//oXml:_CTEPROC:_CTE:_INFCTE:_IDE:_SERIE:TEXT
		Endif
		cNatOp:=oxml:_NFEPROC:_NFE:_INFNFE:_IDE:_NATOP:TEXT //oXml:_CTEPROC:_CTE:_INFCTE:_IDE:_NATOP:TEXT
		cEmissao:=oxml:_NFEPROC:_NFE:_INFNFE:_IDE:_DEMI:TEXT//oXml:_CTEPROC:_CTE:_INFCTE:_IDE:_DHEMI:TEXT
		cEmissao:=SUBSTR(cEmissao,1,4)+SUBSTR(cEmissao,6,2)+SUBSTR(cEmissao,9,2)
		cChave:=ALLTRIM(SUBSTR(oxml:_NFEPROC:_NFE:_INFNFE:_ID:TEXT,4,200))//Substring(oXml:_CTEPROC:_CTE:_INFCTE:_ID:TEXT,4,200)
	ElseIf lTipo == 4
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё CTE Com CTEPROC								Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		
		//_cCNPJ2:=AllTrim(oXml:_CTEPROC:_CTE:_INFCTE:_DEST:_CNPJ:TEXT)	//#ECV20130104.o
		
		//#ECV20130104.bn
		If AllTrim(Type("oXml:_CTEPROC:_CTE:_INFCTE:_DEST:_CPF")) == "O" //Caso a TAG de CPF exista
			_cCNPJ2:=AllTrim(oXml:_CTEPROC:_CTE:_INFCTE:_DEST:_CPF:TEXT)
		
		ElseIf AllTrim(Type("oXml:_CTEPROC:_CTE:_INFCTE:_DEST:_CNPJ")) == "O" //Caso a TAG de CNPJ exista 	
			_cCNPJ2:=AllTrim(oXml:_CTEPROC:_CTE:_INFCTE:_DEST:_CNPJ:TEXT)
		
		EndIf		     

		If AllTrim(Type("oXml:_CTEPROC:_CTE:_INFCTE:_IDE:_TOMA4:_CNPJ")) == "O" //Caso a CCAB seja o tomador do servico  
			_cCNPJ3:= Alltrim(oXml:_CTEPROC:_CTE:_INFCTE:_IDE:_TOMA4:_CNPJ:TEXT)
		
		Else
			If AllTrim(Type("oXml:_CTEPROC:_CTE:_INFCTE:_REM:_CNPJ")) == "O"  
				_cCNPJ3:=Alltrim(oXml:_CTEPROC:_CTE:_INFCTE:_REM:_CNPJ:TEXT) //Criado para tratar a situacao onde o destinatario nao eh a CCAB e sim o cliente	
			
			ElseIf AllTrim(Type("oXml:_CTEPROC:_CTE:_INFCTE:_REM:_CPF")) == "O"  			
				_cCNPJ3:=Alltrim(oXml:_CTEPROC:_CTE:_INFCTE:_REM:_CPF:TEXT)
			
			EndIf
		
		EndIf
		//#ECV20130104.en
		
		_cCNPJ	:=Alltrim(oXml:_CTEPROC:_CTE:_INFCTE:_EMIT:_CNPJ:TEXT)
		cNota	:=oXml:_CTEPROC:_CTE:_INFCTE:_IDE:_NCT:TEXT
		If Empty(cSerieNF)
			cSerie	:=oXml:_CTEPROC:_CTE:_INFCTE:_IDE:_SERIE:TEXT
		Endif
		cNatOp	:=oXml:_CTEPROC:_CTE:_INFCTE:_IDE:_NATOP:TEXT
		cEmissao:=oXml:_CTEPROC:_CTE:_INFCTE:_IDE:_DHEMI:TEXT
		cEmissao:=SUBSTR(cEmissao,1,4)+SUBSTR(cEmissao,6,2)+SUBSTR(cEmissao,9,2)
		cChave	:=Substr(oXml:_CTEPROC:_CTE:_INFCTE:_ID:TEXT,4,200)
	EndIf
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Manipulando numero da nota fiscal									Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If len(alltrim(cNota)) <= 6
		cNota	:=strzero(val(cNota),6)
	Endif
	If cZeros
		cNota	:=strzero(val(cNota),9)
	Endif
	nTam:=len(alltrim(cNota))
	cSpaco:=(9-nTam)
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Empresa atual														Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	/*#ECV20130104.bo
	If alltrim(_cCNPJ2)<>alltrim(SM0->M0_CGC)
		_cCNPJ:=''
		MsgAlert("A Nota Fiscal de nЗmero: "+cNota+" nЦo pertence a filial posicionada!")
	EndIf
	#ECV20130104.eo */
	 
	//#ECV20130104.bn
	If lTipo == 4 //Caso seja uma NF de CT-e
		If alltrim(_cCNPJ3)<>alltrim(SM0->M0_CGC)
			_cCNPJ:=''
			MsgAlert("A Nota Fiscal de nЗmero: "+cNota+" nЦo pertence a filial posicionada!")
		EndIf
	Else
		If alltrim(_cCNPJ2)<>alltrim(SM0->M0_CGC)
			_cCNPJ:=''
			MsgAlert("A Nota Fiscal de nЗmero: "+cNota+" nЦo pertence a filial posicionada!")
		EndIf
	EndIf
	//#ECV20130104.en
	
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Verifico se a nota ja foi importada									Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If !Empty(_cCNPJ)
	   if iSelecao = 0
		 DbSelectarea("SA2")
		 DbSetorder(3)
		 Dbgotop()
		 Dbseek(xFilial("SA2")+_cCNPJ)
		 If Found()
		 	dbSelectArea("SF1")
		 	DbSetorder(2)
		 	Dbgotop()
		 	Dbseek(xFilial("SF1")+SA2->A2_COD+SA2->A2_LOJA+alltrim(cNota)+Space(cSpaco))
		 	If Found() .and. SF1->F1_TIPO=="N"
		 		_cCNPJ:=''
		 		FRename("\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\"+lower(ALLTRIM(aXML[i])),"\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\"+lower(ALLTRIM(aXML[i]))+".imp")
		 		__CopyFile("\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\*.imp","\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\importados\")
		 		ferase("\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\"+lower(ALLTRIM(aXML[i]))+".imp")
		 		MsgAlert("A Nota Fiscal de NЗmero "+cNota+" jА encontra-se no sistema!")
		 	Endif
		 Endif
	   else 
		 DbSelectarea("SA1")
		 DbSetorder(3)
		 Dbgotop()
		 Dbseek(xFilial("SA1")+_cCNPJ)
		 If Found()
		 	dbSelectArea("SF1")
		 	DbSetorder(2)
		 	Dbgotop()
		 	Dbseek(xFilial("SF1")+SA1->A1_COD+SA1->A1_LOJA+alltrim(cNota)+Space(cSpaco))
		 	If Found() .and. SF1->F1_TIPO=="N"
		 		_cCNPJ:=''
		 		FRename("\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\"+lower(ALLTRIM(pARQ)),"\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\"+lower(ALLTRIM(pARQ))+".imp")
		 		__CopyFile("\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\*.imp","\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\importados\")
		 		ferase("\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\"+lower(SUBSTR(ALLTRIM(pARQ),1,LEN(pARQ)-4))+".imp")
		 		MsgAlert("A Nota Fiscal de NЗmero "+cNota+" jА encontra-se no sistema!")
		 	Endif
		 Endif
	   endif
	EndIf
Else
	FRename("\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\"+lower(ALLTRIM(aXML[i])),"\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\"+lower(ALLTRIM(aXML[i]))+".err")
	__CopyFile("\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\*.err","\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\corrompidos\")
	ferase("\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\"+lower(ALLTRIM(aXML[i]))+".err")
	MsgAlert("Arquivo "+aXML[1]+" InvАlido!")
Endif
Return

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//| Pre nota entrada											 |
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function PRENOTA()

Local aCabec := {}
Private aItens := {}
Private aLinha := {}

PRIVATE lMsErroAuto := .F.
cRet:=.F.
nOpc:=3


//////////////////////////////////
DbSelectarea("LS1")
DbSetorder(1)
Dbgotop()
While !Eof()
	_cPedido:=LS1->PEDIDO
	/*
	aLinha := {}
	aadd(aLinha,{"D1_COD" ,LS1->PRODUTO,Nil})
	aadd(aLinha,{"D1_QUANT",LS1->QUANTIDADE,Nil})
	aadd(aLinha,{"D1_PEDIDO",LS1->PEDIDO,Nil})
	aadd(aLinha,{"D1_ITEMPC",LS1->ITEM,Nil})
	aadd(aLinha,{"D1_VUNIT",LS1->PRECO,Nil})
	aadd(aLinha,{"D1_TOTAL",LS1->TOTAL,Nil})
	aadd(aLinha,{"D1_VALDESC",LS1->DESCONTO,Nil})
	aadd(aLinha,{"D1_LOCAL",LS1->ALMOX,Nil})
	aadd(aLinha,{"D1_LOTECTL",LS1->LOTECTL,Nil})
	aadd(aItens,aLinha)
	MsUnlock()*/
	DbSelectarea("LS1")
	Dbskip()
End

If !Empty(_cPedido) .and. cPedCom
	DbSelectarea("SC7")
	DbSetorder(1)
	Dbgotop()
	if Dbseek(xFilial("SC7")+_cPedido)
		_nMoeda   := SC7->C7_MOEDA       // adicionado por Valdemir Jose 20130612
		_nTxMoeda := SC7->C7_TXMOEDA	 // adicionado por Valdemir Jose 20130612
	endif
Endif

DbSelectarea("LS1")
dbgotop()
_dEmissao:=STOD(LS1->EMISSAO)

If cPedCom .and. lItem==.F.
	cQuere:=" UPDATE "+RetSqlName("SC7")+" SET C7_LOJA='"+LS3->LOJA+"' WHERE C7_FILIAL='"+xFilial("SC7")+"' AND C7_NUM='"+LS2->PEDIDO+"' AND D_E_L_E_T_<>'*' "
	TCSQLEXEC(cQuere)
Endif

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//| Grava status no fornecedor que manda o XML					 |
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
DbSelectarea("SA2")
DbSetorder(1)
Dbgotop()
Dbseek(xFilial("SA2")+LS3->FORNEC+LS3->LOJA)
If Found()
	Reclock("SA2",.F.)
	SA2->A2_STATUS := "1"
	MsUnlock()
Endif

//rafael 05-07
While !FS_INCLT()
	Msgbox("Obrigatorio informar os lotes dos itens.","AtenГЦo...","INFO")
End

aadd(aCabec,{"F1_TIPO"    ,"N"})
aadd(aCabec,{"F1_SERIE"   ,cSerie})
aadd(aCabec,{"F1_FORMUL"  ,"N"})
aadd(aCabec,{"F1_DOC"     ,(cNota)})
aadd(aCabec,{"F1_EMISSAO" ,_dEmissao})
aadd(aCabec,{"F1_FORNECE" ,LS3->FORNEC})
aadd(aCabec,{"F1_LOJA"    ,LS3->LOJA})
aadd(aCabec,{"F1_ESPECIE" ,IIF(lTipo == 4,"CTE",cEspecie)})
aadd(aCabec,{"F1_CHVNFE"  ,LS3->CHAVE})
aadd(aCabec,{"F1_HORA"    ,LEFT(TIME(),5)})
aadd(aCabec,{"F1_MOEDA"   ,_nMoeda})      // ADICIONADO POR VALDEMIR JOSE 12/06/2013
aadd(aCabec,{"F1_TXMOEDA" ,_nTxMoeda})    // ADICIONADO POR VALDEMIR JOSE 12/06/2013


//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Gerando NDF para o fornecedor do valor excedido						Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If cNDF .and. cPedCom
	_nExcedido:=VALORNDF()
	
	If _nExcedido>0
		MsgInfo("O valor da Nota Fiscal em comparaГЦo ao Pedido de Compra excedeu "+AllTrim(Str(_nExcedido))+" ","AtenГЦo")
		/*
		cResp:=msgbox("Deseja gerar a NDF para o fornecedor no valor de R$ "+Transform(_nExcedido,"@E 99,999.99"),"AtenГЦo...","YESNO")
		If cResp
		NDF()
		Msgbox("NDF "+cNota+" gerada com sucesso!","AtenГЦo...","INFO")
		Endif
		*/
	EndIf
Endif


DbSelectarea("SC7")
If Len(aCabec)>0 .and. Len(aItens)>0
	MATA140(aCabec,aItens)
	
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Calculando o total do item na nota									Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	//cQuere:=" UPDATE "+RetSqlName("SD1")+" SET D1_TOTAL=(D1_QUANT*D1_VUNIT) WHERE D1_FILIAL='"+xFilial("SD1")+"' AND D1_DOC='"+cNota+"' AND D1_FORNECE='"+LS3->FORNEC+"' AND D1_LOJA='"+LS3->LOJA+"' AND D1_SERIE='"+cSerie+"' "
	//TCSQLEXEC(cQuere)
Endif

If lMsErroAuto
	MostraErro()
Else
	cRet:=.T.
EndIf
Return(cRet)
                          



//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//| Alterar Pedido												 |
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function PEDIDOS()
return //rafael 05-07

If LS2->OK=="X"
	Msgbox("NЦo И necessАrio atualizar este pedido!","AtenГЦo...","ALERT")
	Return
Endif

cPedido:=LS2->PEDIDO
cLoja:=LS2->LOJA

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//| Verifica se algum pedido ainda nao foi usado				 |
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
DbSelectarea("LS2")
Dbgotop()
While !Eof()
	IF 	LS2->OK=="X"
		Msgbox("Favor usar o Pedido "+LS2->PEDIDO,"Sem necessidade...","INFO")
		DbSelectarea("LS2")
		Dbgotop()
		Return
	Endif
	Dbskip()
End

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Ajustando o pedido com a nota										Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
cResp:=msgbox("Deseja atualizar o pedido "+cPedido+" com os itens faltantes?","AtenГЦo...","YESNO")

If cResp
	
	lEntrou:=.F.
	_nQtdIt:=0
	
	Dbselectarea("PRO")
	DbSetorder(1)
	Dbgotop()
	While !Eof()
		DbSelectarea("SC7")
		DbSetorder(4)
		Dbgotop()
		Dbseek(xFilial("SC7")+PRO->PRODUTO+cPedido)
		If !Found()
			Dbselectarea("SB1")
			DbSetorder(1)
			Dbgotop()
			Dbseek(xFilial("SB1")+PRO->PRODUTO)
			
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//| Dados do pedido												 |
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			cQuery:=" SELECT C7_EMISSAO EMISSAO,C7_COND COND,MAX(C7_ITEM) ITEM FROM "+RetSqlName("SC7")+" WHERE C7_FILIAL='"+xFilial("SC7")+"' AND C7_NUM='"+cPedido+"' AND D_E_L_E_T_<>'*' GROUP BY C7_EMISSAO,C7_COND "
			TCQUERY cQuery NEW ALIAS "PED"
			DbSelectArea("PED")
			nItem:=strzero(val(PED->ITEM)+1,4)
			_cCond:=PED->COND
			_dEmiss:=STOD(PED->EMISSAO)
			DbCloseArea("PED")
			
			Reclock("SC7",.T.)
			SC7->C7_FILIAL	:=xFilial("SC7")
			SC7->C7_TIPO	:=1
			SC7->C7_NUM		:=cPedido
			SC7->C7_EMISSAO	:=_dEmiss
			SC7->C7_FORNECE	:=LS3->FORNEC
			SC7->C7_LOJA	:=cLoja
			SC7->C7_CONTATO	:=Posicione("SA2",1,xFilial("SA2")+LS3->FORNEC+cLoja,"A2_CONTATO")
			SC7->C7_COND	:=_cCond
			SC7->C7_FILENT	:=xFilial("SC7")
			SC7->C7_ITEM	:=nItem
			SC7->C7_PRODUTO	:=PRO->PRODUTO
			SC7->C7_UM		:=SB1->B1_UM
			SC7->C7_SEGUM	:=SB1->B1_SEGUM
			SC7->C7_DESCRI	:=SUBSTR(SB1->B1_DESC,1,30)
			SC7->C7_QUANT	:=PRO->QUANTIDADE
			SC7->C7_QTSEGUM	:=(PRO->QUANTIDADE/SB1->B1_QE)
			SC7->C7_PRECO	:=PRO->PRECO
			SC7->C7_TOTAL	:=(PRO->QUANTIDADE*PRO->PRECO)
			SC7->C7_DATPRF	:=_dEmiss
			SC7->C7_TES		:=SB1->B1_TE
			SC7->C7_IPIBRUT	:="B"
			SC7->C7_FLUXO	:="S"
			SC7->C7_USER	:=__CUSERID
			SC7->C7_TPOP:="F"
			SC7->C7_CONAPRO:="L"
			SC7->C7_MOEDA:=1
			SC7->C7_TPFRETE:="C"
			SC7->C7_OBS:="INCLUIDO NF-ELETRONICA"
			SC7->C7_PENDEN:="N"
			SC7->C7_POLREPR:="N"
			If Empty(cAlmoPed)
				SC7->C7_LOCAL:=Posicione("SB1",1,xFilial("SB1")+PRO->PRODUTO,"B1_LOCPAD")
			Else
				SC7->C7_LOCAL:=cAlmoPed
			Endif
			MsUnlock()
			_nQtdIt:=_nQtdIt+1
			
			If Empty(cAlmox)
				cAlmox:=Posicione("SB1",1,xFilial("SB1")+PRO->PRODUTO,"B1_LOCPAD")
			Endif
			
			//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Atualizado SB2 saldo de pedidos										Ё
			//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			DbSelectarea("SB2")
			DbSetorder(2)
			Dbgotop()
			Dbseek(xFilial("SB2")+cAlmox+PRO->PRODUTO)
			If Found()
				Reclock("SB2",.F.)
				SB2->B2_SALPEDI:=(SB2->B2_SALPEDI+PRO->QUANTIDADE)
				MsUnlock()
			Endif
			lEntrou:=.T.
		Else
			If (SC7->C7_QUANT-SC7->C7_QUJE-SC7->C7_QTDACLA)<PRO->QUANTIDADE
				_nTotal:=PRO->QUANTIDADE-(SC7->C7_QUANT-SC7->C7_QUJE-SC7->C7_QTDACLA)
				
				Reclock("SC7",.F.)
				SC7->C7_QUANT:=(SC7->C7_QUANT+_nTotal)
				SC7->C7_OBS:="ALTERADO NF-ELETRONICA"
				MsUnlock()
				
				Reclock("SC7",.F.)
				SC7->C7_TOTAL:=(SC7->C7_QUANT*SC7->C7_PRECO)
				MsUnlock()
				
				If Empty(cAlmox)
					cAlmox:=Posicione("SB1",1,xFilial("SB1")+PRO->PRODUTO,"B1_LOCPAD")
				Endif
				
				//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Atualizado SB2 saldo de pedidos										Ё
				//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				DbSelectarea("SB2")
				DbSetorder(2)
				Dbgotop()
				Dbseek(xFilial("SB2")+cAlmox+PRO->PRODUTO)
				If Found()
					Reclock("SB2",.F.)
					SB2->B2_SALPEDI:=(SB2->B2_SALPEDI+_nTotal)
					MsUnlock()
				Endif
				lEntrou:=.T.
			Endif
		Endif
		Dbselectarea("PRO")
		Dbskip()
	End
	
	If lEntrou
		Msgbox("Pedido atualizado com sucesso!","AtenГЦo...","INFO")
	Endif
	
	DbSelectarea("LS2")
	Dbgotop()
	While !Eof()
		IF LS2->PEDIDO==cPedido
			Reclock("LS2",.F.)
			LS2->VALIDO:=nTotIt
			LS2->OK:="X"
			LS2->QTDIT:=(LS2->QTDIT+_nQtdIt)
			LS2->ITENS:=(LS2->ITENS+_nQtdIt)
			Msunlock()
		Endif
		Dbskip()
	End
Endif
DbSelectarea("LS2")
Dbgotop()
Return

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//| Novo Pedido													 |
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function NEWPED()


Local aCab2 :={}
Local aItem2:={}
PRIVATE lMsErroAuto := .F.
lAchei:=.F.
nOpc:=3

//refael 05-07
if 1=1
	return
EndIF
_nItens:=0
_cCond:=POSICIONE("SA2",1,xFilial("SA2")+LS3->FORNEC+LS3->LOJA,"A2_COND")
If Empty(_cCond)
	_cCond:="001"
Endif

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Verificar Status da Gravacao										Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
_lGrava:=Getmv("MV_GRVPEDI")

If ! Empty(Alltrim(_lGrava))
	ALERT("Atencao!!!, O Usuario "+_lGrava+" Esta concretizando um Pedido de Compra, Aguarde...")
	Return
Else
	DbSelectArea("SX6")
	DbgoTop()
	While ! eof()
		If Alltrim(SX6->X6_VAR)=="MV_GRVPEDI" .and. SX6->X6_FIL==xFilial("SC7")
			RecLock("SX6",.F.)
			SX6->X6_CONTEUD:="NF-ELETRONICA-"+_cUsuario
			MsUnlock()
		Endif
		DbSkip()
	End
Endif

cQuery:=" SELECT MAX(C7_NUM)+1 PEDIDO FROM "+RetSqlName("SC7")+" WHERE C7_FILIAL='"+xFilial("SC7")+"' AND D_E_L_E_T_<>'*' "
TCQUERY cQuery NEW ALIAS "PED"
DbSelectArea("PED")
cNumPed:=STRZERO(PED->PEDIDO,6)
DbCloseArea("PED")

DbSelectarea("LS1")
Dbgotop()
While !Eof()
	
	If Empty(cAlmoPed)
		_cAlmoxPed:=Posicione("SB1",1,xFilial("SB1")+LS1->PRODUTO,"B1_LOCPAD")
	Else
		_cAlmoxPed:=cAlmoPed
	Endif
	
	aCab2:={{"C7_NUM",cNumPed,Nil},;
	{"C7_EMISSAO" ,dDataBase,Nil},;
	{"C7_FORNECE" ,LS3->FORNEC,Nil},;
	{"C7_LOJA"    ,LS3->LOJA,Nil},;
	{"C7_CONTATO" ,Posicione("SA2",1,xFilial("SA2")+LS3->FORNEC+LS3->LOJA,"A2_CONTATO"),Nil},;
	{"C7_COND"    ,_cCond,Nil},;
	{"C7_FILENT" ,xFilial("SC7"),Nil}}
	
	aItem3:={}
	aItem3:={{"C7_ITEM",Strzero(_nItens+1,4),Nil},;
	{"C7_PRODUTO",LS1->PRODUTO,Nil},;
	{"C7_QUANT" ,LS1->QUANTIDADE,Nil},;
	{"C7_PRECO" ,LS1->PRECO,Nil},;
	{"C7_TOTAL" ,LS1->TOTAL,Nil},;
	{"C7_DATPRF" ,dDataBase,Nil},;
	{"C7_TES"    ,POSICIONE("SB1",1,xFilial("SB1")+LS1->PRODUTO,"B1_TE"),Nil},;
	{"C7_FLUXO" ,"S",Nil},;
	{"C7_USER" ,__CUSERID,Nil},;
	{"C7_OBS"  ,"NF-ELETRONICA"			,Nil},;
	{"C7_LOCAL",_cAlmoxPed,Nil}}
	
	aadd(aItem2,aItem3)
	_nItens:=_nItens+1
	DbSelectarea("LS1")
	Dbskip()
End
DbSelectarea("SC7")
If Len(aItem2)>0 .and. Len(aCab2)>0
	MSExecAuto({|v,x,y,z| MATA120(v,x,y,z)},1,aCab2,aItem2,nOpc)
Endif

If lMsErroAuto
	mostraerro()
Else
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Liberando a Gravacao de um pedido para outro usuario				Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	DbSelectArea("SX6")
	DbgoTop()
	While ! eof()
		If Alltrim(SX6->X6_VAR)=="MV_GRVPEDI" .and. SX6->X6_FIL==xFilial("SC7")
			RecLock("SX6",.F.)
			SX6->X6_CONTEUD:=""
			MsUnlock()
		Endif
		DbSkip()
	End
	Msgbox("Pedido "+cNumped+" Gerado com sucesso!","AtenГЦo...","INFO")
EndIf
DbSelectarea("LS1")
Dbgotop()
Return

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//| Novo Pedido por item										 |
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function NEWPED2()
Local aCab2 :={}
Local aItem2:={}
PRIVATE lMsErroAuto := .F.
lAchei:=.F.
nOpc:=3
//refael 05-07
if 1=1
	return
EndIF
_nItens:=0
_cCond:=POSICIONE("SA2",1,xFilial("SA2")+LS3->FORNEC+LS3->LOJA,"A2_COND")
If Empty(_cCond)
	_cCond:="001"
Endif

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Verificar Status da Gravacao										Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
_lGrava:=Getmv("MV_GRVPEDI")

If ! Empty(Alltrim(_lGrava))
	ALERT("Atencao!!!, O Usuario "+_lGrava+" Esta concretizando um Pedido de Compra, Aguarde...")
	Return
Else
	DbSelectArea("SX6")
	DbgoTop()
	While ! eof()
		If Alltrim(SX6->X6_VAR)=="MV_GRVPEDI" .and. SX6->X6_FIL==xFilial("SC7")
			RecLock("SX6",.F.)
			SX6->X6_CONTEUD:="NF-ELETRONICA-"+_cUsuario
			MsUnlock()
		Endif
		DbSkip()
	End
Endif

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Numero do Pedido de compra											Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
cQuery:=" SELECT MAX(C7_NUM)+1 PEDIDO FROM "+RetSqlName("SC7")+" WHERE C7_FILIAL='"+xFilial("SC7")+"' AND D_E_L_E_T_<>'*' "
TCQUERY cQuery NEW ALIAS "PED"
DbSelectArea("PED")
cNumPed:=STRZERO(PED->PEDIDO,6)
DbCloseArea("PED")

DbSelectarea("LS1")
Dbgotop()
While !Eof()
	IF ALLTRIM(LS1->PEDIDO)=="CRIAR"
		
		If Empty(cAlmoPed)
			_cAlmoxPed:=Posicione("SB1",1,xFilial("SB1")+LS1->PRODUTO,"B1_LOCPAD")
		Else
			_cAlmoxPed:=cAlmoPed
		Endif
		
		aCab2:={{"C7_NUM",cNumPed,Nil},;
		{"C7_EMISSAO" ,dDataBase,Nil},;
		{"C7_FORNECE" ,LS3->FORNEC,Nil},;
		{"C7_LOJA"    ,LS3->LOJA,Nil},;
		{"C7_CONTATO" ,Posicione("SA2",1,xFilial("SA2")+LS3->FORNEC+LS3->LOJA,"A2_CONTATO"),Nil},;
		{"C7_COND"    ,_cCond,Nil},;
		{"C7_FILENT" ,xFilial("SC7"),Nil}}
		
		aItem3:={}
		aItem3:={{"C7_ITEM",Strzero(_nItens+1,4),Nil},;
		{"C7_PRODUTO",LS1->PRODUTO,Nil},;
		{"C7_QUANT" ,LS1->QUANTIDADE,Nil},;
		{"C7_PRECO" ,LS1->PRECO,Nil},;
		{"C7_TOTAL" ,LS1->TOTAL,Nil},;
		{"C7_DATPRF" ,dDataBase,Nil},;
		{"C7_TES"    ,POSICIONE("SB1",1,xFilial("SB1")+LS1->PRODUTO,"B1_TE"),Nil},;
		{"C7_FLUXO" ,"S",Nil},;
		{"C7_USER" ,__CUSERID,Nil},;
		{"C7_OBS"  ,"NF-ELETRONICA"			,Nil},;
		{"C7_LOCAL",_cAlmoxPed,Nil}}
		aadd(aItem2,aItem3)
		
		Reclock("LS1",.F.)
		LS1->PEDIDO:=cNumPed
		LS1->ITEM:=Strzero(_nItens+1,4)
		
		_nItens:=_nItens+1
		MsUnlock()
	Endif
	DbSelectarea("LS1")
	Dbskip()
End
DbSelectarea("SC7")
If Len(aItem2)>0 .and. Len(aCab2)>0
	MSExecAuto({|v,x,y,z| MATA120(v,x,y,z)},1,aCab2,aItem2,nOpc)
Endif

If lMsErroAuto
	mostraerro()
Else
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Liberando a Gravacao de um pedido para outro usuario				Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	DbSelectArea("SX6")
	DbgoTop()
	While ! eof()
		If Alltrim(SX6->X6_VAR)=="MV_GRVPEDI" .and. SX6->X6_FIL==xFilial("SC7")
			RecLock("SX6",.F.)
			SX6->X6_CONTEUD:=""
			MsUnlock()
		Endif
		DbSkip()
	End
	Msgbox("Pedido "+cNumped+" Gerado com sucesso!","AtenГЦo...","INFO")
EndIf
DbSelectarea("LS1")
Dbgotop()
Return
        




//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Processando arquivo													Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function PROCESS()

private _oXml    := NIL
private cError    := ''
private cWarning := ''     
     
If LS3->(eof())
	//msgbox("NЦo existem notas fiscais eletrТnicas para serem importadas!")
	OBRWI:obrowse:refresh()
	OBRWP:obrowse:refresh()
	OBRWI:obrowse:setfocus()
	OBRWP:obrowse:setfocus()
	ObjectMethod(oTela,"Refresh()")
	Return
Endif

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Verifico se existe a nota fiscal									Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
IF !file(cCamSel+"\"+lower(LS3->XML))
	msgbox("Este arquivo jА foi processado por outro usuАrio!","AtenГЦo...","ALERT")
	Reclock("LS3",.F.)
	dbdelete()
	MsUnlock()
	
	DbSelectarea("LS3")
	Dbgotop()
	PROCESS()
	Return
Endif

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Verifico se foi alterado algum item									Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
lAltera:=.F.
DbSelectarea("LS1")
Dbgotop()
While !Eof()
	IF LS1->ALTERADO=="S"
		_cChave:=LS1->NOME+LS1->NOTA
		lAltera:=.T.
	Endif
	Dbskip()
End

IF lAltera
   //	cResp:=msgbox("Deseja perder todas as alteraГУes realizadas?","AtenГЦo...","YESNO")
   	cResp := .T.
	
	If cResp==.F.
		DbSelectarea("LS3")
		Dbsetorder(1)
		dbgotop()
		Dbseek(_cChave)
		
		DbSelectarea("LS1")
		Dbgotop()
		OBRWI:obrowse:refresh()
		OBRWP:obrowse:refresh()
		OBRWI:obrowse:setfocus()
		OBRWP:obrowse:setfocus()
		ObjectMethod(oTela,"Refresh()")
		Return
	Endif
Endif

nXmlStatus  := XMLError()
cFile		:= cCamSel+"\"+lower(ALLTRIM(LS3->XML))

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Apagando dados da tabela temporaria									Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
DbSelectarea("LS1")
Dbsetorder(1)
Dbgotop()
While !Eof()
	Reclock("LS1",.F.)
	dbdelete()
	MsUnlock()
	Dbskip()
End

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Apagando produtos temporarios										Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
DbSelectarea("LS5")
Dbsetorder(1)
Dbgotop()
While !Eof()
	Reclock("LS5",.F.)
	dbdelete()
	MsUnlock()
	Dbskip()
End

oXml := XmlParserFile(cFile,"_",@cError, @cWarning )
aCols:={}
nTotIt:=0
nTotalNF:=0

IF ALLTRIM(TYPE("oxml:_NFE:_INFNFE"))=="O"
	lTipo:=1
ElseIf AllTrim(Type("oXml:_CTEPROC:_CTE:_INFCTE")) == "O"
	lTipo := 4
Else
	lTipo:=2
Endif

nDescont := 0

If ( nXmlStatus == XERROR_SUCCESS )
	
	If lTipo == 1
		aCols := Clone(oXml:_NFE:_INFNFE:_DET)
	ElseIf lTipo==2
		aCols := aClone(oXml:_NFEPROC:_NFE:_INFNFE:_DET)
	EndIf
	
	If aCols==NIL .Or. Len(aCols) == 0
		nItens := 1
	Else
		nItens := len(aCols)
	Endif
	
	For i:=1 to nItens
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Com _NFEPROC														Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If lTipo==2
			
			If ALLTRIM(TYPE("oxml:_NFEPROC:_NFE:_INFNFE:_INFADIC:_INFCPL:TEXT"))=="C"
				_cMensag:=alltrim(oxml:_NFEPROC:_NFE:_INFNFE:_INFADIC:_INFCPL:TEXT)
			Endif
			
			If nItens>1
				cCodbar := oxml:_NFEPROC:_NFE:_INFNFE:_DET[i]:_PROD:_CEAN:TEXT
				cProdFor:= oxml:_NFEPROC:_NFE:_INFNFE:_DET[i]:_PROD:_CPROD:TEXT
				nQuant	:= val(oxml:_NFEPROC:_NFE:_INFNFE:_DET[i]:_PROD:_QCOM:TEXT)
				xDesc	:= oxml:_NFEPROC:_NFE:_INFNFE:_DET[i]:_PROD:_XPROD:TEXT
				nPreco	:= val(oxml:_NFEPROC:_NFE:_INFNFE:_DET[i]:_PROD:_VUNCOM:TEXT)
				If ALLTRIM(TYPE("oxml:_NFEPROC:_NFE:_INFNFE:_DET[i]:_PROD:_VDESC:TEXT"))=="C"
					nDescont := val(oxml:_NFEPROC:_NFE:_INFNFE:_DET[i]:_PROD:_VDESC:TEXT)
				Endif
				nTotal	:= val(oxml:_NFEPROC:_NFE:_INFNFE:_DET[i]:_PROD:_VPROD:TEXT)
				cNota	:= oxml:_NFEPROC:_NFE:_INFNFE:_IDE:_NNF:TEXT
				If Empty(cSerieNF)
					cSerie  :=oxml:_NFEPROC:_NFE:_INFNFE:_IDE:_SERIE:TEXT
				Endif
				cNatOp  := oxml:_NFEPROC:_NFE:_INFNFE:_IDE:_NATOP:TEXT
				cUM		:= oxml:_NFEPROC:_NFE:_INFNFE:_DET[i]:_PROD:_UCOM:TEXT
				cEmissao:= oxml:_NFEPROC:_NFE:_INFNFE:_IDE:_DEMI:TEXT
				If SUBSTR(alltrim(oxml:_NFEPROC:_NFE:_INFNFE:_DEST:_IE:TEXT),1,1) $ "0/1/2/3/4/5/6/7/8/9"
					_cCNPJ	:=alltrim(oxml:_NFEPROC:_NFE:_INFNFE:_DEST:_CNPJ:TEXT)
					_cEmpresa:=alltrim(oxml:_NFEPROC:_NFE:_INFNFE:_DEST:_CNPJ:TEXT)
				Else
					_cCNPJ	  := alltrim(oxml:_NFEPROC:_NFE:_INFNFE:_DEST:_CPF:TEXT)
					_cEmpresa := alltrim(oxml:_NFEPROC:_NFE:_INFNFE:_DEST:_CPF:TEXT)
				Endif
				cEmissao	:= SUBSTR(cEmissao,1,4)+SUBSTR(cEmissao,6,2)+SUBSTR(cEmissao,9,2)
				cProd		:= ''
			Else
				cCodbar := oxml:_NFEPROC:_NFE:_INFNFE:_DET:_PROD:_CEAN:TEXT
				cProdFor:= oxml:_NFEPROC:_NFE:_INFNFE:_DET:_PROD:_CPROD:TEXT
				nQuant	:= val(oxml:_NFEPROC:_NFE:_INFNFE:_DET:_PROD:_QCOM:TEXT)
				If ALLTRIM(TYPE("oxml:_NFEPROC:_NFE:_INFNFE:_DET:_PROD:_VDESC:TEXT"))=="C"
					nDescont := val(oxml:_NFEPROC:_NFE:_INFNFE:_DET:_PROD:_VDESC:TEXT)
				Endif
				xDesc	:= oxml:_NFEPROC:_NFE:_INFNFE:_DET:_PROD:_XPROD:TEXT
				nPreco	:= val(oxml:_NFEPROC:_NFE:_INFNFE:_DET:_PROD:_VUNCOM:TEXT)
				nTotal	:= val(oxml:_NFEPROC:_NFE:_INFNFE:_DET:_PROD:_VPROD:TEXT)
				cNota	:= oxml:_NFEPROC:_NFE:_INFNFE:_IDE:_NNF:TEXT
				If Empty(cSerieNF)
					cSerie  :=oxml:_NFEPROC:_NFE:_INFNFE:_IDE:_SERIE:TEXT
				Endif
				cNatOP	:= oxml:_NFEPROC:_NFE:_INFNFE:_IDE:_NATOP:TEXT
				cEmissao:= oxml:_NFEPROC:_NFE:_INFNFE:_IDE:_DEMI:TEXT
				cUM		:= oxml:_NFEPROC:_NFE:_INFNFE:_DET:_PROD:_UCOM:TEXT
				If SUBSTR(alltrim(oxml:_NFEPROC:_NFE:_INFNFE:_DEST:_IE:TEXT),1,1) $ "0/1/2/3/4/5/6/7/8/9"
					_cCNPJ	 :=alltrim(oxml:_NFEPROC:_NFE:_INFNFE:_DEST:_CNPJ:TEXT)
					_cEmpresa:=alltrim(oxml:_NFEPROC:_NFE:_INFNFE:_DEST:_CNPJ:TEXT)
				Else
					_cCNPJ	 :=alltrim(oxml:_NFEPROC:_NFE:_INFNFE:_DEST:_CPF:TEXT)
					_cEmpresa:=alltrim(oxml:_NFEPROC:_NFE:_INFNFE:_DEST:_CPF:TEXT)
				Endif
				cEmissao :=SUBSTR(cEmissao,1,4)+SUBSTR(cEmissao,6,2)+SUBSTR(cEmissao,9,2)
				cProd    :=''
			Endif
		ElseIf lTipo == 1
			//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Sem _NFEPROC														Ё
			//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			If ALLTRIM(TYPE("oxml:_NFE:_INFNFE:_INFADIC:_INFCPL:TEXT"))=="C"
				_cMensag := alltrim(oxml:_NFE:_INFNFE:_INFADIC:_INFCPL:TEXT)
			Endif
			
			If nItens>1
				cCodbar := oxml:_NFE:_INFNFE:_DET[i]:_PROD:_CEAN:TEXT
				cProdFor:= oxml:_NFE:_INFNFE:_DET[i]:_PROD:_CPROD:TEXT
				nQuant	:= val(oxml:_NFE:_INFNFE:_DET[i]:_PROD:_QCOM:TEXT)
				xDesc	:= oxml:_NFE:_INFNFE:_DET[i]:_PROD:_XPROD:TEXT
				cUM		:= oxml:_NFE:_INFNFE:_DET[i]:_PROD:_UCOM:TEXT
				If ALLTRIM(TYPE("oxml:_NFE:_INFNFE:_DET[i]:_PROD:_VDESC:TEXT"))=="C"
					nDescont:=val(oxml:_NFE:_INFNFE:_DET[i]:_PROD:_VDESC:TEXT)
				Endif
				nPreco	:= val(oxml:_NFE:_INFNFE:_DET[i]:_PROD:_VUNCOM:TEXT)
				nTotal	:= val(oxml:_NFE:_INFNFE:_DET[i]:_PROD:_VPROD:TEXT)
				cNota	:= oxml:_NFE:_INFNFE:_IDE:_NNF:TEXT
				If Empty(cSerieNF)
					cSerie  :=oxml:_NFE:_INFNFE:_IDE:_SERIE:TEXT
				Endif
				cNatOP	:= oxml:_NFE:_INFNFE:_IDE:_NATOP:TEXT
				cEmissao:= oxml:_NFE:_INFNFE:_IDE:_DEMI:TEXT
				If SUBSTR(alltrim(oxml:_NFE:_INFNFE:_DEST:_IE:TEXT),1,1) $ "0/1/2/3/4/5/6/7/8/9"
					_cCNPJ	 :=alltrim(oxml:_NFE:_INFNFE:_DEST:_CNPJ:TEXT)
					_cEmpresa:=alltrim(oxml:_NFE:_INFNFE:_DEST:_CNPJ:TEXT)
				Else
					_cCNPJ	 :=alltrim(oxml:_NFE:_INFNFE:_DEST:_CPF:TEXT)
					_cEmpresa:=alltrim(oxml:_NFE:_INFNFE:_DEST:_CPF:TEXT)
				Endif
				cEmissao :=SUBSTR(cEmissao,1,4)+SUBSTR(cEmissao,6,2)+SUBSTR(cEmissao,9,2)
				cProd    :=''
			Else
				cCodbar := oxml:_NFE:_INFNFE:_DET:_PROD:_CEAN:TEXT
				cProdFor:= oxml:_NFE:_INFNFE:_DET:_PROD:_CPROD:TEXT
				nQuant	:= val(oxml:_NFE:_INFNFE:_DET:_PROD:_QCOM:TEXT)
				xDesc	:= oxml:_NFE:_INFNFE:_DET:_PROD:_XPROD:TEXT
				If ALLTRIM(TYPE("oxml:_NFE:_INFNFE:_DET:_PROD:_VDESC:TEXT"))=="C"
					nDescont := val(oxml:_NFE:_INFNFE:_DET:_PROD:_VDESC:TEXT)
				Endif
				cUM		:= oxml:_NFE:_INFNFE:_DET:_PROD:_UCOM:TEXT
				nPreco	:= val(oxml:_NFE:_INFNFE:_DET:_PROD:_VUNCOM:TEXT)
				nTotal	:= val(oxml:_NFE:_INFNFE:_DET:_PROD:_VPROD:TEXT)
				cNota	:= oxml:_NFE:_INFNFE:_IDE:_NNF:TEXT
				If Empty(cSerieNF)
					cSerie  := oxml:_NFE:_INFNFE:_IDE:_SERIE:TEXT
				Endif
				cNatOP	:= oxml:_NFE:_INFNFE:_IDE:_NATOP:TEXT
				cEmissao:= oxml:_NFE:_INFNFE:_IDE:_DEMI:TEXT
				If SUBSTR(alltrim(oxml:_NFE:_INFNFE:_DEST:_IE:TEXT),1,1) $ "0/1/2/3/4/5/6/7/8/9"
					_cCNPJ	 := alltrim(oxml:_NFE:_INFNFE:_DEST:_CNPJ:TEXT)
					_cEmpresa:= alltrim(oxml:_NFE:_INFNFE:_DEST:_CNPJ:TEXT)
				Else
					_cCNPJ	 := alltrim(oxml:_NFE:_INFNFE:_DEST:_CPF:TEXT)
					_cEmpresa:= alltrim(oxml:_NFE:_INFNFE:_DEST:_CPF:TEXT)
				Endif
				cEmissao := SUBSTR(cEmissao,1,4)+SUBSTR(cEmissao,6,2)+SUBSTR(cEmissao,9,2)
				cProd    :=''
			Endif
		ElseIf lTipo == 4
			//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё CTE Com _NFEPROC													Ё
			//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			//If ALLTRIM(TYPE("oxml:_NFEPROC:_NFE:_INFNFE:_INFADIC:_INFCPL:TEXT"))=="C"
			//	_cMensag:=alltrim(oxml:_NFEPROC:_NFE:_INFNFE:_INFADIC:_INFCPL:TEXT)
			//Endif
			cCodbar := ''//oxml:_NFEPROC:_NFE:_INFNFE:_DET:_PROD:_CEAN:TEXT
			cProdFor:= ''//oxml:_NFEPROC:_NFE:_INFNFE:_DET:_PROD:_CPROD:TEXT
			nQuant	:= 1//val(oxml:_NFEPROC:_NFE:_INFNFE:_DET:_PROD:_QCOM:TEXT)
			//	If ALLTRIM(TYPE("oxml:_NFEPROC:_NFE:_INFNFE:_DET:_PROD:_VDESC:TEXT"))=="C"
			nDescont:= 0 //val(oxml:_NFEPROC:_NFE:_INFNFE:_DET:_PROD:_VDESC:TEXT)
			//Endif
			xDesc	:= oxml:_CTEPROC:_CTE:_INFCTE:_VPREST:_COMP:_XNOME:TEXT
			nPreco	:= Val(oxml:_CTEPROC:_CTE:_INFCTE:_VPREST:_VTPREST:TEXT)
			nTotal	:= Val(oxml:_CTEPROC:_CTE:_INFCTE:_VPREST:_VTPREST:TEXT)
			cNota	:=  oxml:_CTEPROC:_CTE:_INFCTE:_IDE:_NCT:TEXT
			If Empty(cSerieNF)
				cSerie  :=oxml:_CTEPROC:_CTE:_INFCTE:_IDE:_SERIE:TEXT
			Endif
			cNatOP	:= oxml:_CTEPROC:_CTE:_INFCTE:_IDE:_NATOP:TEXT
			cEmissao:= oXml:_CTEPROC:_CTE:_INFCTE:_IDE:_DHEMI:TEXT
			cUM		:= 'UN'
			_cCNPJ	:= Alltrim(oXml:_CTEPROC:_CTE:_INFCTE:_EMIT:_CNPJ:TEXT)//alltrim(oxml:_NFEPROC:_NFE:_INFNFE:_DEST:_CNPJ:TEXT)
			
			//_cEmpresa:=Alltrim(oXml:_CTEPROC:_CTE:_INFCTE:_DEST:_CNPJ:TEXT) //#ECV20130104.o
			
			//#ECV20130104.bn
			If AllTrim(Type("oXml:_CTEPROC:_CTE:_INFCTE:_DEST:_CPF")) == "O" //Caso a TAG de CPF exista
				_cCNPJ := AllTrim(oXml:_CTEPROC:_CTE:_INFCTE:_DEST:_CPF:TEXT)
			
			ElseIf AllTrim(Type("oXml:_CTEPROC:_CTE:_INFCTE:_DEST:_CNPJ")) == "O" //Caso a TAG de CNPJ exista 	
				_cCNPJ := AllTrim(oXml:_CTEPROC:_CTE:_INFCTE:_DEST:_CNPJ:TEXT)
			
			EndIf
			//#ECV20130104.en
			
			cEmissao := SUBSTR(cEmissao,1,4)+SUBSTR(cEmissao,6,2)+SUBSTR(cEmissao,9,2)
			cProd    :=''
		Endif
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё codigo barras														Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If !Empty(cCodbar) .and. SUBSTR(cCodbar,1,8)<>"00000000"
			DbSelectarea("SB1")
			DbSetorder(5)
			Dbgotop()
			Dbseek(xFilial("SB1")+cCodbar,.t.)
			If Found() .and. SB1->B1_MSBLQL<>"1"
				cProd:=SB1->B1_COD
			Endif
			
			If Empty(cProd)
				DbSelectarea("SLK")
				DbSetorder(1)
				Dbgotop()
				Dbseek(xFilial("SLK")+cCodbar,.t.)
				If Found()
					cProd:=SLK->LK_CODIGO
					
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//Ё Verifico se esta bloqueado											Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					DbSelectarea("SB1")
					DbSetorder(1)
					Dbgotop()
					Dbseek(xFilial("SB1")+cProd,.t.)
					If Found() .and. SB1->B1_MSBLQL=="1"
						cProd:=''
					Endif
				Endif
			Endif
		Endif
		
		If len(alltrim(cProdfor))<=5
			cProdFor:=strzero(val(cProdfor),6)
		Endif
		
		If len(alltrim(cProdfor))>15
			cProdFor:=SUBSTR(cProdFor,1,15)
		Endif
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Amarracao produto x fornecedor										Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If Empty(cCodbar) .or. Empty(cProd)
			DbSelectarea("SA5")
			DbSetorder(13)
			Dbgotop()
			Dbseek(xFilial("SA5")+cProdFor)
			While !Eof() .AND. ALLTRIM(SA5->A5_CODPRF)==ALLTRIM(cProdFor)
				IF SA5->A5_FORNECE==LS3->FORNEC .AND. SA5->A5_LOJA==LS3->LOJA
					cProd:=SA5->A5_PRODUTO
					
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//Ё Verifico se esta bloqueado											Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					DbSelectarea("SB1")
					DbSetorder(1)
					Dbgotop()
					Dbseek(xFilial("SB1")+cProd,.t.)
					If Found() .and. SB1->B1_MSBLQL=="1"
						cProd:=''
					Endif
					If !Empty(cProd)
						If Empty(cCodbar)
							cCodbar:=POSICIONE("SB1",1,xFilial("SB1")+cProd,"B1_CODBAR")
						Endif
					Endif
				Endif
				DbSelectarea("SA5")
				Dbskip()
			End
		Endif
		
		_nQE:=IIF(lTipo == 4,0,1)
		
		If Empty(cProd) .or. Empty(cCodbar)
			cProd:="999999"
			_cDescricao:=xDesc
		Else
			_cDescricao:=POSICIONE("SB1",1,xFilial("SB1")+cProd,"B1_DESC")
			_nQE:=POSICIONE("SB1",1,xFilial("SB1")+cProd,"B1_QE")
		Endif
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Unidade de medidas unitarias										Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		IF cUM $ cUnidades .And. lTipo <> 4
			_nQE:=1
		Endif
		
		If alltrim(cProd)<>"999999"
			DbSelectarea("LS5")
			DbSetorder(1)
			Dbgotop()
			Dbseek(cProd)
			if !Found()
				Reclock("LS5",.T.)
				LS5->PRODUTO:=cProd
				MsUnlock()
			Endif
		Endif
		
		IF alltrim(cProd)<>"999999"
			_nCusto:=ULTPED(cProd)
		Else
			_nCusto:=0
		Endif
		If lTipo == 4
			_nPreco:=nTotal
		Else
			_nPreco:=((nTotal-nDescont)/(nQuant*_nQE))
		EndIf
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Gravando produtos do XML											Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		Reclock("LS1",.T.)
		LS1->SEQ	:=nTotIt
		LS1->CODBAR :=cCodbar
		LS1->PRODUTO:=cProd
		LS1->PRODFOR:=cProdFor
		LS1->DESCRICAO	:=_cDescricao
		LS1->DESCORI	:=_cDescricao
		LS1->QUANTIDADE :=IIF(lTipo==4,nQuant,(nQuant*_nQE))
		LS1->PRECO		:=_nPreco
		//LS1->CUSTO:=_nCusto
		LS1->PRECOFOR	:=IIF(lTipo==4,nTotal,(nTotal/(nQuant*_nQE)))
		LS1->TOTAL		:=(nTotal-nDescont)
		IF alltrim(cProd)=="999999"
			LS1->OK	:="X"
			///	Else
			///	IF (_nPreco-_nCusto)>=1 .or. (_nCusto-_nPreco)>=1
			///	LS1->OK:="O"
			///	Endif
		Endif
		LS1->EMISSAO :=cEmissao
		LS1->ALTERADO:="N"
		LS1->DESCONTO:=nDescont
		LS1->UMXML   := cUM
	   	LS1->UM      :=LS1->UMXML	   	
		LS1->NOTA    :=LS3->NOTA
		LS1->NOME    :=LS3->NOME
		LS1->QE      :=_nQE
	   //	LS1->CAIXAS:=IIF(lTipo ==4,0,nQuant)
		LS1->LOTEFOR := space(len(SD1->D1_LOTEFOR))
		LS1->LOTECTL := space(len(SD1->D1_LOTECTL))
		MsUnlock()
		nTotIt   :=nTotIt+1
		nTotalNF :=nTotalNF+(nTotal-nDescont)
	Next
Else
	Msgbox("Problema ao abrir o arquivo!","AtenГЦo...","ALERT")
Endif

If nTotalNF==0
	Msgbox("Problema ao abrir o arquivo!","AtenГЦo...","ALERT")
Endif

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Fornecedor															Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
DbSelectarea("SA2")
DbSetorder(1)
Dbgotop()
Dbseek(xFilial("SA2")+LS3->FORNEC+LS3->LOJA)
If Found()
	_cFornecedor := SUBSTR(SA2->A2_NREDUZ,1,25)
	_cEnd		 := ALLTRIM(SA2->A2_END)+" - "+SA2->A2_BAIRRO
	_cCidade	 := ALLTRIM(SA2->A2_MUN)+"/"+SA2->A2_EST
	_cEmissao	 := dtoc(stod(LS1->EMISSAO))
	_cCNPJ		 := SA2->A2_CGC
	_cTelefone	 := SA2->A2_TEL
Endif

If len(alltrim(cNota))<=5
	cNota:=strzero(val(cNota),6)
Endif
If cZeros
	cNota:=strzero(val(cNota),9)
Endif

DbSelectarea("LS3")
DbSelectarea("LS1")
Dbsetorder(1)
Dbgotop()
OBRWI:obrowse:refresh()
OBRWP:obrowse:refresh()
OBRWI:obrowse:setfocus()
OBRWP:obrowse:setfocus()
ObjectMethod(oTela,"Refresh()")
Return

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Fornecedor															Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function ABREPED()
DbSelectarea("SC7")
SET FILTER TO C7_NUM==LS2->PEDIDO
MATA121()
Return

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Confirma produto													Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function RECUSAR()

cResp:=msgbox("Deseja recusar o recebimento da nota fiscal "+cNota+" ?","AtenГЦo...","YESNO")

If cResp
	
	_cSenha:=Space(06)
	
	@ 0,0 TO 100,235 DIALOG oSenha TITLE "Informe a Senha para acesso..."
	@ 10,10 SAY "Senha "  FONT oFont1 OF oSenha PIXEL
	@ 10,40 Get _cSenha Picture "@!" Size 20,20  Valid .T.  PASSWORD
	@ 30,40 BUTTON "Confirma" SIZE 35,12 ACTION Close(oSenha)
	ACTIVATE DIALOG oSenha CENTER
	
	If Empty(_cSenha)
		Return
	Endif
	
	If ALLTRIM(_cSenha)<>SUBSTR(DTOC(M->DDATABASE),1,2)+SUBSTR(DTOC(M->DDATABASE),4,2)+SUBSTR(DTOC(M->DDATABASE),7,2)
		Msgbox("Senha invАlida!")
		Return
	Endif
	
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Se foi cadastrado os email de recusa 								Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If !Empty(xEMAILREC)
		cResp:=msgbox("Deseja enviar um email para ficar documentado esta recusa?","AtenГЦo...","YESNO")
		
		If cResp
			EMAIL()
		Endif
	Endif
	
	FRename("\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\"+ALLTRIM(LS3->XML),"\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\"+ALLTRIM(LS3->XML)+".rec")
	__CopyFile("\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\*.rec","\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\recusadas\")
	ferase("\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\"+ALLTRIM(LS3->XML)+".rec")
	Msgbox("Nota Fiscal recusada com sucesso!","AtenГЦo...","INFO")
	
	Reclock("LS3",.F.)
	dbdelete()
	MsUnlock()
	
	DbSelectarea("LS3")
	Dbgotop()
	
	DbSelectarea("LS1")
	Dbsetorder(1)
	Dbgotop()
	While !Eof()
		Reclock("LS1",.F.)
		dbdelete()
		MsUnlock()
		Dbskip()
	End
	
	DbSelectarea("LS5")
	Dbsetorder(1)
	Dbgotop()
	While !Eof()
		Reclock("LS5",.F.)
		dbdelete()
		MsUnlock()
		Dbskip()
	End
	
	PROCESS()
Endif
Return

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Divergencias														Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function DIVERG()

aCampos4:= {{"FLAG","C",1,0 },;
{"OK","C",15,0 },;
{"PRODUTO","C",15,0 },;
{"DESCRICAO","C",50,0 },;
{"PRCPED","N",9,2 },;
{"PRCNFE","N",9,2 },;
{"QTDPED","N",9,2 },;
{"QTDNFE","N",9,2 }}

cArqTrab4  := CriaTrab(aCampos4)
dbUseArea( .T.,, cArqTrab4, "LS4", if(.F. .OR. .F., !.F., NIL), .F. )
IndRegua("LS4",cArqTrab4,"DESCRICAO",,,)
dbSetIndex( cArqTrab4 +OrdBagExt())
dbSelectArea("LS4")
_nMaior:=0

Dbselectarea("PRO")
DbSetorder(1)
Dbgotop()
While !Eof()
	
	cQuery:=" SELECT COUNT(*) QTD,Case C7_MOEDA When 1 Then AVG(C7_PRECO) When 2 Then AVG(C7_PRECO) * C7_TXMOEDA End As PRECO,SUM(C7_QUANT-C7_QUJE-C7_QTDACLA) QUANT FROM "+RetSqlName("SC7")+" WHERE C7_FILIAL='"+xFilial("SC7")+"' "
	If lItem==.F.
		cQuery:=cQuery + " AND C7_NUM='"+LS2->PEDIDO+"' "
	Else
		cQuery:=cQuery + " AND C7_NUM='"+PRO->PEDIDO+"' "
		cQuery:=cQuery + " AND C7_ITEM='"+PRO->ITEM+"' "
	Endif
	cQuery:=cQuery + " AND C7_PRODUTO='"+PRO->PRODUTO+"' "
	If lItem
	Endif
	cQuery:=cQuery + " AND C7_RESIDUO<>'S' "
	cQuery:=cQuery + " AND D_E_L_E_T_<>'*' Group By  C7_MOEDA, C7_TXMOEDA "
	TCQUERY cQuery NEW ALIAS "TCQ"
	DbSelectarea("TCQ")
	While !Eof()
		IF TCQ->QTD==0
			Reclock("LS4",.T.)
			LS4->PRODUTO:=PRO->PRODUTO
			LS4->DESCRICAO:=PRO->DESCRICAO
			LS4->PRCNFE:=round(PRO->PRECO,2)
			LS4->OK:="Nao Existe"
			MsUnlock()
			DbSelectarea("TCQ")
			Dbskip()
			Loop
		Endif
		
		If (TCQ->QUANT < PRO->QUANTIDADE .AND. TCQ->QUANT > 0)
			Reclock("LS4",.T.)
			LS4->PRODUTO:=PRO->PRODUTO
			LS4->DESCRICAO:=PRO->DESCRICAO
			LS4->QTDPED:=TCQ->QUANT
			LS4->QTDNFE:=PRO->QUANTIDADE
			LS4->PRCPED:=round(TCQ->PRECO,2)
			LS4->PRCNFE:=round(PRO->PRECO,2)
			LS4->OK:="Quantidade"
			MsUnlock()
			If (round(PRO->PRECO,2)>round(TCQ->PRECO,2)) .AND. round(TCQ->PRECO,2)>0
				_nMaior:=_nMaior+(PRO->QUANTIDADE*(round(PRO->PRECO,2)-round(TCQ->PRECO,2)))
			Endif
			DbSelectarea("TCQ")
			DbSkip()
			Loop
		Endif
		If (round(PRO->PRECO,2) > round(TCQ->PRECO,2)) .AND. round(TCQ->PRECO,2) > 0 .AND. TCQ->QUANT > 0
			Reclock("LS4",.T.)
			LS4->PRODUTO:=PRO->PRODUTO
			LS4->DESCRICAO:=PRO->DESCRICAO
			LS4->PRCPED:=round(TCQ->PRECO,2)
			LS4->PRCNFE:=round(PRO->PRECO,2)
			LS4->QTDPED:=TCQ->QUANT
			LS4->QTDNFE:=PRO->QUANTIDADE
			LS4->OK:="Preco"
			MsUnlock()
			_nMaior:=_nMaior+(PRO->QUANTIDADE*(round(PRO->PRECO,2)-round(TCQ->PRECO,2)))
			DbSelectarea("TCQ")
			DbSkip()
			Loop
		Endif
		
		Reclock("LS4",.T.)
		LS4->PRODUTO:=PRO->PRODUTO
		LS4->DESCRICAO:=PRO->DESCRICAO
		LS4->PRCPED:=round(TCQ->PRECO,2)
		LS4->PRCNFE:=round(PRO->PRECO,2)
		LS4->QTDPED:=TCQ->QUANT
		LS4->QTDNFE:=PRO->QUANTIDADE
		If TCQ->QUANT>=PRO->QUANTIDADE
			LS4->FLAG:="X"
			LS4->OK:="Produto OK!"
		Else
			LS4->OK:="Sem saldo!"
		Endif
		MsUnlock()
		DbSelectarea("TCQ")
		Dbskip()
	End
	DbClosearea("TCQ")
	Dbselectarea("PRO")
	Dbskip()
End

DbSelectarea("LS4")
Dbgotop()

aTitulo4 := {}
AADD(aTitulo4,{"OK","DivergЙncia"})
AADD(aTitulo4,{"PRODUTO","Produto"})
AADD(aTitulo4,{"DESCRICAO","DescriГЦo"})
AADD(aTitulo4,{"PRCPED","R$ Pedido","@E 99,999.99"})
AADD(aTitulo4,{"PRCNFE","R$ Nota","@E 99,999.99"})
AADD(aTitulo4,{"QTDPED","Qtd.Pedido","@E 99,999.99"})
AADD(aTitulo4,{"QTDNFE","Qtd.Nota","@E 99,999.99"})

If !LS4->(eof())
	@ 120,040 TO 400,880 DIALOG oAmar TITLE "DivergЙncias encontradas..."
	@ 005,005 BUTTON "Sair" SIZE 55,10 ACTION oAmar:end()
	If _nMaior>0
		@ 005,100 say "Valor Total Excedido R$ "+Transform(_nMaior,"@E 99,999.99") FONT oFont1 OF oAmar PIXEL COLOR CLR_HRED
	Endif
	@ 020,005 TO 140,417 BROWSE "LS4" ENABLE " LS4->FLAG<>'X' " OBJECT OBRWA FIELDS aTitulo4
	ACTIVATE DIALOG oAmar CENTER
Else
	Msgbox("NЦo foram encontradas nenhuma divergЙncia!","AtenГЦo...","ALERT")
Endif
Dbselectarea("LS4")
dbCloseArea("LS4")
fErase( cArqTrab4+ ".DBF" )
fErase( cArqTrab4+ OrdBagExt() )
Return


//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Envia email de nota recusada										Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function EMAIL()

Local cSubject := "Nota fiscal "+cNota+" recusado o recebimento..."
Local cMsg      := ""
Local cAttach   := ""
Local aMsg      := {}
Local aUsrMail := {}
Local lConectou := .f.
LOCAL cACCOUNT := alltrim(getmv("MV_RELACNT"))
LOCAL cPASSWORD := alltrim(getmv("MV_RELPSW"))
LOCAL cSERVER   := alltrim(getmv("MV_RELSERV"))

CONNECT SMTP SERVER cServer ACCOUNT cAccount PASSWORD cPassword RESULT lConectou

cMensagem := "Nota fiscal "+cNota+" recusado o recebimento devido algumas divergЙncias encontradas pelo comprador"+ chr(13)+chr(10)
cMensagem := cMensagem+ " Fornecedor:"+_cFornecedor +"               CNPJ:"+_cCNPJ+ chr(13)+chr(10)
cMensagem := cMensagem+ " Data EmissЦo:"+_cEmissao+ chr(13)+chr(10)
cMensagem := cMensagem+ " Total da Nota Fiscal R$  "+alltrim(STR(nTotalNF,12,2))+ chr(13)+chr(10)
cMensagem := cMensagem+ chr(13)+chr(10)
cMensagem := cMensagem+ chr(13)+chr(10)
cMensagem := cMensagem+ "Caso tenha alguma dЗvida, entrar em contato com o comprador "+_cUsuario+ chr(13)+chr(10)
cMensagem := cMensagem+ chr(13)+chr(10)
cMensagem := cMensagem+ chr(13)+chr(10)
cMensagem := cMensagem+ "NOTA FISCAL DO "+SM0->M0_FILIAL+chr(13)+chr(10)
cMensagem := cMensagem+ chr(13)+chr(10)
cMensagem := cMensagem+ "EMAIL AUTOMаTICO ENVIADO PELO SISTEMA,FAVOR NцO RESPONDй-LO"

SEND MAIL FROM cACCOUNT TO xEMAILREC SUBJECT cSubject BODY cMensagem RESULT lEnviado

If !lEnviado
	cMensagem := ""
	GET MAIL ERROR cMensagem
	Alert(cMensagem)
Endif
DISCONNECT SMTP SERVER Result lDesConectou
Return

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Seleciona produto													Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function SELECIONA(_cProduto,lOpcao)

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Verifico se o produto esta bloqueado para uso						Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды

Local lOk := .F.
Private lCorrige 
Private oQuant
Private nQuant := LS1->QUANTIDADE
Private oVlrUnit 
Private nVlrUnit := LS1->PRECO
Private oVlrTot 
Private nVlrTot := LS1->TOTAL
Private lValid := .F.

Dbselectarea("SB1")
DbSetorder(1)
Dbgotop()
Dbseek(xFilial("SB1")+_cProduto)
If Found() .and. SB1->B1_MSBLQL=="1"
	msgbox("Produto bloqueado para uso!","AtenГЦo...","ALERT")
	return
Endif

_nQE:=LS1->QE
cMemo:=''

_nQuantPed:=0
_nVlrPed:=0

If cPedCom
	cQuery:=" SELECT C7_EMISSAO EMISSAO,Case C7_MOEDA When 1 Then C7_PRECO When 2 Then C7_PRECO * C7_TXMOEDA End As PRECO,C7_LOJA LOJA,C7_NUM PEDIDO,(C7_QUANT-C7_QUJE-C7_QTDACLA) QUANT FROM "+RetSqlName("SC7")+" WHERE C7_FILIAL='"+xFilial("SC7")+"' "
	cQuery:=cQuery + " AND C7_PRODUTO='"+ALLTRIM(_cProduto)+"' "
	cQuery:=cQuery + " AND C7_FORNECE='"+LS3->FORNEC+"' "
	cQuery:=cQuery + " AND (C7_QUANT-C7_QUJE-C7_QTDACLA)>0 "
	cQuery:=cQuery + " AND C7_RESIDUO<>'S' "
	cQuery:=cQuery + " AND D_E_L_E_T_<>'*' "
	cQuery:=cQuery + " ORDER BY R_E_C_N_O_ DESC "
	TCQUERY cQuery NEW ALIAS "TCQ"
	DbSelectarea("TCQ")
	While !Eof()
		cMemo:=cMemo+DTOC(STOD(TCQ->EMISSAO))+"   "+TCQ->PEDIDO+"   "+TCQ->LOJA+"   "+ALLTRIM(STR(TCQ->QUANT,12,2))+"       "+transform(TCQ->PRECO,"@E 9,999.99")+CHR(13)+CHR(10)
		If _nQuantPed==0
			_nQuantPed := TCQ->QUANT
			_nVlrPed   := TCQ->PRECO
		Endif
		Dbskip()
	End
	DbClosearea("TCQ")
Endif

If Empty(cMemo)
	cmemo:="NЦo existe nenhum pedido com este produto..."
Endif

/*
_nCaixas:=IIF(lTipo == 4,0,LS1->CAIXAS)
_nQuant :=(_nQE*_nCaixas)
_nTotal:=LS1->TOTAL
_nPreco:=(LS1->TOTAL/(_nQE*_nCaixas))
_nQuantNF:=LS1->QUANTIDADE

If _nCaixas==0
	_nQuant:=_nQuantNF
	_nPreco:=(_nTotal/_nQuant)
Else
	_nQuant:=(_nQE*_nCaixas)
	_nPreco:=(_nTotal/_nQuant)
Endif   
*/

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Tela de parametros													Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды

lCorrige := (LS1->UMXML <> SB1->B1_UM) .And. (LS1->UMXML <> SB1->B1_SEGUM)

lGravou:=.F.   

If !lCorrige
	GRAVANDO(lOpcao)
Else		
	DEFINE	MSDIALOG oDef TITLE "Produto "+SB1->B1_COD FROM 120, 040 TO 380, 270 PIXEL STYLE DS_MODALFRAME
 //	@ 005,005 say "Qtd.Emb."  FONT oFont1 OF oDef PIXEL
   //	@ 015,005 Msget _nQE size 20,10 Picture "@E 9999" OF oDef PIXEL //valid CALCULA()
	      
		lValid := .T.                        
		If Empty(SB1->B1_SEGUM)
			@ 003,005 say "Cadastre a Segunda Unidade de medida ou " FONT oFont1 OF oDef PIXEL   COLOR CLR_GREEN
		EndIf
		@ 013,005 say "Preencha os campos abaixo "  OF oDef PIXEL    COLOR CLR_GREEN
		@ 021,005 say "na Unidade de Medida:"   OF oDef PIXEL    COLOR CLR_GREEN
		@ 020,070 say Posicione("SAH" , 1 , xFilial("SAH")+SB1->B1_UM , "AH_UMRES")  FONT oFont1 OF oDef PIXEL   
		
		@ 035,005 say "Quantidade "  FONT oFont1 OF oDef PIXEL
		@ 045,005 MsGET oQuant Var nQuant size 60,10 Picture "@E 9999999.99999" OF oDef PIXEL; //valid CALCULA()
		valid (nVlrTot:=nQuant*nVlrUnit)
		
		@ 060,005 say "Vlr UnitАrio" FONT oFont1 OF oDef PIXEL
		@ 070,005 Msget oVlrUnit Var nVlrUnit  size 60,10 Picture "@E 99,999,999.9999" OF oDef PIXEL; //valid CALCULA()	
		valid (nVlrTot:=nQuant*nVlrUnit)
		
		@ 085,005 say "Vlr Total" FONT oFont1 OF oDef PIXEL
		@ 095,005 Msget oVlrTot Var nVlrTot  size 60,10 Picture "@E 99,999,999.9999" OF oDef PIXEL 
		oVlrTot:Disable()
	
	@ 110,005 BUTTON "Confirmar" SIZE 50,10 ACTION (lOk := fVldTot(), IIF(lOk,GRAVANDO(lOpcao),))
	@ 110,060 BUTTON "Sair" SIZE 50,10 ACTION oDef:end()
	//ACTIVATE MSDIALOG oDef CENTER
	ACTIVATE MSDIALOG oDef CENTERED   
EndIf      		

If lGravou .and. lOpcao==2
	oAmarra:end()
Endif

Return   


//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
Static Function fVldTot()  
Local nTotXML := LS1->TOTAL
Local lRet := .T.

nVlrTot := nQuant*nVlrUnit

If Abs(nVlrTot-nTotXML) > 0.01
	MsgAlert("O Valor total deve ser igual a "+Transform(LS1->TOTAL,"@E 99,999,999.99")+"")
	lRet := .F.
EndIf	

Return lRet



//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Gravando produto...													Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static function GRAVANDO(lOpcao)
Local cUmTela := ""
lDifer:=.F.      


/*
If _nQuantPed>0
If _nQuant<>_nQuantPed
Msgbox("Quantidade da Nota fiscal, diferente da quantidade do ultimo pedido!")
lDifer:=.T.
Endif

If _nPreco>=(_nVlrPed+0.05)
Msgbox("PreГo unitАrio da Nota fiscal, diferente do preГo do ultimo pedido!")
lDifer:=.T.
Endif

If (_nPreco)>(_nVlrPed+1)
Msgbox("PreГo da nota fiscal, muito maior que do ultimo pedido!")
lDifer:=.T.
Endif
Endif

If lDifer
cResp:=Msgbox("Deseja gravar o produto mesmo assim?","AtenГЦo...","YESNO")
If cResp==.F.
Return
Endif
Endif

*/

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Verifico se o codigo de barras existe								Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If lOpcao==2
	_cProduto := LS4->PRODUTO
Else
	_cProduto := LS1->PRODUTO
Endif

_cCodBarras:=''
DbSelectarea("SB1")
DbSetorder(1)
Dbgotop()
Dbseek(xFilial("SB1")+_cProduto)
If Found()
	_cCodBarras:=SB1->B1_CODBAR
Endif

//_nCusto:=ULTPED(_cProduto)
//_nPrecoA:=(LS1->TOTAL/_nQuant)

//If lOpcao==2
DbSelectarea("LS1")
IF !EOF()
	Reclock("LS1",.F.)
	///	IF (_nPrecoA-_nCusto)>=1 .or. (_nCusto-_nPrecoA)>=1
	///	LS1->OK:="O"
	///Else
	LS1->OK := ""
	///Endif
	
	///	IF (_nPrecoA-_nCusto)>=1 .or. (_nCusto-_nPrecoA)>=1//Alredo para usuario intervir se deseja utilizar o item  - Rafael
	///	   	LS1->OK:="O"
	///		If !(alltrim(LS1->UM) == Alltrim(SB1->B1_UM)) //unidade de medida for diferente - solicitar se deseja usar
	///			If MsgYesNo("A Unidade de medida entre os itens sЦo diferente, deseja utilizar?","Atencao")
	///				LS1->OK:=""
	///			EndIF
	///		EndiF
	///	Else
	///		LS1->OK:=""
	///	Endif
	
	LS1->PRODUTO:=_cProduto  
	If lOpcao == 2
		LS1->DESCRICAO:=LS4->DESCRICAO
	EndIf
	//LS1->CAIXAS:=_nCaixas
	//LS1->QUANTIDADE :=  _nQuant	
	//LS1->PRECO:=(LS1->TOTAL/_nQuant)
	//LS1->UM := SB1->B1_UM	
	If LS1->ALTERADO == "N"
		cUmTela := LS1->UMXML
	Else
		cUmTela := LS1->UM
	EndIf
	If cUmTela == SB1->B1_UM//Verifica se a 1o unidade de medida do xml eh igual a 1o unidade de medida do cadastro de produtos.		
		nQuant     := LS1->QUANTIDADE	
		LS1->PRECO := (LS1->TOTAL/nQuant)		     
		If !Empty(SB1->B1_SEGUM) .And. SB1->B1_CONV > 0 //Os campos da 2o um estao preenchidos, aplica conversao.					    
		    LS1->UM2    := SB1->B1_SEGUM
			LS1->QUANT2 := IIF(SB1->B1_TIPCONV == "D", nQuant/SB1->B1_CONV, nQuant*SB1->B1_CONV)
		EndIf
	ElseIf !Empty(cUmTela) .And. (SB1->B1_CONV > 0) .And. (cUmTela == SB1->B1_SEGUM)
		nQuant  := LS1->QUANTIDADE	
		LS1->UM := SB1->B1_UM
		//Tratar --> ?? Se a 1o UM do XML for encontrada na 2o do cadastro de produtos, inverte o sinal do tipo de conversao ??
		LS1->QUANTIDADE := IIF(SB1->B1_TIPCONV == "D",nQuant*SB1->B1_CONV,nQuant/SB1->B1_CONV)
		LS1->UM2        := SB1->B1_SEGUM
		LS1->QUANT2     := nQuant		
		nQuant          := LS1->QUANTIDADE
		LS1->PRECO      := (LS1->TOTAL/nQuant)		     			
	Else  
		LS1->QUANTIDADE := nQuant
		LS1->PRECO      := nVlrUnit//(LS1->TOTAL/nQuant)		     		
		LS1->UM         := SB1->B1_UM
		If !Empty(SB1->B1_SEGUM) .And. SB1->B1_CONV > 0 //Os campos da 2o um estao preenchidos, aplica conversao.					    
		    LS1->UM2    := SB1->B1_SEGUM
			LS1->QUANT2 := IIF(SB1->B1_TIPCONV == "D",nQuant/SB1->B1_CONV,nQuant*SB1->B1_CONV)
		EndIf
	EndIf		
	//LS1->PRECOFOR:=_nPreco
	
	//LS1->CUSTO:=_nCusto
	LS1->ALTERADO :="S"
	LS1->QE       :=_nQE
	MsUnlock()
ENDIF
DbSelectarea("LS5")
Reclock("LS5",.T.)
LS5->PRODUTO :=_cProduto
MsUnlock()
//EndIf
/*
Else
	DbSelectarea("LS1")
	Reclock("LS1",.F.)
	LS1->ALTERADO:="S"
	IF (_nPrecoA-_nCusto)>=1 .or. (_nCusto-_nPrecoA)>=1
		LS1->OK:="O"
	Else
		LS1->OK:=""
	Endif
	IF (_nPrecoA-_nCusto)>=1 .or. (_nCusto-_nPrecoA)>=1 //Alredo para usuario intervir se deseja utilizar o item  - Rafael
		LS1->OK:="O"
		If !(alltrim(LS1->UM) == Alltrim(SB1->B1_UM)) //unidade de medida for diferente - solicitar se deseja usar
			If MsgYesNo("A Unidade de medida entre os itens sЦo diferente, deseja utilizar?","Atencao")
				LS1->OK:=""
			EndIF
		EndiF
	Else
		LS1->OK:=""
	Endif
	LS1->CAIXAS:=_nCaixas
	LS1->QUANTIDADE:=_nQuant
	LS1->PRECOFOR:=_nPreco
	LS1->PRECO:=(LS1->TOTAL/_nQuant)
	//LS1->CUSTO:=ULTPED(LS1->PRODUTO)
	LS1->QE:=_nQE
	If lTipo == 4 //CTE
		LS1->OK:=""
	EndIf
	MsUnlock()
Endif    
*/

OBRWI:obrowse:refresh()
OBRWP:obrowse:refresh()
ObjectMethod(oTela,"Refresh()")

DbSelectarea("LS1")
DbSetorder(1)
Dbgotop()
Dbseek(nSeek)

lGravou:=.T.

If lCorrige
	oDef:end()
Endif

Return

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Filtrar produtos													Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function FILTRE()

If Len(alltrim(_cFiltrox))>2
	Dbselectarea("LS4")
	Dbgotop()
	While !Eof()
		Reclock("LS4",.F.)
		dbdelete()
		MsUnlock()
		Dbskip()
	End
	
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁVerifica se a pesquisa do produto foi sub-dividida			Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	_cDesc1:=''
	_cDesc2:=''
	_cDesc3:=''
	
	For w:=1 to len(alltrim(_cFiltrox))
		If SUBSTR(ALLTRIM(_cFiltrox),w,1) $ ";/,"
			cont2:=(w-1)
			_cDesc1:=SUBSTR(_cFiltrox,1,cont2)
			w:=100
		Endif
	Next
	
	If !Empty(_cDesc1)
		_nInicio:=(cont2+2)
		_cString:=SUBSTR(ALLTRIM(_cFiltrox),_nInicio,50)
		If !empty(_cString)
			For w:=1 to len(alltrim(_cString))
				If SUBSTR(ALLTRIM(_cString),w,1) $ ";/,"
					cont2:=(w-1)
					_cDesc2:=SUBSTR(_cString,1,cont2)
					w:=100
				Endif
			Next
			
			If Empty(_cDesc2)
				_cDesc2:=alltrim(_cString)
			Endif
		Endif
	Endif
	
	If !Empty(_cDesc2)
		_nInicio:=(cont2+2)
		_cString2:=SUBSTR(ALLTRIM(_cString),_nInicio,50)
		If !empty(_cString2)
			For w:=1 to len(alltrim(_cString2))
				If SUBSTR(ALLTRIM(_cString2),w,1) $ ";/,"
					cont2:=(w-1)
					_cDesc3:=SUBSTR(_cString2,1,cont2)
					w:=100
				Endif
			Next
			
			If Empty(_cDesc3)
				_cDesc3:=alltrim(_cString2)
			Endif
		Endif
	Endif
	
	If Empty(_cDesc1)
		_cDescp1:="%"+alltrim(_cFiltrox)+"%"
	Else
		_cDescp1:="%"+alltrim(_cDesc1)+"%"
		_cDescp2:="%"+alltrim(_cDesc2)+"%"
		_cDescp3:="%"+alltrim(_cDesc3)+"%"
	Endif
	
	cQuery:=" SELECT B1_MSBLQL BLQ,B1_CODBAR CODBAR,B1_COD PRODUTO,B1_DESC DESCRICAO FROM "+RetSqlName("SB1")+" "
	cQuery:=cQuery + " 	WHERE B1_FILIAL='"+xFilial("SB1")+"' AND (B1_DESC LIKE '"+_cDescp1+"' OR B1_COD='"+alltrim(_cDescp1)+"') "
	IF !Empty(_cDesc2)
		cQuery:=cQuery + " AND B1_DESC LIKE '"+_cDescp2+"' "
	Endif
	IF !Empty(_cDesc3)
		cQuery:=cQuery + " AND B1_DESC LIKE '"+_cDescp3+"' "
	Endif
	cQuery:=cQuery + " AND D_E_L_E_T_<>'*' "
	TCQUERY cQuery NEW ALIAS "TCQ"
	DbSelectarea("TCQ")
	While !Eof()
		If cPedCom
			lPedido:=TEMPED(TCQ->PRODUTO)
		Else
			lPedido:="NЦo"
		Endif
		If (lCheck1 .and. lPedido=="Sim" .or. lCheck1==.F.)
			
			DbSelectarea("SB1")
			DbSetorder(1)
			Dbgotop()
			Dbseek(xFilial("SB1")+TCQ->PRODUTO)
			
			If Empty(cAlmox)
				cAlmox:=SB1->B1_LOCPAD
			Endif
			
			Reclock("LS4",.T.)
			LS4->PRODUTO:=TCQ->PRODUTO
			IF "SAIU" $ TCQ->DESCRICAO
				LS4->DESCRICAO:=SUBSTR(TCQ->DESCRICAO,6,45)
			Else
				LS4->DESCRICAO:=TCQ->DESCRICAO
			Endif
			LS4->SALDO:=POSICIONE("SB2",2,xFilial("SB2")+cAlmox+TCQ->PRODUTO,"B2_QATU-B2_RESERVA-B2_QEMP")
			LS4->QE:=SB1->B1_QE
			LS4->PEDIDO:=lPedido
			LS4->BLQ:=IIF(TCQ->BLQ=="1","Bloq.","Ativo")
			MsUnlock()
		Endif
		DbSelectarea("TCQ")
		Dbskip()
	End
	DbClosearea("TCQ")
	
	Dbselectarea("LS4")
	Dbgotop()
Endif
Return

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Calcula produto														Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function CALCULA()

If _nCaixas==0
	_nQuant:=_nQuantNF
	_nPreco:=(_nTotal/_nQuant)
Else
	_nQuant:=(_nQE*_nCaixas)
	_nPreco:=(_nTotal/_nQuant)
Endif
Return

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Calcula produto														Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function TEMPED(_cProduto)

cQuery:=" SELECT COUNT(*) QTD FROM "+RetSqlName("SC7")+" WHERE C7_FILIAL='"+xFilial("SC7")+"' "
cQuery:=cQuery + " AND C7_PRODUTO='"+alltrim(TCQ->PRODUTO)+"' "
cQuery:=cQuery + " AND C7_FORNECE='"+LS3->FORNEC+"' "
cQuery:=cQuery + " AND (C7_QUANT-C7_QUJE-C7_QTDACLA)>0 "
cQuery:=cQuery + " AND C7_RESIDUO<>'S' "
cQuery:=cQuery + " AND D_E_L_E_T_<>'*' "
TCQUERY cQuery NEW ALIAS "PED"
DbSelectarea("PED")
lPedido:=PED->QTD
DbClosearea("PED")

If lPedido>0
	_cTem:="Sim"
Else
	_cTem:="NЦo"
Endif
Return(_cTem)

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Refazer Nota fiscal													Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function REFAZER()

//cResp:=msgbox("Deseja refazer toda a nota fiscal?","AtenГЦo...","YESNO")

//If cResp
	PROCESS()
//Endif
Return

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Recebendo email automaticamente										Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function POPEMAIL()

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Dados da conta POP													Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
nTotMsg := 0
cTO:=""
cAccount   := xCONTA
cServer    := xPOP
cPassword  := xSENHA
lConectou  := .f.
cBody      :=""
cFrom:=""
cCc:=""
cBcc:=""
cSubject:=""
cCmdEnv:=""
nTotMsg:=0

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Conectado ao servidor POP											Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
CONNECT POP SERVER cServer ACCOUNT cAccount PASSWORD cPassword RESULT lConectou
POP MESSAGE COUNT nTotMsg

If nTotMsg>0
	Msgbox("Existem "+alltrim(str(nTotMsg,5,0))+" novas mensagens...","AtenГЦo...","INFO")
Endif

If !lConectou
	Msgbox("NЦo foi possМvel ler emails da conta...")
Else
	For w:=1 to nTotMsg
		aFiles:={}
		RECEIVE MAIL MESSAGE w FROM cFrom TO cTo CC cCc BCC cBcc SUBJECT cSubject BODY cBody ATTACHMENT aFiles SAVE IN ("\xml") DELETE
	Next
Endif
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Desconectando														Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If lConectou
	DISCONNECT POP SERVER Result lDisConectou
	If !lDisConectou
		Alert ("Erro ao disconectar do Servidor de e-mail - " + cServer)
	EndIf
EndIf
Return

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Excluir amarracao													Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function EXCAMA() 

PROCESS()		

/*

If Empty(LS1->OK) .OR. LS1->OK=="O"
	
	cResp:=msgbox("Deseja excluir a amarraГЦo do produto?","AtenГЦo...","YESNO")
	
	If cResp		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Excluindo da tabela de produtos identificados						Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		DbSelectarea("LS5")
		DbSetorder(1)
		Dbgotop()
		Dbseek(LS1->PRODUTO)
		If Found()
			Reclock("LS5",.F.)
			dbdelete()
			MsUnlock()
		Endif
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Excluindo da tabela amarracao produto x fornecedor					Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		DbSelectarea("SA5")
		DbSetorder(1)
		Dbgotop()
		Dbseek(xFilial("SA5")+LS3->FORNEC+LS3->LOJA+LS1->PRODUTO)
		If Found()
			Reclock("SA5",.F.)
			dbdelete()
			MsUnlock()
		Endif
		
		Reclock("LS1",.F.)
		LS1->DESCRICAO:=LS1->DESCORI
		LS1->PRODUTO:="999999"
		LS1->OK:="X"
		LS1->UM := LS1->UMXML
		LS1->UM2 := "" 
		LS1->ALTERADO := "N"
		MsUnlock()
	Endif
Else
	Msgbox("NЦo existe amarraГЦo para este produto!")
Endif  
*/
Return

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Ultimo preco de pedido												Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function ULTPED(_cProduto)
_nPedido:=0
_nQtd:=1

cQuery:=" SELECT Case C7_MOEDA When 1 Then C7_PRECO When 2 Then C7_PRECO * C7_TXMOEDA End As PRECO FROM "+RetSqlName("SC7")+" WHERE C7_FILIAL='"+xFilial("SC7")+"' AND C7_PRODUTO='"+alltrim(_cProduto)+"' AND C7_FORNECE='"+LS3->FORNEC+"' AND C7_PRECO>0 AND D_E_L_E_T_<>'*' ORDER BY C7_EMISSAO DESC "
TCQUERY cQuery NEW ALIAS "TCQ"
DbSelectarea("TCQ")
While !Eof() .and. _nQtd==1
	_nPedido:=TCQ->PRECO
	_nQtd:=2
	Dbskip()
End
Dbclosearea("TCQ")

If _nPedido<=0
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Caso nao encontre, ultimo preco de entrada							Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	_nPedido:=POSICIONE("SB1",1,xFilial("SB1")+_cProduto,"B1_UPRC")
Endif
Return(_nPedido)

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Eliminar pedido														Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function ELIMINAR()

IF (DDATABASE-LS2->EMISSAO)<=30
	msgbox("O pedido tem que ter mais de 30 dias de vencimento!")
	Return
Endif

IF LS2->OK<>"X"
	cResp:=msgbox("Deseja eliminar o resМduo do pedido "+LS2->PEDIDO+"?","AtenГЦo...","YESNO")
	
	If cResp
		lEntrou:=.F.
		DbSelectarea("SC7")
		DbSetorder(1)
		dbgotop()
		Dbseek(xFilial("SC7")+LS2->PEDIDO)
		While !Eof() .and. ALLTRIM(SC7->C7_NUM)==ALLTRIM(LS2->PEDIDO)
			IF SC7->C7_QTDACLA<=0
				IF SC7->C7_RESIDUO<>"S" .and. (SC7->C7_QUANT-SC7->C7_QUJE)>0
					Reclock("SC7",.F.)
					SC7->C7_RESIDUO:="S"
					MsUnlock()
					lEntrou:=.T.
					
					DbSelectarea("SB2")
					DbSetorder(2)
					Dbgotop()
					Dbseek(xFilial("SB2")+SC7->C7_LOCAL+SC7->C7_PRODUTO)
					If Found()
						Reclock("SB2",.F.)
						SB2->B2_SALPEDI:=(SB2->B2_SALPEDI-(SC7->C7_QUANT-SC7->C7_QUJE))
						MsUnlock()
					Endif
				Endif
			Endif
			DbSelectarea("SC7")
			Dbskip()
		End
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Apagando pedido do browse											Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If lEntrou
			DbSelectarea("LS2")
			Reclock("LS2",.F.)
			dbdelete()
			MsUnlock()
			dbgobottom()
			Msgbox("Pedido eliminado com sucesso!","AtenГЦo...","INFO")
		Endif
	Endif
Else
	Msgbox("Este pedido nЦo pode ser eliminado!","AtenГЦo...","ALERT")
Endif
Return

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Mensagem nota fiscal												Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function MSGNF(_cMensag)

If !Empty(_cMensag)
	DEFINE MSDIALOG oMensNF FROM 0,0 TO 290,415 PIXEL TITLE "Mensagem da Nota Fiscal"
	@ 005,005 GET oMemo VAR _cMensag MEMO SIZE 200,135 FONT oFont2 PIXEL OF oMensNF
	ACTIVATE MSDIALOG oMensNF CENTER
Endif
Return

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Funcao Legenda														Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function LEGENDA()
_cLegenda := "Legenda dos produtos"

aCorLegen := { 	{ 'BR_VERDE'   ,"Produto OK!" },;
{ 'BR_VERMELHO',"Sem identificaГЦo" },;
{ 'BR_CANCEL',"PreГo diferente em mais de R$ 1,00" }}
BrwLegenda(_cLegenda,"Status do Produto",aCorLegen)
Return

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Funcao Consulta SEFAZ												Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function SEFAZ()
//cChave:="http://www.nfe.fazenda.gov.br/portal/formulariodepesquisa.aspx?tipoconsulta=completa&chaveacesso="+LS3->CHAVE
cChave:="http://www.nfe.fazenda.gov.br/portal/consulta.aspx?tipoConsulta=completa&tipoConteudo=XbSeqxE8pl8="
ShellExecute("open",cChave,"","",0)
Return

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Atualiza informacoes arquivo de configuracao						Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function ATUCFG()

_lAlmox:=LS1->ALMOX
_lSerie:=LS1->SERIE
_lEmail:=LS1->EMAIL
_lPedido:=LS1->PEDIDO
_lEspecie:=LS1->ESPECIE

DEFINE MSDIALOG oAtuCfg TITLE "Informe os parametros..." From 9,0 To 25,50 OF oMainWnd
@002,004 TO 100,195
@005,006 Say "Almox.p/ saldos            (Branco-Local PadrЦo)" FONT oFont6 PIXEL COLOR CLR_HBLUE
@005,060 Get _lAlmox SIZE 20,10 Picture "@!"
@025,006 Say "Almox.p/ Pedidos           (Branco-Local PadrЦo) " FONT oFont6 PIXEL COLOR CLR_HBLUE
@025,060 Get _lPedido SIZE 20,10 Picture "@!"
@045,006 Say "SИria da Nota              (Branco-SИrie Fornec.) " FONT oFont6 PIXEL COLOR CLR_HBLUE
@045,060 Get _lSerie SIZE 20,10 Picture "@!"
@065,006 Say "Emails  " FONT oFont6 PIXEL COLOR CLR_HBLUE
@065,060 Get _lEmail SIZE 125,10 Picture "@"
@085,006 Say "EspИcie NF " FONT oFont6 PIXEL COLOR CLR_HBLUE
@085,060 Get _lEspecie SIZE 125,10 Picture "@"
@105,006 BUTTON "Gravar" SIZE 40,10 ACTION 	oAtuCfg:end()
ACTIVATE MSDIALOG oAtuCfg CENTERED

Reclock("LS1",.F.)
LS1->ALMOX:=_lAlmox
LS1->SERIE:=_lSerie
LS1->EMAIL:=_lEmail
LS1->PEDIDO:=_lPedido
LS1->ESPECIE:=_lEspecie
MsUnlock()
Return

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Geracao NDF fornecedor												Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function NDF()
RecLock("SE2",.T.)
SE2->E2_FILIAL  := xFilial("SE2")
SE2->E2_PREFIXO := "XML"
SE2->E2_NUM     := cNota
SE2->E2_PARCELA := ""
SE2->E2_TIPO	 := "NDF"
SE2->E2_EMISSAO := ddatabase
SE2->E2_VENCREA := ddatabase+30
SE2->E2_VENCTO  := ddatabase+30
SE2->E2_VENCORI := ddatabase+30
SE2->E2_MOEDA   := 1
SE2->E2_EMIS1   := dDataBase
SE2->E2_FORNECE := LS3->FORNEC
SE2->E2_LOJA    := LS3->LOJA
SE2->E2_VALOR   := _nExcedido
SE2->E2_SALDO   := _nExcedido
SE2->E2_VLCRUZ  := _nExcedido
If lItem==.F.
	SE2->E2_NOMFOR  := POSICIONE("SA2",1,xFilial("SA2")+LS3->FORNEC+LS2->LOJA,"A2_NREDUZ")
Else
	SE2->E2_NOMFOR  := POSICIONE("SA2",1,xFilial("SA2")+LS3->FORNEC+LS3->LOJA,"A2_NREDUZ")
Endif
SE2->E2_ORIGEM  := "LERXML"
MsUnlock()
Return


//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Valor NDF do fornecedor												Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function VALORNDF()

_nExcedido:=0
Dbselectarea("LS1")
DbSetorder(1)
Dbgotop()
While !Eof()
	cQuery:=" SELECT COUNT(*) QTD,AVG(C7_PRECO*C7_TXMOEDA) PRECO,SUM(C7_QUANT-C7_QUJE-C7_QTDACLA) QUANT FROM "+RetSqlName("SC7")+" WHERE C7_FILIAL='"+xFilial("SC7")+"' "
	If lItem==.F.
		cQuery:=cQuery + " AND C7_NUM='"+LS2->PEDIDO+"' "
	Else
		cQuery:=cQuery + " AND C7_NUM='"+LS1->PEDIDO+"' "
		cQuery:=cQuery + " AND C7_ITEM='"+LS1->ITEM+"' "
	Endif
	cQuery:=cQuery + " AND C7_PRODUTO='"+LS1->PRODUTO+"' "
	cQuery:=cQuery + " AND C7_RESIDUO<>'S' "
	cQuery:=cQuery + " AND D_E_L_E_T_<>'*' "
	TCQUERY cQuery NEW ALIAS "TCQ"
	DbSelectarea("TCQ")
	While !Eof()
		If (round(LS1->PRECO,2)>Round(TCQ->PRECO,2)) .AND. Round(TCQ->PRECO,2)>0
			_nExcedido:=_nExcedido+(LS1->QUANTIDADE*(round(LS1->PRECO,2)-Round(TCQ->PRECO,2)))
		Endif
		DbSelectarea("TCQ")
		Dbskip()
	End
	DbClosearea("TCQ")
	Dbselectarea("LS1")
	Dbskip()
End
Return(_nExcedido)
                       



//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Manipulando arquivo de configuracao									Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function CONFARQ()

_lPOP:=space(100)
_lConta:=space(100)
_lSenha:=space(20)
_lUM:=space(100)
_lLogo:=space(20)
_lPed:="NЦo"
_lNDF:="NЦo"
_lZeros:="NЦo"

cResp:=msgbox("Deseja configurar os parametros da rotina?","AtenГЦo...","YESNO")

If cResp
	cBuffer   := ""
	If File(cArqTxt)
		FT_FUSE(cArqTxt)
		FT_FGOTOP()
		ProcRegua(FT_FLASTREC())
		
		While !FT_FEOF()
			cBuffer := FT_FREADLN()
			If UPPER(SUBSTR(cBuffer,1,3))=="POP"
				_lPOP:=lower(ALLTRIM(SUBSTR(cBuffer,5,400)))+space(200)
			Endif
			If UPPER(SUBSTR(cBuffer,1,5))=="CONTA"
				_lConta:=lower(ALLTRIM(SUBSTR(cBuffer,7,400)))+space(200)
			Endif
			If UPPER(SUBSTR(cBuffer,1,5))=="SENHA"
				_lSenha:=lower(ALLTRIM(SUBSTR(cBuffer,7,400)))+space(200)
			Endif
			If UPPER(SUBSTR(cBuffer,1,2))=="UM"
				_lUM:=ALLTRIM(UPPER(SUBSTR(cBuffer,4,400)))+space(200)
			Endif
			If UPPER(SUBSTR(cBuffer,1,4))=="LOGO"
				_lLogo:=ALLTRIM(UPPER(SUBSTR(cBuffer,6,200)))+space(200)
			Endif
			If UPPER(SUBSTR(cBuffer,1,6))=="PEDIDO"
				_lPed:="Sim"
			Endif
			If UPPER(SUBSTR(cBuffer,1,3))=="NDF"
				_lNDF:="Sim"
			Endif
			If UPPER(SUBSTR(cBuffer,1,7))=="NFZEROS"
				_lZeros:="Sim"
			Endif
			FT_FSKIP()
		EndDo
		FT_FUSE()
	Endif
	
	aCampos	:= {{"EMPRESA","C",2,0 },;
				{"FILIAL","C",2,0 },;
				{"NOME","C",20,0 },;
				{"ALMOX","C",2,0 },;
				{"PEDIDO","C",2,0 },;
				{"SERIE","C",3,0 },;
				{"ESPECIE","C",5,0 },;
				{"EMAIL","C",300,0 }}
	
	cArqTrab  := CriaTrab(aCampos)
	dbUseArea( .T.,, cArqTrab, "LS1", if(.F. .OR. .F., !.F., NIL), .F. )
	IndRegua("LS1",cArqTrab,"EMPRESA+FILIAL",,,)
	dbSetIndex( cArqTrab +OrdBagExt())
	dbSelectArea("LS1")
	
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Empresas/Filiais - SIGAMAT											Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	DbSelectarea("SM0")
	Dbsetorder(1)
	Dbgotop()
	While !Eof()
		
		_lSerie  :=space(03)
		_lAlmox  :=space(02)
		_lEmail  :=space(300)
		_lPedido :=space(02)
		_lEspecie:="SPED"
		
		If File(cArqTxt)
			FT_FUSE(cArqTxt)
			FT_FGOTOP()
			ProcRegua(FT_FLASTREC())
			
			While !FT_FEOF()
				cBuffer := FT_FREADLN()
				If UPPER(SUBSTR(cBuffer,1,4))==SM0->M0_CODIGO+SM0->M0_CODFIL
					_lSerie:=ALLTRIM(SUBSTR(cBuffer,6,3))
				Endif
				If UPPER(SUBSTR(cBuffer,1,5))=="S"+SM0->M0_CODIGO+SM0->M0_CODFIL
					_lAlmox:=ALLTRIM(SUBSTR(cBuffer,7,2))
				Endif
				If UPPER(SUBSTR(cBuffer,1,9))=="EMAIL"+SM0->M0_CODIGO+SM0->M0_CODFIL
					_lEmail:=ALLTRIM(SUBSTR(cBuffer,11,300))
				Endif
				If UPPER(SUBSTR(cBuffer,1,5))=="P"+SM0->M0_CODIGO+SM0->M0_CODFIL
					_lPedido:=ALLTRIM(SUBSTR(cBuffer,7,2))
				Endif
				If UPPER(SUBSTR(cBuffer,1,7))=="ESP"+SM0->M0_CODIGO+SM0->M0_CODFIL
					_lEspecie:=ALLTRIM(SUBSTR(cBuffer,9,5))
				Endif
				FT_FSKIP()
			EndDo
			FT_FUSE()
		Endif
		
		Reclock("LS1",.T.)
		LS1->EMPRESA:=SM0->M0_CODIGO
		LS1->FILIAL :=SM0->M0_CODFIL
		LS1->NOME	:=UPPER(SM0->M0_FILIAL)
		LS1->SERIE	:=_lSerie
		LS1->ESPECIE:=_lEspecie
		LS1->ALMOX	:=_lAlmox
		LS1->EMAIL	:=_lEmail
		LS1->PEDIDO	:=_lPedido
		MsUnlock()
		DbSelectarea("SM0")
		Dbskip()
	End
	
	aTitulo := {}
	AADD(aTitulo,{"EMPRESA","Empresa"})
	AADD(aTitulo,{"FILIAL" ,"Filial"})
	AADD(aTitulo,{"NOME"   ,"Nome"})
	AADD(aTitulo,{"ESPECIE","EspИcie"})
	AADD(aTitulo,{"SERIE"  ,"SИrie"})
	AADD(aTitulo,{"ALMOX"  ,"Saldos"})
	AADD(aTitulo,{"PEDIDO" ,"Pedidos"})
	AADD(aTitulo,{"EMAIL"  ,"Emails para notas fiscais - Recusadas ( ; para separar )"})
	
	DbSelectarea("LS1")
	Dbgotop()
	
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Opcoes COMBOBOX														Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	aPedidos:={}
	AADD(aPedidos,"Sim")
	AADD(aPedidos,"NЦo")
	
	aNDF:={}
	AADD(aNDF,"Sim")
	AADD(aNDF,"NЦo")
	
	aZeros:={}
	AADD(aZeros,"Sim")
	AADD(aZeros,"NЦo")
	
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Apagando arquivo anterior										z	Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	Ferase(cArqTxt)
	
	DEFINE MSDIALOG oConfig FROM 0,0 TO 505,400 PIXEL TITLE "ConfiguraГЦo do arquivo CFGXML.TXT"
	@ 005,005 say "Servidor POP do recebimento do XML" SIZE 150,40 FONT oFont6 OF oConfig PIXEL
	@ 015,005 get _lPOP size 190,20
	@ 030,005 say "Email para recebimento do XML" SIZE 70,40 FONT oFont6 OF oConfig PIXEL
	@ 040,005 get _lConta size 90,20
	@ 030,135 say "NDF Fornecedor?" SIZE 150,40 FONT oFont6 OF oConfig PIXEL COLOR CLR_HRED
	@ 040,135 COMBOBOX _lNDF ITEMS aNDF SIZE 30,20
	@ 055,005 say "Senha do Email" SIZE 150,40 FONT oFont6 OF oConfig PIXEL
	@ 065,005 get _lSenha size 60,20 valid .t. PASSWORD
	@ 055,070 say "Logo (BMP)" SIZE 150,40 FONT oFont6 OF oConfig PIXEL
	@ 065,070 get _lLogo size 40,20 picture "@!"
	@ 055,135 say "Ped.Compras?" SIZE 150,40 FONT oFont6 OF oConfig PIXEL COLOR CLR_HRED
	@ 065,135 COMBOBOX _lPed ITEMS aPedidos SIZE 60,20
	@ 080,005 say "UM-UnitАrias - Ex.: UN/PC/LT" SIZE 150,40 FONT oFont6 OF oConfig PIXEL
	@ 090,005 get _lUM size 100,20 picture "@!"
	@ 080,135 say "Nota (9 Digitos)?" SIZE 150,40 FONT oFont6 OF oConfig PIXEL COLOR CLR_HRED
	@ 090,135 COMBOBOX _lZeros ITEMS aZeros SIZE 60,20
	@ 105,005 say "Empresas/Filiais" SIZE 150,40 FONT oFont5 OF oConfig PIXEL COLOR CLR_HBLUE
	@ 115,005 TO 235,195 BROWSE "LS1" OBJECT OBRWP FIELDS aTitulo
	OBRWP:OBROWSE:bLDblClick   := {||ATUCFG()}
	OBRWP:oBrowse:oFont := TFont():New ("Courier New", 06, 16)
	@ 240,005 BUTTON "Salvar" SIZE 60,10 ACTION oConfig:end()
	ACTIVATE MSDIALOG oConfig CENTER
	
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Criando novo arquivo												Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	cr:=chr(13)+chr(10)
	_nDiv    := 0
	_cDados     :={}
	
	AADD( _cDados,"POP="+alltrim(_lPOP))
	AADD( _cDados,"CONTA="+alltrim(_lConta))
	AADD( _cDados,"SENHA="+alltrim(_lSenha))
	AADD( _cDados,"UM="+alltrim(_lUM))
	AADD( _cDados,"LOGO="+alltrim(_lLogo))
	
	DbSelectarea("LS1")
	Dbgotop()
	While !Eof()
		IF !Empty(LS1->SERIE)
			AADD( _cDados,LS1->EMPRESA+LS1->FILIAL+"="+LS1->SERIE)
		Endif
		If !Empty(LS1->ALMOX)
			AADD(_cDados,"S"+LS1->EMPRESA+LS1->FILIAL+"="+LS1->ALMOX)
		Endif
		If !Empty(LS1->EMAIL)
			AADD(_cDados,"EMAIL"+LS1->EMPRESA+LS1->FILIAL+"="+LS1->EMAIL)
		Endif
		If !Empty(LS1->PEDIDO)
			AADD(_cDados,"P"+LS1->EMPRESA+LS1->FILIAL+"="+LS1->PEDIDO)
		Endif
		If Empty(LS1->ESPECIE)
			AADD(_cDados,"ESP"+LS1->EMPRESA+LS1->FILIAL+"=NF")
		Else
			AADD(_cDados,"ESP"+LS1->EMPRESA+LS1->FILIAL+"="+LS1->ESPECIE)
		Endif
		Dbskip()
	End
	
	If alltrim(_lPed)=="Sim"
		AADD( _cDados,"PEDIDO=SIM")
	Endif
	If alltrim(_lNDF)=="Sim"
		AADD( _cDados,"NDF=SIM")
	Endif
	If alltrim(_lZeros)=="Sim"
		AADD( _cDados,"NFZEROS=SIM")
	Endif
	
	hnda:=Fcreate(cArqTxt,0)
	for x := 1 TO len( _cDados )
		dados := _cDados[x]
		Fwrite(hnda,dados+cr)
	next
	Fclose(hnda)
	FClose(cArqTxt)
	
	Msgbox("ConfiguraГУes salvas com sucesso!","AtenГЦo...","INFO")
	
	Dbselectarea("LS1")
	dbCloseArea("LS1")
	fErase( cArqTrab+ ".DBF" )
	fErase( cArqTrab+ OrdBagExt() )
Endif
Return

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Codigo de barra														Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function CODBAR()

cCodbar:=''

If !Empty(LS1->CODBAR)
	cCodbar:=alltrim(cCodbar)+"CсDIGO BARRA DO XML"+chr(13)+chr(10)
	cCodbar:=alltrim(cCodbar)+alltrim(LS1->CODBAR)+chr(13)+chr(10)
	cCodbar:=alltrim(cCodbar)+chr(13)+chr(10)
Endif

If ALLTRIM(LS1->PRODUTO)<>"999999"
	DbSelectarea("SB1")
	DbSetorder(1)
	Dbgotop()
	Dbseek(xFilial("SB1")+LS1->PRODUTO,.t.)
	If Found()
		cCodbar:=alltrim(cCodbar)+"CADASTRO DE PRODUTO"+chr(13)+chr(10)
		cCodbar:=alltrim(cCodbar)+alltrim(SB1->B1_CODBAR)+chr(13)+chr(10)
		cCodbar:=alltrim(cCodbar)+chr(13)+chr(10)
	Endif
	
	DbSelectarea("SLK")
	DbSetorder(2)
	Dbgotop()
	Dbseek(xFilial("SLK")+LS1->PRODUTO,.t.)
	If Found()
		cCodbar:=alltrim(cCodbar)+"CADASTRO ALTERNATIVO"+chr(13)+chr(10)
		DbSelectarea("SLK")
		DbSetorder(2)
		Dbgotop()
		Dbseek(xFilial("SLK")+LS1->PRODUTO,.t.)
		While !Eof() .and. ALLTRIM(SLK->LK_CODIGO)==ALLTRIM(LS1->PRODUTO)
			cCodbar:=alltrim(cCodbar)+alltrim(SLK->LK_CODBAR)+chr(13)+chr(10)
			Dbskip()
		End
	Endif
Endif

If !Empty(cCodbar)
	Msgbox(cCodbar,"AtenГЦo...","INFO")
Endif
Return

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Desbloquear															Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function DESBLOQ()

If UPPER(ALLTRIM(LS4->BLQ))=="ATIVO"
	Msgbox("O Produto jА estА ativo!","AtenГЦo...","ALERT")
	Return
Endif

cResp:=msgbox("Deseja DESBLOQUEAR o produto novamente?","AtenГЦo...","YESNO")

If cResp
	DbSelectarea("LS4")
	Reclock("LS4",.F.)
	LS4->BLQ:="Ativo"
	MsUnlock()
	
	Dbselectarea("SB1")
	DbSetorder(1)
	Dbgotop()
	Dbseek(xFilial("SB1")+LS4->PRODUTO)
	If Found()
		Reclock("SB1",.F.)
		SB1->B1_MSBLQL:="2"
		IF "SAIU" $ ALLTRIM(SB1->B1_DESC)
			SB1->B1_DESC:=SUBSTR(SB1->B1_DESC,6,45)
		Endif
		MsUnlock()
	End
	msgbox("O Produto foi reativado com sucesso!","AtenГЦo...","INFO")
Endif
Return

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Historico do fornecedor												Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function HISTFOR()

cCadastro :='Historico Fornecedor'

aRotina2  := { {"Perdas","U_PR_PERD()",0,2},;
{"Trocas Produtos","U_PR_TRO()",0,2},;
{"DivergЙncias Pedidos","U_PR_DIV()",0,2},;
{"Pedidos com cortes","U_PR_COR()",0,2},;
{"Pedidos NЦo Entregues","U_PR_NAO()",0,2},;
{"Saldos por Grupo","U_PR_SALG()",0,2}}

aRotina   := {  {"Pesquisar","AxPesqui",0,1},;
{"Comprar"      , "U_PR_COM()",0,8},;
{"Totalizar"    , "U_PR_TOT()",0,3},;
{"Gerar Pedidos" , "U_PR_PED()",0,8},;
{"F4-HistСrico"    , "U_PR_HIS()",0,8},;
{"Consultas"	,aRotina2        ,0,2,0 ,NIL},;
{"SugestЦo"     , "U_PR_SUG()",0,6},;
{"PreГo FamМlia", "U_PR_FAM()",0,7},;
{"Incluir Produto", "U_PR_INCP()",0,7},;
{"Fora de Linha", "U_PR_FORL()",0,7},;
{"Legenda"      , 'U_PR_LEG()', 0 , 9}}

Pergunte("FIC030",.T.)
ALTERA:=.T.
INCLUI:=.F.
NVLGERALNF:=0
LF030TITAB:=.F.
LF030TITPG:=.F.
LF030TITCOM := .F.
LF030TITFAT := .F.
FC030CON(LS3->FORNEC,LS3->LOJA)
Return


//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Procura pedido por item												Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function PROCPED()

If ALLTRIM(LS1->PRODUTO)=="999999"
	Msgbox("Favor identificar o produto primeiro!","AtenГЦo...","ALERT")
	OBRWI:obrowse:refresh()
	OBRWI:obrowse:setfocus()
	ObjectMethod(oTela,"Refresh()")
	Return
Endif

If !Empty(LS1->PEDIDO) .and. ALLTRIM(LS1->PEDIDO)<>"CRIAR"
	Msgbox("Favor eliminar o pedido primeiro!","AtenГЦo...","ALERT")
	OBRWI:obrowse:refresh()
	OBRWI:obrowse:setfocus()
	ObjectMethod(oTela,"Refresh()")
	Return
Endif

aCampos2	:= {{"OK","C",1,0 },;
{"EMISSAO","D",8,0 },;
{"PEDIDO","C",6,0 },;
{"ITEM","C",4,0 },;
{"QUANTIDADE","N",12,3 },;
{"PRECO","N",18,2 },;
{"ENTREGA","D",8,0 }}
//{"TES","C",3,0 },;

cArqTrab2  := CriaTrab(aCampos2)
cIndice:="Descend(DTOS(EMISSAO))"
dbUseArea( .T.,, cArqTrab2, "LS2", if(.F. .OR. .F., !.F., NIL), .F. )
IndRegua("LS2",cArqTrab2,cIndice,,,)
dbSetIndex( cArqTrab2 +OrdBagExt())
dbSelectArea("LS2")

lAchou:=.f.
_nQuantXml:=LS1->QUANTIDADE

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Verificando pedidos em aberto										Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
cSeq:=LS1->SEQ
//cQuery:=" SELECT C7_EMISSAO EMISSAO,Case C7_MOEDA When 1 Then C7_PRECO When 2 Then C7_PRECO * C7_TXMOEDA End As PRECO,C7_ITEM ITEM,C7_NUM PEDIDO,(C7_QUANT-C7_QUJE-C7_QTDACLA) QUANTIDADE,C7_DATPRF ENTREGA FROM "+RetSqlName("SC7")+" WHERE C7_FILIAL='"+xFilial("SC7")+"' " //#ECV20121127.o
cQuery:=" SELECT C7_EMISSAO EMISSAO,Case C7_MOEDA When 1 Then C7_PRECO When 2 Then C7_PRECO * C7_TXMOEDA End As PRECO,C7_ITEM ITEM,C7_NUM PEDIDO,(C7_QUANT-C7_QUJE-C7_QTDACLA) QUANTIDADE,C7_DATPRF ENTREGA, C7_MOEDA MOEDA, C7_TXMOEDA TAXA  FROM "+RetSqlName("SC7")+" WHERE C7_FILIAL='"+xFilial("SC7")+"' " //#ECV20121127.n
cQuery:=cQuery + " AND C7_FORNECE='"+LS3->FORNEC+"' "
cQuery:=cQuery + " AND C7_LOJA='"+LS3->LOJA+"' "
cQuery:=cQuery + " AND C7_PRODUTO='"+LS1->PRODUTO+"' "
cQuery:=cQuery + " AND (C7_QUANT-C7_QUJE-C7_QTDACLA>0) "
cQuery:=cQuery + " AND D_E_L_E_T_<>'*' "
cQuery:=cQuery + " AND C7_RESIDUO<>'S' "
cQuery:=cQuery + " ORDER BY C7_EMISSAO DESC "
TCQUERY cQuery NEW ALIAS "TCQ"
DbSelectarea("TCQ")
While !Eof()
	
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Verificando saldos de produtos em uso								Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	_nUsados:=0
	DbSelectarea("LS1")
	Dbgotop()
	While !Eof()
		IF alltrim(LS1->PEDIDO)==TCQ->PEDIDO .AND. alltrim(LS1->ITEM)==TCQ->ITEM
			_nUsados:=(_nUsados+LS1->QUANTIDADE)
		Endif
		DbSelectarea("LS1")
		Dbskip()
	End
	
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Gravando pedidos em aberto											Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If (TCQ->QUANTIDADE-_nUsados)>0
		Reclock("LS2",.T.)
		IF (TCQ->QUANTIDADE-_nUsados)>=_nQuantXml
			LS2->OK     := "X"
		Endif
		LS2->EMISSAO    := STOD(TCQ->EMISSAO)
		LS2->PEDIDO     := TCQ->PEDIDO
		LS2->ITEM       := TCQ->ITEM
		//LS2->PRECO:=TCQ->PRECO //#ECV20121127.o
		LS2->PRECO      := IIF(TCQ->MOEDA <> 1 .And. TCQ->TAXA == 0, fCalcPrc(TCQ->PEDIDO,TCQ->ITEM),TCQ->PRECO) //#ECV20121127.n
		LS2->QUANTIDADE := (TCQ->QUANTIDADE-_nUsados) 
		//LS2->TES := TCQ->TES
		LS2->ENTREGA    := STOD(TCQ->ENTREGA)
		Msunlock()
		lAchou:=.T.
	Endif
	DbSelectarea("TCQ")
	Dbskip()
End
DbClosearea("TCQ")

DbSelectarea("LS1")
Dbgotop()
DbSeek(cSeq)

Dbselectarea("LS2")
Dbgotop()

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё aHeader dos pedidos													Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
aTitulo2 := {}
AADD(aTitulo2,{"EMISSAO","EmissЦo"})
AADD(aTitulo2,{"PEDIDO","Pedido"})
AADD(aTitulo2,{"ITEM","Item"})
AADD(aTitulo2,{"QUANTIDADE","DisponМvel","@E 999,999.999"})
//AADD(aTitulo2,{"TES","Tes"})
AADD(aTitulo2,{"PRECO","PreГo R$","@E 99,999,999.99"})
AADD(aTitulo2,{"ENTREGA","Dt.Entrega"})

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Tela dos itens														Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If lAchou
	@ 120,040 TO 440,550 DIALOG oPedido TITLE "Pedidos em aberto para o produto..."
	@ 005,005 say "Quantidade NecessАria "+Transform(LS1->QUANTIDADE,"@E 99,999.99")+"      PreГo R$ "+Transform(LS1->PRECO,"@E 99,999.99") FONT oFont1 OF oPedido PIXEL COLOR CLR_HRED
	@ 015,005 TO 140,255 BROWSE "LS2" ENABLE " LS2->OK<>'X' " OBJECT OBRWT FIELDS aTitulo2
	OBRWT:oBrowse:oFont := TFont():New ("Arial", 05, 18)
	OBRWT:OBROWSE:bLDblClick   := {||CONFPED()}
	//@ 145,005 BUTTON "Atualizar Pedido" SIZE 65,10 ACTION ATUPED()
	//@ 145,075 BUTTON "Eliminar do pedido" SIZE 65,10 ACTION ELIRPRO()
	ACTIVATE DIALOG oPedido CENTER
Else
	Msgbox("NЦo existem pedidos em aberto para este produto!","AtenГЦo...","ALERT")
	
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Gravando CRIAR nos produtos sem pedidos de compras em aberto		Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	cSeqOri:=LS1->SEQ
	DbSelectarea("LS1")
	Dbgotop()
	While !Eof()
		IF Empty(LS1->PEDIDO) .and. ALLTRIM(LS1->PRODUTO)<>"999999"
			cQuery:=" SELECT COUNT(*) QTD FROM "+RetSqlName("SC7")+" WHERE C7_FILIAL='"+xFilial("SC7")+"' "
			cQuery:=cQuery + " AND C7_FORNECE='"+LS3->FORNEC+"' "
			cQuery:=cQuery + " AND C7_LOJA='"+LS3->LOJA+"' "
			cQuery:=cQuery + " AND C7_PRODUTO='"+LS1->PRODUTO+"' "
			cQuery:=cQuery + " AND (C7_QUANT-C7_QUJE-C7_QTDACLA>0) "
			cQuery:=cQuery + " AND D_E_L_E_T_<>'*' "
			cQuery:=cQuery + " AND C7_RESIDUO<>'S' "
			TCQUERY cQuery NEW ALIAS "TCQ"
			DbSelectarea("TCQ")
			_lSemped:=TCQ->QTD
			DbClosearea("TCQ")
			
			If _lSemPed==0
				Reclock("LS1",.F.)
				LS1->PEDIDO:="CRIAR"
				LS1->ALTERADO:="S"
				MsUnlock()
			Endif
		Endif
		DbSelectarea("LS1")
		Dbskip()
	End
	
	DbSelectarea("LS1")
	Dbgotop()
	DbSeek(cSeqOri)
	
Endif
Dbselectarea("LS2")
dbCloseArea("LS2")
fErase( cArqTrab2+ ".DBF" )
fErase( cArqTrab2+ OrdBagExt() )

OBRWI:obrowse:refresh()
OBRWI:obrowse:setfocus()
ObjectMethod(oTela,"Refresh()")
Return
                 



//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Confirma Pedido 													Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function CONFPED()

If (LS1->QUANTIDADE>LS2->QUANTIDADE)
	Msgbox("NЦo existe saldo suficiente para atender este produto!","AtenГЦo...","ALERT")
	Reclock("LS1",.F.)
	LS1->PEDIDO:="CRIAR"
	LS1->ALTERADO:="S"
	MsUnlock()
	oPedido:end()
	Return
Endif

Reclock("LS1",.F.)
LS1->PEDIDO  :=LS2->PEDIDO
LS1->ITEM    :=LS2->ITEM    
//LS1->TES := LS2->TES     // ADICIONADO POR VALDEMIR 
LS1->ALTERADO :="S"
MsUnlock()

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Gravando o mesmo pedido para os outros itens						Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
cSeqori:=LS1->SEQ

DbSelectarea("LS1")
Dbgotop()
While !Eof()
	cSeq:=LS1->SEQ
	IF Empty(LS1->PEDIDO)
		cQuery:=" SELECT C7_ITEM ITEM,(C7_QUANT-C7_QUJE-C7_QTDACLA) QUANT FROM "+RetSqlName("SC7")+" WHERE C7_FILIAL='"+xFilial("SC7")+"' "
		cQuery:=cQuery + " AND C7_NUM='"+LS2->PEDIDO+"' "
		cQuery:=cQuery + " AND C7_PRODUTO='"+LS1->PRODUTO+"' "
		cQuery:=cQuery + " AND (C7_QUANT-C7_QUJE-C7_QTDACLA>0) "
		cQuery:=cQuery + " AND D_E_L_E_T_<>'*' "
		cQuery:=cQuery + " AND C7_RESIDUO<>'S' "
		cQuery:=cQuery + " ORDER BY C7_EMISSAO DESC "
		TCQUERY cQuery NEW ALIAS "TCQ"
		DbSelectarea("TCQ")
		While !Eof()
			
			//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Verificando saldos de produtos em uso								Ё
			//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			_nUsados:=0
			DbSelectarea("LS1")
			Dbgotop()
			While !Eof()
				IF alltrim(LS1->PEDIDO)==ALLTRIM(LS2->PEDIDO) .AND. alltrim(LS1->ITEM)==TCQ->ITEM
					_nUsados:=(_nUsados+LS1->QUANTIDADE)
				Endif
				DbSelectarea("LS1")
				Dbskip()
			End
			
			DbSelectarea("LS1")
			Dbgotop()
			DbSeek(cSeq)
			
			IF (LS1->QUANTIDADE<=(TCQ->QUANT-_nUsados))
				Reclock("LS1",.F.)
				LS1->PEDIDO:=LS2->PEDIDO
				LS1->ITEM:=TCQ->ITEM
				LS1->ALTERADO:="S"
				MsUnlock()
			Endif
			DbSelectarea("TCQ")
			Dbskip()
		End
		DbClosearea("TCQ")
	Endif
	DbSelectarea("LS1")
	Dbskip()
End

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Gravando CRIAR nos produtos sem pedidos de compras em aberto		Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
DbSelectarea("LS1")
Dbgotop()
While !Eof()
	IF Empty(LS1->PEDIDO)  .and. ALLTRIM(LS1->PRODUTO)<>"999999"
		cQuery:=" SELECT COUNT(*) QTD FROM "+RetSqlName("SC7")+" WHERE C7_FILIAL='"+xFilial("SC7")+"' "
		cQuery:=cQuery + " AND C7_FORNECE='"+LS3->FORNEC+"' "
		cQuery:=cQuery + " AND C7_LOJA='"+LS3->LOJA+"' "
		cQuery:=cQuery + " AND C7_PRODUTO='"+LS1->PRODUTO+"' "
		cQuery:=cQuery + " AND (C7_QUANT-C7_QUJE-C7_QTDACLA>0) "
		cQuery:=cQuery + " AND D_E_L_E_T_<>'*' "
		cQuery:=cQuery + " AND C7_RESIDUO<>'S' "
		TCQUERY cQuery NEW ALIAS "TCQ"
		DbSelectarea("TCQ")
		_lSemped:=TCQ->QTD
		DbClosearea("TCQ")
		
		If _lSemPed==0
			Reclock("LS1",.F.)
			LS1->PEDIDO:="CRIAR"
			LS1->ALTERADO:="S"
			MsUnlock()
		Endif
	Endif
	DbSelectarea("LS1")
	Dbskip()
End
DbSelectarea("LS1")
Dbgotop()
DbSeek(cSeqOri)

oPedido:end()
Return
                    



//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Eliminar pedido														Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function ELIMPED()

Reclock("LS1",.F.)
LS1->PEDIDO:=""
LS1->ITEM:=""
MsUnlock()

OBRWI:obrowse:refresh()
OBRWI:obrowse:setfocus()
ObjectMethod(oTela,"Refresh()")
Return

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Eliminar Todos														Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function ELIMPEDT()

cResp:=Msgbox("Deseja limpar todas as referЙncias de pedidos dos produtos da nota fiscal?","AtenГЦo...","YESNO")

If cResp
	DbSelectarea("LS1")
	Dbgotop()
	While !Eof()
		Reclock("LS1",.F.)
		LS1->PEDIDO:=""
		LS1->ITEM:=""
		MsUnlock()
		Dbskip()
	End
	DbSelectarea("LS1")
	Dbgotop()
Endif

OBRWI:obrowse:refresh()
OBRWI:obrowse:setfocus()
ObjectMethod(oTela,"Refresh()")
Return

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Eliminar pedido														Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function ELIRPRO()

cResp:=msgbox("Deseja eliminar o resМduo deste item do pedido "+LS2->PEDIDO+"?","AtenГЦo...","YESNO")

If cResp
	DbSelectarea("SC7")
	DbSetorder(1)
	dbgotop()
	Dbseek(xFilial("SC7")+LS2->PEDIDO)
	While !Eof() .and. ALLTRIM(SC7->C7_NUM)==ALLTRIM(LS2->PEDIDO)
		IF alltrim(SC7->C7_PRODUTO)==alltrim(LS1->PRODUTO) .AND. LS2->ITEM==SC7->C7_ITEM
			IF SC7->C7_QTDACLA>0
				Msgbox("Este produto estА sendo usado em prИ nota fiscal!","AtenГЦo...","ALERT")
				Return
			Endif
			
			IF SC7->C7_RESIDUO<>"S" .and. (SC7->C7_QUANT-SC7->C7_QUJE)>0
				Reclock("SC7",.F.)
				SC7->C7_RESIDUO:="S"
				MsUnlock()
				
				DbSelectarea("SB2")
				DbSetorder(2)
				Dbgotop()
				Dbseek(xFilial("SB2")+SC7->C7_LOCAL+SC7->C7_PRODUTO)
				If Found()
					Reclock("SB2",.F.)
					SB2->B2_SALPEDI:=(SB2->B2_SALPEDI-(SC7->C7_QUANT-SC7->C7_QUJE))
					MsUnlock()
				Endif
				//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Apagando pedido do browse											Ё
				//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				DbSelectarea("LS2")
				Reclock("LS2",.F.)
				dbdelete()
				MsUnlock()
				dbgotop()
				Msgbox("ResМduo eliminado com sucesso!","AtenГЦo...","INFO")
			Endif
		Endif
		DbSelectarea("SC7")
		Dbskip()
	End
Endif
Return

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//| Alterar Pedido												 |
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Static Function ATUPED()

IF LS1->QUANTIDADE<=LS2->QUANTIDADE
	Msgbox("NЦo И necessАrio atualizar este pedido!","AtenГЦo...","ALERT")
	Return
Endif

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Ajustando o pedido com a nota										Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
cResp:=msgbox("Deseja atualizar o pedido "+LS2->PEDIDO+" com a quantidade que falta?","AtenГЦo...","YESNO")

If cResp
	lEntrou:=.F.
	_nQtdIt:=0
	
	DbSelectarea("SC7")
	DbSetorder(4)
	Dbgotop()
	Dbseek(xFilial("SC7")+LS1->PRODUTO+LS2->PEDIDO+LS2->ITEM)
	If Found() .AND. (SC7->C7_QUANT-SC7->C7_QUJE-SC7->C7_QTDACLA)<LS1->QUANTIDADE
		_nTotal:=LS1->QUANTIDADE-(SC7->C7_QUANT-SC7->C7_QUJE-SC7->C7_QTDACLA)
		
		Reclock("SC7",.F.)
		SC7->C7_QUANT:=(SC7->C7_QUANT+_nTotal)
		SC7->C7_OBS:="ALTERADO NF-ELETRONICA"
		MsUnlock()
		
		Reclock("SC7",.F.)
		SC7->C7_TOTAL:=(SC7->C7_QUANT*SC7->C7_PRECO)
		MsUnlock()
		
		If Empty(cAlmox)
			cAlmox:=Posicione("SB1",1,xFilial("SB1")+LS1->PRODUTO,"B1_LOCPAD")
		Endif
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Atualizado SB2 saldo de pedidos										Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		DbSelectarea("SB2")
		DbSetorder(2)
		Dbgotop()
		Dbseek(xFilial("SB2")+cAlmox+LS1->PRODUTO)
		If Found()
			Reclock("SB2",.F.)
			SB2->B2_SALPEDI:=(SB2->B2_SALPEDI+_nTotal)
			MsUnlock()
		Endif
		lEntrou:=.T.
	Endif
	
	If lEntrou
		Msgbox("Pedido atualizado com sucesso!","AtenГЦo...","INFO")
		Reclock("LS2",.F.)
		LS2->QUANTIDADE:=LS1->QUANTIDADE
		LS2->OK:="X"
		Msunlock()
	Endif
Endif
DbSelectarea("LS2")
Return

//---------------------------------------------------------------------------------------------------------------------------------------------------------
//---------------------------------------------------------------------------------------------------------------------------------------------------------
//---------------------------------------------------------------------------------------------------------------------------------------------------------
//---------------------------------------------------------------------------------------------------------------------------------------------------------

//funcao responsАvel de quebrar os itens nos lotes informados pelo usuario
Static Function FS_INCLT()
Local cLoteFor := ''
//Local cItem := '' 
//Local cItemPc := ''
Local cLocal := ''
private aProLt := {}
If Type("__xPedido") == "U"
	__xPedido := ''
EndIf

//incluido dialog para quebrar itens em vАrios lotes e informar a tes e condicao pagamento
DbSelectArea("SB1")
DbSetOrder(1)
DbSelectarea("LS1")
DbSetorder(1)
Dbgotop()
While !Eof()          	
	SB1->(DbSeek(xFilial("SB1"+LS1->PRODUTO)))
	cLoteFor := IIF(AllTrim(SB1->B1_RASTRO) <> "L","X",LS1->LOTEFOR)  	  	  	  		                           
  	//cItem := IIF(Empty(LS1->ITEM),Strzero(Val(cItem)+1,4),LS1->ITEM)  	
  	cLocal := IIF(Empty(LS1->ALMOX),SB1->B1_LOCPAD,LS1->ALMOX)  		
	aadd(aProLt,{LS1->PRODUTO,LS1->QUANTIDADE,LS1->PEDIDO,LS1->ITEM,LS1->PRECO,LS1->TOTAL,LS1->DESCONTO,LS1->ALMOX,LS1->ITEM,cLoteFor,CToD("  /  /  ")})
	DbSelectarea("LS1")
	Dbskip()
End
cQuere:="SELECT C7_COND as CONDP ,C7_TES AS TESS  FROM "+RetSqlName("SC7")+" WHERE C7_FILIAL='"+xFilial("SC7")+"' AND C7_NUM='"+__xPedido+"' AND D_E_L_E_T_<>'*' "
TCQUERY cQuere NEW ALIAS "TCQX"
DbSelectarea("TCQX")
If !Eof()
	__cTES := TCQX->TESS
	__Cond :=  TCQX->CONDP
	
EndIf
DbClosearea("TCQX")

DEFINE MSDIALOG oLtInfo FROM 0,0 TO 300,500 PIXEL TITLE "Inclusao de Lotes"
@ 016,005 say "TES: " SIZE 150,40 OF oLtInfo PIXEL COLOR CLR_HBLUE
@ 016,040 MSGET __oTES VAR __cTES F3 "SF4" SIZE 040,010  FONT oFont6 PIXEL OF oLtInfo	when .t.
@ 028,005 say "Cond. pagto.: " SIZE 150,40 OF oLtInfo PIXEL COLOR CLR_HBLUE
@ 028,040 MSGET __oCond VAR __Cond SIZE 040,010  F3 "SE4" FONT oFont6 PIXEL OF oLtInfo	when .t.

//Produtos para informar os lotes
@ 043,004 LISTBOX oProLt FIELDS HEADER  OemToAnsi("Produto"),OemToAnsi("Qtde."),OemToAnsi("Lote"),;
OemToAnsi("Validade");
COLSIZES 80,30,50, 30;
SIZE 245,90 OF oLtInfo ON DBLCLICK (FS_QUELOT(oProLt:nAt)) PIXEL

oProLt:SetArray(aProLt)
oProLt:bLine := { || { 	    aProLt[oProLt:nAt,1] ,;
aProLt[oProLt:nAt,2] ,;
IIF(aProLt[oProLt:nAt,10]=="X"," ",aProLt[oProLt:nAt,10]),;
aProLt[oProLt:nAt,11]}}
//todo, obrigar a digitar um lote
ACTIVATE MSDIALOG oLtInfo ON INIT EnchoiceBar(oLtInfo,{|| If(FS_CONFRV(),oLtInfo:End(),.t.)  },{||  (oLtInfo:End(),.f.) }) CENTER

Return .t.
               

Static Function FS_CONFRV()
Local _ni:=1
//validar se todos lotes foram imformados e gravar o codigo da TES
For _ni := 1 to len(aProLt)
	If Empty(aProLt[_ni,10])
		MsgStop("Informar todos os lotes antes de continuar","Atencao")
		Return .f.
	EndIF
next

//gravar a informacao no array para gerar NF
For _ni := 1 to len(aProLt)  
	aTemp:={}
	//aadd(aProLt,{LS1->PRODUTO,LS1->QUANTIDADE,LS1->PEDIDO,LS1->ITEM,LS1->PRECO,LS1->TOTAL,LS1->DESCONTO,LS1->ALMOX,LS1->ITEM,LS1->LOTECTL })
	aadd(aTemp,{"D1_COD" ,aProLt[_ni,1],Nil})
	aadd(aTemp,{"D1_QUANT",aProLt[_ni,2],Nil})
	If !Empty(aProLt[_ni,3])
		aadd(aTemp,{"D1_PEDIDO",aProLt[_ni,3],Nil})
		aadd(aTemp,{"D1_ITEMPC",aProLt[_ni,4],Nil})
	EndIf
	aadd(aTemp,{"D1_VUNIT",aProLt[_ni,5],Nil})
	aadd(aTemp,{"D1_TOTAL",aProLt[_ni,6],Nil})
	aadd(aTemp,{"D1_VALDESC",aProLt[_ni,7],Nil})
	aadd(aTemp,{"D1_LOCAL",aProLt[_ni,8],Nil})
	//aadd(aTemp,{"D1_LOTECTL",aProLt[_ni,10],Nil})	
	If aProLt[_ni,10] <> "X"                      
		aadd(aTemp,{"D1_LOTECTL",aProLt[_ni,10],Nil}) 
		aadd(aTemp,{"D1_LOTEFOR",aProLt[_ni,10],Nil})
		aadd(aTemp,{"D1_DTVALID",aProLt[_ni,11],Nil})
	EndIf
	aadd(aItens,aTemp)
next

Return .t.

//---------------------------------------------------------------------------------------------------------------------------------------------------------
//---------------------------------------------------------------------------------------------------------------------------------------------------------
//---------------------------------------------------------------------------------------------------------------------------------------------------------
//---------------------------------------------------------------------------------------------------------------------------------------------------------
//querba de lote
Static Function FS_QUELOT(clinha)//quebra de lotes
Private cQtdLote := space(20)
Private cLtQubr := space(len(SD1->D1_LOTEFOR))
Private aNewLote:={}
Private nQtd :=aProLt[clinha,2]
Private dValid := CToD("  /  /  ")

If aProLt[clinha,10] == "X"
	MsgAlert("O Produto "+AllTrim(aProLt[clinha,1])+" nЦo estА habilitado para Rastro!")
	Return
EnDif

aAdd(aNewLote,{ " " , " " , " "," "})

DEFINE MSDIALOG oQbrLt FROM 0,0 TO 300,530 PIXEL TITLE "..:: Informe os lotes ::.."

@ 016,005 say "Produto: " SIZE 150,40 OF oQbrLt PIXEL COLOR CLR_HBLUE
@ 016,040 GET _oPro VAR aProLt[clinha,1] SIZE 040,010 FONT oFont6 PIXEL OF oQbrLt	when .f.
@ 028,005 say "Qtd.: "+Alltrim(Str(aProLt[clinha,2])) SIZE 150,40 OF oQbrLt PIXEL COLOR CLR_HBLUE
@ 028,040 GET _oQtd VAR Alltrim(str(nQtd)) SIZE 040,010 FONT oFont6 PIXEL OF oQbrLt	when .f.

@ 016,085 say "Qtd Lote " SIZE 150,40 OF oQbrLt PIXEL COLOR CLR_HBLUE
@ 026,085 GET oQtdLote VAR cQtdLote SIZE 040,010 FONT oFont6 PIXEL OF oQbrLt

@ 016,125 say "Num. Lote" SIZE 150,40 OF oQbrLt PIXEL COLOR CLR_HBLUE
@ 026,125 GET oLtQubr VAR cLtQubr SIZE 050,010 FONT oFont6 PIXEL OF oQbrLt

@ 016,175 say "Validade" SIZE 150,40 OF oQbrLt PIXEL COLOR CLR_HBLUE
@ 026,175 GET oDtValid VAR dValid Valid(IIF(dValid < dDataBase,(Alert("NЦo И permitido digitar a data de validade inferior Ю data atual!"),.F.),.T.));
SIZE 050,010 FONT oFont6 PIXEL OF oQbrLt

@ 016,230 BUTTON oInlcui PROMPT OemToAnsi("Incluir") OF oQbrLt SIZE 30,11 PIXEL ACTION (FS_INCITEM(clinha))
@ 028,230 BUTTON oExclui PROMPT OemToAnsi("Excluir") OF oQbrLt SIZE 30,11 PIXEL ACTION (FS_DELITEM(oProQT:nAt))

//Produtos para informar os lotes
@ 050,004 LISTBOX oProQT FIELDS HEADER  OemToAnsi("Produto"),OemToAnsi("Qtde."),OemToAnsi("Lote"),OemToAnsi("Validade"),;
COLSIZES 90,20,60,30 SIZE 250,95 OF oQbrLt PIXEL

oProQT:SetArray(aNewLote)
oProQT:bLine := { || { 	    aNewLote[oProQT:nAt,1] ,;
Transform(aNewLote[oProQT:nAt,2],"@E 999,999,999") ,;
aNewLote[oProQT:nAt,3],;
aNewLote[oProQT:nAt,4] }}

ACTIVATE MSDIALOG oQbrLt ON INIT EnchoiceBar(oQbrLt,{|| Iif(FS_VALQTD(clinha),oQbrLt:End(),.f.)  },{||  oQbrLt:End() }) CENTER

return

//---------------------------------------------------------------------------------------------------------------------------------------------------------
//---------------------------------------------------------------------------------------------------------------------------------------------------------
//---------------------------------------------------------------------------------------------------------------------------------------------------------
//---------------------------------------------------------------------------------------------------------------------------------------------------------

//inclui lote no list
Static Function FS_INCITEM(clinha)
//verifica se И o primeiro e apaga a linha em branco
IF len(aNewLote)=1
	If empty(aNewLote[1,1])
		aNewLote:={}
	EndIF
EndIF

aAdd(aNewLote,{  aProLt[clinha,1] , val(cQtdLote) ,  cLtQubr, dValid })

If Len(aNewLote) <= 0
	aAdd(aNewLote,{ " " , " " , " "," "  })
EndIF

oProQT:SetArray(aNewLote)
oProQT:bLine := { || { aNewLote[oProQT:nAt,1] ,;
Transform(aNewLote[oProQT:nAt,2],"@E 999,999,999") ,;
aNewLote[oProQT:nAt,3],;
aNewLote[oProQT:nAt,4]}}

cQtdLote := space(20)
cLtQubr := space(len(SD1->D1_LOTEFOR))
dValid := CToD("  /  /  ")
nQtd:= nQtd-val(cQtdLote)
_oQtd:Refresh()
oQtdLote:Refresh()
oLtQubr:Refresh()
oDtValid:Refresh()

Return


///////////////////////////////////////////
//\\\\\\\\\ DELETA ITEM NO ARAY  //////////
///////////////////////////////////////////
Static Function FS_DELITEM(nlinha)

aDel(aNewLote,nlinha)
ASize(aNewLote, Len(aNewLote)-1)

If Len(aNewLote) <= 0
	aAdd(aNewLote,{ " " , " " , " ", "" })
	
EndIF
nQtd:= nQtd-val(cQtdLote)
_oQtd:Refresh()

Return

//---------------------------------------------------------------------------------------------------------------------------------------------------------
//---------------------------------------------------------------------------------------------------------------------------------------------------------
//---------------------------------------------------------------------------------------------------------------------------------------------------------
//---------------------------------------------------------------------------------------------------------------------------------------------------------

//valida a quantidade de itens no lote se И = a total se for grava no LS1
Static Function FS_VALQTD(clinha)
Local _ni := 1
Local nQteTotal :=0
For _ni:=1 to len(aNewLote)
	nQteTotal += aNewLote[_ni,2]
Next

If nQteTotal< aProLt[oProLt:nAt,2] .or. nQteTotal>aProLt[oProLt:nAt,2]
	Msginfo("Quantidade total do lote nЦo confere.","AtenГЦo")
	Return .f.
EndiF

//deleta a linha para incluir com os lotes

//todo verificar valor total e desconto
For _ni:=1 to len(aNewLote)
	aadd(aProLt,{aNewLote[_ni,1],aNewLote[_ni,2],aProLt[clinha,3],aProLt[clinha,4],aProLt[clinha,5],;
	/*aProLt[clinha,6]*/(aNewLote[_ni,2]*aProLt[clinha,5]),((aProLt[clinha,7]/aProLt[clinha,2])*aNewLote[_ni,2]),aProLt[clinha,8],aProLt[clinha,9],aNewLote[_ni,3],aNewLote[_ni,4] })
	
Next
aDel(aProLt,clinha)
ASize(aProLt, Len(aProLt)-1)


If Len(aProLt) <= 0
	aAdd(aProLt,{ " " , " " , " " , " " , " " , " " , " " , " " , " " , " ", " "  })
EndIF
oProLt:Refresh()

Return .t.


//Grava as informacoes F1_COND e D1_TES e exibe a nf para classificar
Static Function FS_EXINF()
//necessario para chamar a tela da NF para ser classificada
Local aMenu := {}
PRIVATE aRotina 	:= {}

aAdd(aMenu,{OemToAnsi("Pesquisar"), "AxPesqui"   , 0 , 1, 0, .F.}) 		//"Pesquisar"
aAdd(aMenu,{OemToAnsi("Visualizar"), "A103NFiscal", 0 , 2, 0, nil}) 		//"Visualizar"
aAdd(aMenu,{OemToAnsi("Incluir"), "A103NFiscal", 0 , 3, 0, nil}) 		//"Incluir"
aAdd(aMenu,{OemToAnsi("Classificar"), "A103NFiscal", 0 , 4, 0, nil}) 		//"Classificar"

aRotina 	:= aMenu

DbSelectArea("SF1")
DbSetOrder(1)
if DbSeek(xFilial("SF1")+cNotaAtu)
	Reclock("SF1",.F.)
	SF1->F1_COND:=__Cond
	MsUnlock()
	DbSelectArea("SD1")
	DbSetOrder(1)
	If DbSeek(xFilial("SD1")+SF1->F1_DOC+SF1->F1_SERIE+SF1->F1_FORNECE+SF1->F1_LOJA)
		While !eof() .and. SF1->F1_DOC+SF1->F1_SERIE+SF1->F1_FORNECE+SF1->F1_LOJA==SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA
			Reclock("SD1",.F.)
			SD1->D1_TES:=__cTES
			MsUnlock()
			DbSelectArea("SD1")
			DbSkip()
		End
	EndiF
	//abre a Nf para ser classificada
	//	INCLUI := .F.
	//	ALTERA := .T.
	//	A103NFiscal("SF1",SF1->( Recno() ),4)
	MATA103()	
else	
	Msgstop("Nota Fiscal nЦo encontrada.","Atencao")
EndIF
//cNotaAtu

Return .t.

//consulta fazenda
Static Function FS_CONSER(cChave)
Local nOpc := 0
Private __Chave := cChave

DEFINE MSDIALOG oChavCon FROM 0,0 TO 110,520 PIXEL TITLE "..:: Chave Fazenda ::.."

@ 016,005 say "Chave para consulta: " SIZE 150,40 OF oChavCon PIXEL COLOR CLR_HBLUE
@ 016,055 GET _oChavee VAR __Chave SIZE 140,010 FONT oFont6 PIXEL OF oChavCon	when .t.

ACTIVATE MSDIALOG oChavCon ON INIT EnchoiceBar(oChavCon,{|| Iif(MsgYesNo("Nota Aprovada?","Atencao"),oChavCon:End(),(oChavCon:End(),nOpc := 1))  },{|| (oChavCon:End(),nOpc := 1) }) CENTER
IF nOpc = 1
	Return .f.
EndIF

Return .t.

Static Function xMaCom()

aRotina := {{"","",0,0},{"","",0,0}}

If ALLTRIM(LS1->PRODUTO)=="999999"
	Msgbox("Favor identificar o produto primeiro!","AtenГЦo...","ALERT")
	OBRWI:obrowse:refresh()
	OBRWI:obrowse:setfocus()
	ObjectMethod(oTela,"Refresh()")
	Return
Else
	MACOMVIEW(LS1->PRODUTO)
EndIf

Return


Static Function GeraPre()

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Manipulando numero da nota fiscal									Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If cZeros
	cNota:=strzero(val(cNota),9)
Endif
cSpaco:=9-len(alltrim(cNota))
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Verifico se a pre nota ja existe									Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
dbSelectArea("SF1")
DbSetorder(2)
Dbgotop()
Dbseek(xFilial("SF1")+LS3->FORNEC+LS3->LOJA+alltrim(cNota)+Space(cSpaco))
If Found() .and. SF1->F1_TIPO=="N"
	
	Msgbox("Nota fiscal jА existe!","AtenГЦo...","ALERT")
	FRename("\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\"+ALLTRIM(LS3->XML),"\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\"+ALLTRIM(LS3->XML)+".imp")
	__CopyFile("\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\*.imp","\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\importados\")
	ferase("\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\"+ALLTRIM(LS3->XML)+".imp")
	
	Reclock("LS3",.F.)
	dbdelete()
	MsUnlock()
	
	DbSelectarea("LS3")
	Dbgotop()
	
	DbSelectarea("LS1")
	Dbsetorder(1)
	Dbgotop()
	While !Eof()
		Reclock("LS1",.F.)
		dbdelete()
		MsUnlock()
		Dbskip()
	End
	
	DbSelectarea("LS5")
	Dbsetorder(1)
	Dbgotop()
	While !Eof()
		Reclock("LS5",.F.)
		dbdelete()
		MsUnlock()
		Dbskip()
	End
	
	PROCESS()
	Return
Endif
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Gravando pre nota entrada											Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
SEFAZ()
If !FS_CONSER(LS3->CHAVE)
	Return
Endif

MsgRun("Gerando prИ nota entrada No.:"+cNota,,{||PRENOTA()})
cNotaAtu:=cNota

If cRet
	DbSelectarea("LS1")
	Dbsetorder(1)
	Dbgotop()
	While !Eof()
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Gravando amarracao produto x fornecedor								Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If !Empty(LS1->PRODFOR)
			DbSelectarea("SA5")
			DbSetorder(1)
			Dbgotop()
			Dbseek(xFilial("SA5")+LS3->FORNEC+LS3->LOJA+LS1->PRODUTO)
			If !Found()
				Reclock("SA5",.T.)
				SA5->A5_FILIAL:=xFilial("SA5")
				SA5->A5_FORNECE:=LS3->FORNEC
				SA5->A5_LOJA:=LS3->LOJA
				SA5->A5_CODPRF:=LS1->PRODFOR
				SA5->A5_PRODUTO:=LS1->PRODUTO
				SA5->A5_NOMPROD:=SUBSTR(POSICIONE("SB1",1,xFilial("SB1")+LS1->PRODUTO,"B1_DESC"),1,30)
				SA5->A5_NOMEFOR:=POSICIONE("SA2",1,xFilial("SA2")+LS3->FORNEC+LS2->LOJA,"A2_NREDUZ")
				MsUnlock()
			Else
				Reclock("SA5",.F.)
				SA5->A5_CODPRF:=LS1->PRODFOR
				MsUnlock()
			Endif
		Endif
		DbSelectarea("LS1")
		Reclock("LS1",.F.)
		dbdelete()
		MsUnlock()
		Dbskip()
	End
	
	DbSelectarea("LS3")
	FRename("\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\"+ALLTRIM(LS3->XML),"\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\"+ALLTRIM(LS3->XML)+".imp")
	__CopyFile("\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\*.imp","\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\importados\")
	ferase("\XML\EMP_"+cEmpAnt+"\"+cFilAnt+"\"+ALLTRIM(LS3->XML)+".imp")
	
	Reclock("LS3",.F.)
	dbdelete()
	MsUnlock()
	
	DbSelectarea("LS3")
	Dbgotop()
	Msgbox("PrИ-Nota "+cNotaAtu+" gerada com sucesso!","AtenГЦo...","INFO")
	FS_EXINF()
	PROCESS()
Endif

Return           

//Static Function fDig()   
//Return 



/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммммммяммммммммммкмммммммяммммммммммммммммммммкммммммяммммммммммммм╩╠╠
╠╠╨Programa  Ё fCalcPrc ╨Autor  ЁEduardo Cseh Vasques╨ Data Ё  27/11/12   ╨╠╠
╠╠лммммммммммьммммммммммймммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc.     ЁRotina que calcula o preco unitario do item do pedido de    ╨╠╠
╠╠╨          Ёcompras com base na data de emissao da NF em questao.       ╨╠╠
╠╠хммммммммммомммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/                                                                           

Static Function fCalcPrc(_cPedido,_cItem)
              
Local _nPreco	:= 0
Local _aAreaC7	:= SC7->(GetArea())
Local _aAreaM2	:= SM2->(GetArea())
Local _cVar		:= ""
Local _nTaxa	:= 0

SC7->(dbSetOrder(1)) //C7_FILIAL + C7_NUM + C7_ITEM
If SC7->(dbSeek(xFilial("SC7")+_cPedido+_cItem))
		
	SM2->(dbSetOrder(1)) //Dtos(M2_DATA)
	If SM2->(dbSeek(cEmissao)) //Caso encontre a data da emissao da NF
    	
    	_cVar	:= "SM2->M2_MOEDA"+Str(SC7->C7_MOEDA,1)
    	_nTaxa	:= &_cVar 
    	_nPreco := SC7->C7_PRECO * _nTaxa
    	
 	EndIf
 	
EndIf

RestArea(_aAreaC7)
RestArea(_aAreaM2)

Return _nPreco




/*/
ээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    ЁB103NFORIЁ Autor Ё Valdemir Jose         Ё Data Ё20.02.2013Ё╠╠
╠╠цддддддддддедддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁFaz a chamada da Tela de Consulta a NF original            Ё╠╠
╠╠цддддддддддеддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso      ЁCopia do MATA103                                           Ё╠╠
╠╠юддддддддддаддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
Static Function B103NFORI()

Local bSavKeyF4 := SetKey(VK_F4,Nil)
Local bSavKeyF5 := SetKey(VK_F5,Nil)
Local bSavKeyF6 := SetKey(VK_F6,Nil)
Local bSavKeyF7 := SetKey(VK_F7,Nil)
Local bSavKeyF8 := SetKey(VK_F8,Nil)
Local bSavKeyF9 := SetKey(VK_F9,Nil)
Local bSavKeyF10:= SetKey(VK_F10,Nil)
Local bSavKeyF11:= SetKey(VK_F11,Nil)
Local nPosCod	:= aScan(aHeader,{|x| AllTrim(x[1])=='PRODUTO'})  // D1_COD
Local nPosLocal := aScan(aHeader,{|x| AllTrim(x[1])=='LOCAL'})    // D1_LOCAL
Local nPosTes	:= aScan(aHeader,{|x| AllTrim(x[1])=='TES'})      // D1_TES
Local nPLocal	:= aScan(aHeader,{|x| AllTrim(x[1])=='LOCAL'})    // D1_LOCAL
Local nPosOP 	:= aScan(aHeader,{|x| AllTrim(x[1])=='OP'})       // D1_OP
Local nRecSD1   := 0
Local nRecSD2   := 0                      
Local nX		:= 0
Local nY		:= 0
Local lContinua := .T.     
//Local n         := OBRWI:oBROWSE:nAT  
Local aTitles   := {}        
Local aFldCBAtu	:= {}
                    
// foi alterado por causa do SIGAGSP.
aAdd(aTitles, OemToAnsi("Totais")) //
aAdd(aTitles, OemToAnsi("Inf. Fornecedor/Cliente")) //
aAdd(aTitles, OemToAnsi("Descontos/Frete/Despesas")) //
aAdd(aTitles, OemToAnsi("Livros Fiscais")) //
aAdd(aTitles, OemToAnsi("Impostos")) //
aAdd(aTitles, OemToAnsi("Duplicatas")) //

aFldCBAtu	:= Array(Len(aTitles)) // foi alterado por causa do SIGAGSP.


PRIVATE bRefresh	:= {|nX| NfeFldChg(nX,nY,,aFldCBAtu)}  
PUBLIC  n           := OBRWI:oBROWSE:nAT 
                 
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Impede de executar a rotina quando a tecla F3 estiver ativa		    Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If Type("InConPad") == "L"
	lContinua := !InConPad
EndIf

If lContinua                                                                           
	

	DbSelectArea("SF4")
	DbSetOrder(1)
	MsSeek(xFilial("SF4")+LS1->TES)       // aCols[n]:_cTES:TEXT

	If MaFisFound("NF") .And. Empty(Readvar())
		Do Case
		Case cTipo =="D" .And. SF4->F4_PODER3=="N"
			If F4NFORI(,,"M->D1_NFORI",cA100For,cLoja,LS1->PRODUTO,"A100",LS1->ALMOX,@nRecSD2) .And. nRecSD2<>0
				NfeNfs2Acols(nRecSD2,n)
			EndIf
		Case cTipo$"CPI"
			If F4COMPL(,,,cA100For,cLoja,LS1->PRODUTO,"A100",@nRecSD1,"M->D1_NFORI") .And. nRecSD1<>0
				NfeNfe2ACols(nRecSD1,n)
			EndIf
		Case cTipo$"NB" .And. SF4->F4_PODER3=="D"
			If cPaisLoc=="BRA"
				If F4Poder3(LS1->PRODUTO,LS1->ALMOX,cTipo,"E",cA100For,cLoja,@nRecSD2,SF4->F4_ESTOQUE) .And. nRecSD2<>0
					NfeNfs2Acols(nRecSD2,n)
					If nPosOp > 0 .And. cTipo == "N" .And. SD4->(FieldPos("D4_NUMPVBN")) > 0
                        If Empty(aCols[n][nPosOp])
							aCols[n][nPosOp] := A103OPBen()
                        EndIf 
					EndIf
				EndIf
			Else
				If A440F4("SB6",LS1->PRODUTO,LS1->ALMOX,"B6_PRODUTO","E",cA100For,cLoja,.F.,.F.,@nRecSD2,IIF(cTipo=="N","F","C")) > 0
					NfeNfs2Acols(nRecSD2,n)
				EndIf
			EndIf		
		OtherWise
			If Empty(LS1->PRODUTO) .Or. Empty(LS1->TES)
				Help('   ',1,'A103TPNFOR')
			ElseIf cTipo == "D" .And. SF4->F4_PODER3 <> "N"	
				Help('   ',1,'A103TESNFD')
			ElseIf cTipo$"NB" .And. SF4->F4_PODER3 <> "D"	
				Help('   ',1,'A103TESNFB')
			EndIf
		EndCase
	Else
		Help('   ',1,'A103CAB')
	EndIf
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё PNEUAC - Ponto de Entrada,gravar na coluna Lote o numero baseado na nf Original       Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If ExistBlock("PNEU002")
		ExecBlock("PNEU002",.F.,.F.)
	EndIf

Endif

SetKey(VK_F4,bSavKeyF4)
SetKey(VK_F5,bSavKeyF5)
SetKey(VK_F6,bSavKeyF6)
SetKey(VK_F7,bSavKeyF7)
SetKey(VK_F8,bSavKeyF8)
SetKey(VK_F9,bSavKeyF9)
SetKey(VK_F10,bSavKeyF10)
SetKey(VK_F11,bSavKeyF11)
// Atualiza valores na tela
Eval(bRefresh)
Return .T.


      

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммммммяммммммммммкмммммммяммммммммммммммммммммкммммммяммммммммммммм╩╠╠
╠╠╨Programa  ЁLERXML    ╨Autor  ЁValdemir Jose       ╨ Data Ё  22/02/13   ╨╠╠
╠╠лммммммммммьммммммммммймммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc.     Ё Carrega Arquivo XML de Retorno de Armazem, DevoluГЦo de    ╨╠╠
╠╠╨          Ё Compras, DevoluГЦo de Trocas                               ╨╠╠
╠╠лммммммммммьмммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╧╠╠
╠╠╨Uso       Ё CCAB                                                       ╨╠╠
╠╠хммммммммммомммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC Function ExecSelecao(npSelecao) 
Local aXML 			:= {}                                           
Local cDirDoMonitor := SuperGetMV('ES_DEV_ARMZ',.F.,'C:\MICROSOFT')
Local _cDIRXML, _cDESTXML

aCampos4:= {{"NOTA","C",9,0 },;
{"FORNECEDOR","C",6,0 },;
{"LOJA","C",2,0 }}
  
if select('LS4')=0
  cArqTrab4  := CriaTrab(aCampos4)
  dbUseArea( .T.,, cArqTrab4, "LS4", if(.F. .OR. .F., !.F., NIL), .F. )
  IndRegua("LS4",cArqTrab4,"FORNECEDOR+LOJA+NOTA",,,)
  dbSetIndex( cArqTrab4 +OrdBagExt())
endif

dbSelectArea("LS4")

// Selecione o Arquivo a Importar
IF     npSelecao = 1
   _cDIRXML := _cLocal+"\"
   _cDESTXML:= "\XML\EMP_"+_cEmpCorr+"\"+_cCorrente+"\"
elseif npSelecao = 2
   _cDIRXML := _cLocal+"\RET_ARMZ"
   _cDESTXML:= "\XML\EMP_"+_cEmpCorr+"\"+_cCorrente+"\RET_ARMZ\"
elseif npSelecao = 3
   _cDIRXML := _cLocal+"\DEV_COMPRAS"
   _cDESTXML:= "\XML\EMP_"+_cEmpCorr+"\"+_cCorrente+"\DEV_COMPRAS\"
else
   _cDIRXML := _cLocal+"\DEV_TROCA\"
   _cDESTXML:= "\XML\EMP_"+_cEmpCorr+"\"+_cCorrente+"\DEV_TROCA\"
endif                  

xSel := .T.

// Verificando arquivos da pasta local
aXML:={}
ADir(_cDIRXML+"\*.XML",aXML)

// Zera tabelas
dbSelectArea('LS1')
Zap
dbSelectArea('LS3')
Zap

//Copiando para Pasta Destino do Servidor
For i:=1 to len(aXML) 
	CpyT2S(_cDIRXML+"\"+aXML[i], _cDESTXML+"\", .T.)   
    ferase(_cDIRXML+"\"+lower(ALLTRIM(aXML[i]))) 
Next                       

// Carregando arquivos do servidor que ainda nЦo foram importados
aXML:={}
ADir(_cDESTXML+"\*.XML",aXML)

// Carrega variavel de memoria
cCamSel := _cDESTXML
cCamLoc := _cDIRXML    
                                             
// Valida arquivos XML
ValidaMoveXML('M',_cDIRXML, _cDESTXML)
                 
// Salva XML em arquivos temporarios
SalveReg(npSelecao, aXML, _cDESTXML)
                       
CORRIGE()

OBRWI:obrowse:refresh()
OBRWI:obrowse:nAt := 1
OBRWP:obrowse:refresh()
OBRWP:obrowse:nAt := 1
ObjectMethod(oTela,"Refresh()")

Return





/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммммммяммммммммммкмммммммяммммммммммммммммммммкммммммяммммммммммммм╩╠╠
╠╠╨Programa  ЁLERXML    ╨Autor  ЁVALDEMIR JOSE       ╨ Data Ё  22/02/13   ╨╠╠
╠╠лммммммммммьммммммммммймммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc.     Ё Verifica as pastas e subpastas para os arquivos XML        ╨╠╠
╠╠╨          Ё Caso nЦo exista ele cria                                   ╨╠╠
╠╠лммммммммммьмммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╧╠╠
╠╠╨Uso       Ё AP                                                         ╨╠╠
╠╠хммммммммммомммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Static Function ValidEmpresas()
	Local aArea   := GetArea()
	Local _cEmp   := ''   
	Local nResult := 0                       
	
	MAKEDIR("C:\Microsiga")

	dbSelectArea('SM0')
	dbGotop()
	While !Eof()    
	   _cEmp := SM0->M0_CODIGO
	   if !EXISTDIR("C:\Microsiga\EMP_"+_cEmp)   
	    	nResult := MAKEDIR("C:\Microsiga\EMP_"+_cEmp)
	   Endif                                               
		While !Eof() .And. (_cEmp = SM0->M0_CODIGO)
	                  
		    cPath := "C:\Microsiga\EMP_"+_cEmp+"\"+SM0->M0_CODFIL
		    if !EXISTDIR(cPath)   
		    	nResult := MakeDir(cPath)
		    Endif 
		    cPath := "C:\Microsiga\EMP_"+_cEmp+"\"+SM0->M0_CODFIL+"\duplicados"
		    if !EXISTDIR(cPath)   
		    	nResult := MakeDir(cPath)
		    Endif 
		    cPath := "C:\Microsiga\EMP_"+_cEmp+"\"+SM0->M0_CODFIL+"\corrompidos"
		    if !EXISTDIR(cPath)   
		    	nResult := MakeDir(cPath)
		    Endif 
		    cPath := "C:\Microsiga\EMP_"+_cEmp+"\"+SM0->M0_CODFIL+"\importados"
		    if !EXISTDIR(cPath)   
		    	nResult := MakeDir(cPath)
		    Endif 
		    cPath := "C:\Microsiga\EMP_"+_cEmp+"\"+SM0->M0_CODFIL+"\recusadas"
		    if !EXISTDIR(cPath)   
		    	nResult := MakeDir(cPath)
		    Endif 
		    cPath := "C:\Microsiga\EMP_"+_cEmp+"\"+SM0->M0_CODFIL+"\RET_ARMZ"
		    if !EXISTDIR(cPath)   
		    	nResult := MakeDir(cPath)
		    Endif 
		    cPath := "C:\Microsiga\EMP_"+_cEmp+"\"+SM0->M0_CODFIL+"\DEV_COMPRAS"
		    if !EXISTDIR(cPath)   
		    	nResult := MakeDir(cPath)
		    Endif 
		    cPath := "C:\Microsiga\EMP_"+_cEmp+"\"+SM0->M0_CODFIL+"\DEV_TROCA"
		    if !EXISTDIR(cPath)   
		    	nResult := MakeDir(cPath)
		    Endif 
		    If nResult <> 0
				Help(" ",1,"NOMAKEDIR")
				Return
			EndIf		                                                 
	
		    dbSkip()            
	   Enddo	
	EndDo

	dbGotop()
	While !Eof()    
	   _cEmp := SM0->M0_CODIGO
	   if !EXISTDIR("\XML\EMP_"+_cEmp)   
	    	nResult := MAKEDIR("\XML\EMP_"+_cEmp)
	   Endif                                               
		While !Eof() .And. (_cEmp = SM0->M0_CODIGO)
	                  
		    cPath := "\XML\EMP_"+_cEmp+"\"+SM0->M0_CODFIL
		    if !EXISTDIR(cPath)   
		    	nResult := MakeDir(cPath)
		    Endif 
		    cPath := "\XML\EMP_"+_cEmp+"\"+SM0->M0_CODFIL+"\duplicados"
		    if !EXISTDIR(cPath)   
		    	nResult := MakeDir(cPath)
		    Endif 
		    cPath := "\XML\EMP_"+_cEmp+"\"+SM0->M0_CODFIL+"\corrompidos"
		    if !EXISTDIR(cPath)   
		    	nResult := MakeDir(cPath)
		    Endif 
		    cPath := "\XML\EMP_"+_cEmp+"\"+SM0->M0_CODFIL+"\importados"
		    if !EXISTDIR(cPath)   
		    	nResult := MakeDir(cPath)
		    Endif 
		    cPath := "\XML\EMP_"+_cEmp+"\"+SM0->M0_CODFIL+"\recusadas"
		    if !EXISTDIR(cPath)   
		    	nResult := MakeDir(cPath)
		    Endif 
		    cPath := "\XML\EMP_"+_cEmp+"\"+SM0->M0_CODFIL+"\RET_ARMZ"
		    if !EXISTDIR(cPath)   
		    	nResult := MakeDir(cPath)
		    Endif 
		    cPath := "\XML\EMP_"+_cEmp+"\"+SM0->M0_CODFIL+"\DEV_COMPRAS"
		    if !EXISTDIR(cPath)   
		    	nResult := MakeDir(cPath)
		    Endif 
		    cPath := "\XML\EMP_"+_cEmp+"\"+SM0->M0_CODFIL+"\DEV_TROCA"
		    if !EXISTDIR(cPath)   
		    	nResult := MakeDir(cPath)
		    Endif 
		    If nResult <> 0
				Help(" ",1,"NOMAKEDIR")
				Return
			EndIf		                                                 
	
		    dbSkip()            
	   Enddo	
	EndDo

	RestArea( aArea )

Return




/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммммммяммммммммммкмммммммяммммммммммммммммммммкммммммяммммммммммммм╩╠╠
╠╠╨Programa  ЁLERXML    ╨Autor  ЁValdemir Jose       ╨ Data Ё  26/02/13   ╨╠╠
╠╠лммммммммммьммммммммммймммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc.     Ё Reapresenta o titulo do grid, conforme posicionado no      ╨╠╠
╠╠╨          Ё registro                                                   ╨╠╠
╠╠лммммммммммьмммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╧╠╠
╠╠╨Uso       Ё CCAB                                                       ╨╠╠
╠╠хммммммммммомммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Static Function REAPRESENTA()
	Local aArea := GetArea()
	
	if (LS3->NATOPER = 'DEVOLUCAO DE COMPRAS') 
		@ 250,005 say "CLIENTE   " SIZE 150,40 FONT oFont4 OF oTela PIXEL COLOR CLR_GREEN
	else
		@ 250,005 say "FORNECEDOR" SIZE 150,40 FONT oFont4 OF oTela PIXEL COLOR CLR_GREEN
	endif
	
    RestArea( aArea )                                         
    
Return





/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммммммяммммммммммкмммммммяммммммммммммммммммммкммммммяммммммммммммм╩╠╠
╠╠╨Programa  ЁLERXML    ╨Autor  ЁValdemir Jose       ╨ Data Ё  27/02/13   ╨╠╠
╠╠лммммммммммьммммммммммймммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc.     ЁIrА verificar de qual empresa e filial o XML faz parte      ╨╠╠
╠╠╨          Ёe irА transferir o arquivo para o local correspondente      ╨╠╠
╠╠лммммммммммьмммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╧╠╠
╠╠╨Uso       Ё CCAB                                                       ╨╠╠
╠╠хммммммммммомммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Static Function ValidaMoveXML(pSelecao,pLocal,pDest)
	Local   i, iMOV                   
	Local _cCNPJ, _cCNPJ2, _cCNPJ3  
	Local cCaminho   := ""
	private _oXml    := NIL
	private cError   := ''
	private cWarning := ''   
	         
	if pLocal = nil
		return
	endif     
	
	aXML:={}                  
	if pSelecao = nil     
		ADir(pLocal+"\*.XML",aXML)
		cCaminho   := pLocal
		iMOV := 1    // Move do XML para as pastas
	else
		ADir(pDest+"*.XML",aXML)
		cCaminho   := pDest
		iMOV := 2    // Move da as pasta para \XML
	endif

         
	For i := 1 To Len(aXML)
		nXmlStatus := XMLError()
		cFile	   := cServ+"\"+lower(ALLTRIM(aXML[i]))       //cCaminho
		oXml 	   := XmlParserFile(cFile,"_",@cError, @cWarning )
		lTipo	   :=3
		
		If ALLTRIM(TYPE("oxml:_NFE:_INFNFE"))=="O"
			lTipo:=1
		ElseIf ALLTRIM(TYPE("oxml:_NFEPROC:_NFE:_INFNFE"))=="O"
			lTipo:=2
		ElseIf AllTrim(Type("oXml:_CTEPROC:_CTE:_INFCTE")) == "O"
			lTipo := 4
		EndIf
		
		If Empty(@cError) .and. lTipo<>3
			
			If lTipo==1
				//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Sem _NFEPROC															Ё
				//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If SUBSTR(alltrim(oxml:_NFE:_INFNFE:_DEST:_IE:TEXT),1,1) $ "0/1/2/3/4/5/6/7/8/9"
					_cCNPJ2:=alltrim(oxml:_NFE:_INFNFE:_DEST:_CNPJ:TEXT)
				Endif
				_cCNPJ:=alltrim(oxml:_NFE:_INFNFE:_EMIT:_CNPJ:TEXT)
				cEmissao:=oxml:_NFE:_INFNFE:_IDE:_DEMI:TEXT
				cEmissao:=SUBSTR(cEmissao,1,4)+SUBSTR(cEmissao,6,2)+SUBSTR(cEmissao,9,2)
				cNota:=oxml:_NFE:_INFNFE:_IDE:_NNF:TEXT
				If Empty(cSerieNF)
					cSerie:=oxml:_NFE:_INFNFE:_IDE:_SERIE:TEXT
				Endif
				cNatOp:=oxml:_NFE:_INFNFE:_IDE:_NATOP:TEXT
				cChave:=ALLTRIM(SUBSTR(oxml:_NFE:_INFNFE:_ID:TEXT,4,200))
			ElseIf lTipo==2
				//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Com_NFEPROC											     			Ё
				//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				If SUBSTR(alltrim(oxml:_NFEPROC:_NFE:_INFNFE:_DEST:_IE:TEXT),1,1) $ "0/1/2/3/4/5/6/7/8/9" //oXml:_CTEPROC:_CTE:_INFCTE:_DEST:_IE:TEXT
					_cCNPJ2:=alltrim(oxml:_NFEPROC:_NFE:_INFNFE:_DEST:_CNPJ:TEXT) //oXml:_CTEPROC:_CTE:_INFCTE:_DEST:_CNPJ:TEXT
				Endif
				_cCNPJ:=alltrim(oxml:_NFEPROC:_NFE:_INFNFE:_EMIT:_CNPJ:TEXT)//oXml:_CTEPROC:_CTE:_INFCTE:_EMIT:_CNPJ:TEXT
				cNota:=oxml:_NFEPROC:_NFE:_INFNFE:_IDE:_NNF:TEXT//oXml:_CTEPROC:_CTE:_INFCTE:_IDE:_NCT:TEXT
				//If Empty(cSerieNF)
				//	cSerie:=oxml:_NFEPROC:_NFE:_INFNFE:_IDE:_SERIE:TEXT//oXml:_CTEPROC:_CTE:_INFCTE:_IDE:_SERIE:TEXT
				//Endif
				//cNatOp:=oxml:_NFEPROC:_NFE:_INFNFE:_IDE:_NATOP:TEXT //oXml:_CTEPROC:_CTE:_INFCTE:_IDE:_NATOP:TEXT
				//cEmissao:=oxml:_NFEPROC:_NFE:_INFNFE:_IDE:_DEMI:TEXT//oXml:_CTEPROC:_CTE:_INFCTE:_IDE:_DHEMI:TEXT
				//cEmissao:=SUBSTR(cEmissao,1,4)+SUBSTR(cEmissao,6,2)+SUBSTR(cEmissao,9,2)
				//cChave:=ALLTRIM(SUBSTR(oxml:_NFEPROC:_NFE:_INFNFE:_ID:TEXT,4,200))//Substring(oXml:_CTEPROC:_CTE:_INFCTE:_ID:TEXT,4,200)
			ElseIf lTipo == 4
				//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё CTE Com CTEPROC								Ё
				//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				
				//_cCNPJ2:=AllTrim(oXml:_CTEPROC:_CTE:_INFCTE:_DEST:_CNPJ:TEXT)	//#ECV20130104.o
				
				//#ECV20130104.bn
				If AllTrim(Type("oXml:_CTEPROC:_CTE:_INFCTE:_DEST:_CPF")) == "O" //Caso a TAG de CPF exista
					_cCNPJ2:=AllTrim(oXml:_CTEPROC:_CTE:_INFCTE:_DEST:_CPF:TEXT)
				
				ElseIf AllTrim(Type("oXml:_CTEPROC:_CTE:_INFCTE:_DEST:_CNPJ")) == "O" //Caso a TAG de CNPJ exista 	
					_cCNPJ2:=AllTrim(oXml:_CTEPROC:_CTE:_INFCTE:_DEST:_CNPJ:TEXT)
				
				EndIf		     
		
				If AllTrim(Type("oXml:_CTEPROC:_CTE:_INFCTE:_IDE:_TOMA4:_CNPJ")) == "O" //Caso a CCAB seja o tomador do servico  
					_cCNPJ3:= Alltrim(oXml:_CTEPROC:_CTE:_INFCTE:_IDE:_TOMA4:_CNPJ:TEXT)
				
				Else
					If AllTrim(Type("oXml:_CTEPROC:_CTE:_INFCTE:_REM:_CNPJ")) == "O"  
						_cCNPJ3:=Alltrim(oXml:_CTEPROC:_CTE:_INFCTE:_REM:_CNPJ:TEXT) //Criado para tratar a situacao onde o destinatario nao eh a CCAB e sim o cliente	
					
					ElseIf AllTrim(Type("oXml:_CTEPROC:_CTE:_INFCTE:_REM:_CPF")) == "O"  			
						_cCNPJ3:=Alltrim(oXml:_CTEPROC:_CTE:_INFCTE:_REM:_CPF:TEXT)
					
					EndIf
				
				EndIf
				//#ECV20130104.en
				
				_cCNPJ	:=Alltrim(oXml:_CTEPROC:_CTE:_INFCTE:_EMIT:_CNPJ:TEXT)
				//cNota	:=oXml:_CTEPROC:_CTE:_INFCTE:_IDE:_NCT:TEXT
				//If Empty(cSerieNF)
				//	cSerie	:=oXml:_CTEPROC:_CTE:_INFCTE:_IDE:_SERIE:TEXT
				//Endif
				//cNatOp	:=oXml:_CTEPROC:_CTE:_INFCTE:_IDE:_NATOP:TEXT
				//cEmissao:=oXml:_CTEPROC:_CTE:_INFCTE:_IDE:_DHEMI:TEXT
				//cEmissao:=SUBSTR(cEmissao,1,4)+SUBSTR(cEmissao,6,2)+SUBSTR(cEmissao,9,2)
				//cChave	:=Substr(oXml:_CTEPROC:_CTE:_INFCTE:_ID:TEXT,4,200)
			EndIf
			
			// Move arquivos para pasta correspondente no servidor
		   //	LocMovFil(_cCNPJ2, _cCNPJ3, lower(aXML[i]), iMOV)

		ENDIF	
	Next
	
	// Ler ConfiguraГЦo Sistema
	LerConfigura()
	
Return



/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммммммяммммммммммкмммммммяммммммммммммммммммммкммммммяммммммммммммм╩╠╠
╠╠╨Programa  ЁLERXML    ╨Autor  ЁValdemir Jose       ╨ Data Ё  27/02/13   ╨╠╠
╠╠лммммммммммьммммммммммймммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc.     Ё Localiza e move registro para pasta de filiais             ╨╠╠
╠╠╨          Ё                                                            ╨╠╠
╠╠лммммммммммьмммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╧╠╠
╠╠╨Uso       Ё CCAB                                                       ╨╠╠
╠╠хммммммммммомммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Static Function LocMovFil(_cCNPJ2, _cCNPJ3, pArqXml, pMov)
	Local aArea := GetArea()  
	Local cDE, cPara

	if pMov = 2

	    cDE  := _cLOCAL+"\"+pArqXml
	    cPara:= cSERV

		// Move para a pasta
		CpyT2S(cDE, cPara, .T.)
		//__CopyFile(cDE, cPara)
		//ferase(cDE)
	
		RestArea( aArea )
		Return	

	Endif	
	
	dbSelectArea('SM0')
	dbGotop()
	While !Eof()
	    // Move os Registros, conforme parametros
		if pMov = 1
			cDE   := _cLOCAL+"\"+pArqXml 
			cPara := cSERV+"\"
		endif

		if (_cCNPJ2 = SM0->M0_CGC) .or. (_cCNPJ3 = SM0->M0_CGC)       
            
			// Copia Arquivos para pasta lido
			//__CopyFile(cDE, cPara)
			CpyT2S(cDE, cPARA, .T.)
			//ferase(cDE)
			exit
		endif
		dbSkip()
	EndDo
	RestArea( aArea )
Return






/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммммммяммммммммммкмммммммяммммммммммммммммммммкммммммяммммммммммммм╩╠╠
╠╠╨Programa  ЁLERXML    ╨Autor  ЁValdemir Jose       ╨ Data Ё  22/05/13   ╨╠╠
╠╠лммммммммммьммммммммммймммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc.     Ё Ler Configuracao XML                                       ╨╠╠
╠╠╨          Ё                                                            ╨╠╠
╠╠лммммммммммьмммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╧╠╠
╠╠╨Uso       Ё AP                                                        ╨╠╠
╠╠хммммммммммомммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Static Function LerConfigura()

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Lendo o arquivo de configuracao										Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
cArqTxt := "\xml\config\cfgxml.txt"
cBuffer   := ""

IF !File("\xml")
	msgbox("NЦo existe o diretСrio XML no ROOTPATH")
	Return
Endif
IF !File("\xml\config")
	msgbox("NЦo existe o diretСrio CONFIG no diretСrio \XML")
	Return
Endif
IF !File(cServ+"\importados")
	msgbox("NЦo existe o diretСrio IMPORTADOS no diretСrio \XML")
	Return
Endif
IF !File(cServ+"\duplicados")
	msgbox("NЦo existe o diretСrio DUPLICADOS no diretСrio \XML")
	Return
Endif
IF !File(cServ+"\recusadas")
	msgbox("NЦo existe o diretСrio RECUSADAS no diretСrio \XML")
	Return
Endif
IF !File(cServ+"\corrompidos")
	msgbox("NЦo existe o diretСrio CORROMPIDOS no diretСrio \XML")
	Return
Endif

cSerie   :=''
cEspecie :=''
cAlmox   :=''
cUnidades:=''
cPedCom  :=.F.
cNDF     :=.F.
cAlmoPed :=space(02)
cZeros:=.F.

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Analisando configuracoes da rotina									Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If File(cArqTxt)
	FT_FUSE(cArqTxt)
	FT_FGOTOP()
	ProcRegua(FT_FLASTREC())
	
	While !FT_FEOF()
		cBuffer := FT_FREADLN()
		
		If UPPER(SUBSTR(cBuffer,1,9))=="EMAIL"+SM0->M0_CODIGO+SM0->M0_CODFIL
			xEMAILREC:=lower(ALLTRIM(SUBSTR(cBuffer,11,400)))
		Endif
		If UPPER(SUBSTR(cBuffer,1,3))=="POP"
			xPOP:=lower(ALLTRIM(SUBSTR(cBuffer,5,400)))
		Endif
		If UPPER(SUBSTR(cBuffer,1,5))=="CONTA"
			xCONTA:=lower(ALLTRIM(SUBSTR(cBuffer,7,400)))
		Endif
		If UPPER(SUBSTR(cBuffer,1,5))=="SENHA"
			xSENHA:=lower(ALLTRIM(SUBSTR(cBuffer,7,400)))
		Endif
		If UPPER(SUBSTR(cBuffer,1,4))==SM0->M0_CODIGO+SM0->M0_CODFIL
			cSerie:=UPPER(SUBSTR(cBuffer,6,3))
		Endif
		If UPPER(SUBSTR(cBuffer,1,7))=="ESP"+SM0->M0_CODIGO+SM0->M0_CODFIL
			cEspecie:=UPPER(SUBSTR(cBuffer,9,5))
		Endif
		If UPPER(SUBSTR(cBuffer,1,5))=="S"+SM0->M0_CODIGO+SM0->M0_CODFIL
			cAlmox:=UPPER(SUBSTR(cBuffer,7,2))
		Endif
		If UPPER(SUBSTR(cBuffer,1,2))=="UM"
			cUnidades:=ALLTRIM(UPPER(SUBSTR(cBuffer,4,400)))
		Endif
		If UPPER(SUBSTR(cBuffer,1,4))=="LOGO"
			cLogo:=ALLTRIM(UPPER(SUBSTR(cBuffer,6,200)))+space(200)
		Endif
		If UPPER(SUBSTR(cBuffer,1,5))=="P"+SM0->M0_CODIGO+SM0->M0_CODFIL
			cAlmoPed:=ALLTRIM(UPPER(SUBSTR(cBuffer,7,2)))
		Endif
		If UPPER(SUBSTR(cBuffer,1,6))=="PEDIDO"
			cPedCom:=.T.
		Endif
		If UPPER(SUBSTR(cBuffer,1,3))=="NDF"
			cNDF:=.T.
		Endif
		If UPPER(SUBSTR(cBuffer,1,7))=="NFZEROS"
			cZeros:=.T.
		Endif
		FT_FSKIP()
	EndDo
	FT_FUSE()
Else
	Msgbox("Arquivo de configuracao CFGXML.TXT nЦo encontrado no diretСrio \XML\CONFIG")
	Return
Endif

cSerieNF := cSerie

If Empty(cUnidades)
	Msgbox("Favor informar as Unidades de medidas fracionadas!")
	Return
Endif

Return



/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммммммяммммммммммкмммммммяммммммммммммммммммммкммммммяммммммммммммм╩╠╠
╠╠╨Programa  ЁLERXML    ╨Autor  ЁValdemir Jose       ╨ Data Ё  22/05/13   ╨╠╠
╠╠лммммммммммьммммммммммймммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc.     Ё Salva Registro nas Tabelas TEmporarias                     ╨╠╠
╠╠╨          Ё                                                            ╨╠╠
╠╠лммммммммммьмммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╧╠╠
╠╠╨Uso       Ё AP                                                        ╨╠╠
╠╠хммммммммммомммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Static Function SalveReg(npSelecao,aXML, pDest)
Local i := 0
                        
Procregua(len(aXML))                         
For i:=1 to len(aXML)
	
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Dados do XML														Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	IF (npSelecao = 1) .OR. (npSelecao = 2) .OR. (npSelecao = 4)

     XML(,aXML[i], pDest)

	 DbSelectarea("LS3")
	 Dbsetorder(1)
	 dbgotop()
	 Dbseek(cChave)         
         
     
	 //зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	 //Ё Fornecedor														     Ё
	 //юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	 If !Empty(_cCNPJ)     
		DbSelectarea("SA2")
		DbSetorder(3)
		Dbgotop()
		Dbseek(xFilial("SA2")+_cCNPJ)
		If Found()
			
			//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Verificando grupo													Ё
			//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			lFornec:=.T.
			If !Empty(_cOpcao) .and. alltrim(_cOpcao)<>"TODOS"
				If ALLTRIM(SA2->A2_GRPCOM)==_cOpcao
					lFornec:=.T.
				Else
					lFornec:=.F.
				Endif
				
				If Empty(SA2->A2_GRPCOM)
					Msgbox("Fornecedor "+SA2->A2_COD+"/"+ALLTRIM(SA2->A2_NREDUZ)+" estА sem o grupo de compras informado!","AtenГЦo...","ALERT")
				Endif
			Endif
			
			If lFornec
				Incproc(SA2->A2_NREDUZ)
				
				//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//Ё Verifico arquivos XML duplicados									Ё
				//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
				DbSelectarea("LS4")
				DbSetorder(1)
				Dbgotop()
				dbseek(SA2->A2_COD+SA2->A2_LOJA+cNota)
				If !Found()
					Reclock("LS4",.T.)
					LS4->NOTA		:= cNota
					LS4->FORNECEDOR := SA2->A2_COD
					LS4->LOJA		:= SA2->A2_LOJA
					MsUnlock()
					
					Reclock("LS3",.T.)
					LS3->EMISSAO  := STOD(cEmissao)
					LS3->NATOPER  := cNatOp                         // Valdemir 23/02/2013
					LS3->FORNEC   := SA2->A2_COD
					LS3->LOJA     := SA2->A2_LOJA
					LS3->VENDEDOR := SUBSTR(SA2->A2_REPRES,1,30)
					LS3->TELEFONE := alltrim(SA2->A2_DDD)+" "+alltrim(SUBSTR(SA2->A2_TEL,1,20))
					LS3->NOME	  := SA2->A2_NREDUZ
					LS3->XML	  := UPPER(aXML[i])
					LS3->NOTA	  := cNota
					LS3->CHAVE    := cChave
					LS3->MOEDA    := _nMoeda        // Valdemir Jose 20130612
					LS3->TXMOEDA  := _nTxMoeda      // Valdemir Jose
					MsUnlock()
					lAchou:=.T.
				Endif
			Endif
		Else
			FRename(pDest+"\"+lower(ALLTRIM(aXML[i])),pDest+"\"+lower(ALLTRIM(aXML[i]))+".dup")
			__CopyFile(pDest+"\*.dup", "\xml\EMP_"+_cEmp+"\"+cFilAnt+"\duplicados\")
			ferase(pDest+"\*.dup")
		Endif
	 Endif
    Else 
		// Clientes
     	XML(2,aXML[i], pDest)

		DbSelectarea("SA1")
		DbSetorder(3)
		Dbgotop()
		Dbseek(xFilial("SA1")+_cCNPJ)
		If Found()
			
			//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Verificando grupo													Ё
			//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			//
			Incproc(SA1->A1_NREDUZ)
			
			//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//Ё Verifico arquivos XML duplicados									Ё
			//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			DbSelectarea("LS4")
			DbSetorder(1)
			Dbgotop()
			dbseek(SA1->A1_COD+SA1->A1_LOJA+cNota)
			If !Found()
				Reclock("LS4",.T.)
				LS4->NOTA		:= cNota
				LS4->FORNECEDOR := SA1->A1_COD
				LS4->LOJA		:= SA1->A1_LOJA
				MsUnlock()
				
				Reclock("LS3",.T.)
				LS3->EMISSAO  := STOD(cEmissao)
				LS3->NATOPER  := cNatOp                         // Valdemir 23/02/2013
				LS3->FORNEC   := SA1->A1_COD
				LS3->LOJA     := SA1->A1_LOJA
				LS3->VENDEDOR := SUBSTR(SA1->A1_VEND,1,30)
				LS3->TELEFONE := alltrim(SA1->A1_DDD)+" "+alltrim(SUBSTR(SA1->A1_TEL,1,20))
				LS3->NOME	  := SA1->A1_NREDUZ
				LS3->XML	  := UPPER(aXML[i])
				LS3->NOTA	  := cNota
				LS3->CHAVE    := cChave   
				LS3->MOEDA    := _nMoeda        // Valdemir Jose 20130612
				LS3->TXMOEDA  := _nTxMoeda      // Valdemir Jose
				MsUnlock()
				lAchou:=.T.
			Endif
		Else
			FRename(pDest+"\"+lower(ALLTRIM(aXML[i])), pDest+"\"+lower(ALLTRIM(aXML[i]))+".dup")
			__CopyFile(pDest+"\*.dup", "\xml\EMP_"+cEmpAnt+"\"+cFilAnt+"\duplicados\")
			ferase(pDest+"\"+lower(ALLTRIM(aXML[i]))+".dup")
		Endif
    Endif
    PROCESS()
Next

DbSelectarea("LS1")
Dbsetorder(1)
Dbgotop()

  
Return



/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммммммяммммммммммкмммммммяммммммммммммммммммммкммммммяммммммммммммм╩╠╠
╠╠╨Programa  ЁLERXML    ╨Autor  Ё Valdemir Jose      ╨ Data Ё  24/05/13   ╨╠╠
╠╠лммммммммммьммммммммммймммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc.     Ё Finaliza Tela da Rotina de importaГЦo XML                  ╨╠╠
╠╠╨          Ё                                                            ╨╠╠
╠╠лммммммммммьмммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╧╠╠
╠╠╨Uso       Ё AP                                                        ╨╠╠
╠╠хммммммммммомммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Static Function SairTela() 
      
 IF Select('LS1') > 0      
	Dbselectarea("LS1")
	dbCloseArea("LS1")
	fErase( cArqTrab+ ".DBF" )
	fErase( cArqTrab+ OrdBagExt() )
 Endif
 If Select('LS2') > 0
	Dbselectarea("LS2")
	dbCloseArea("LS2")
	fErase( cArqTrab2+ ".DBF" )
	fErase( cArqTrab2+ OrdBagExt() )
 Endif
 if Select('LS3') > 0
	Dbselectarea("LS3")
	dbCloseArea("LS3")
	fErase( cArqTrab3+ ".DBF" )
	fErase( cArqTrab3+ OrdBagExt() )
 Endif
 if Select('LS4') > 0
	Dbselectarea("LS4")
	dbCloseArea("LS4")
	fErase( cArqTrab4+ ".DBF" )
	fErase( cArqTrab4+ OrdBagExt() )
 Endif
 If Select('LS5') > 0
	Dbselectarea("LS5")
	dbCloseArea("LS5")
	fErase( cArqTrab5+ ".DBF" )
	fErase( cArqTrab5+ OrdBagExt() )
 Endif
 
 //oTela:End() 
 //FreeObj(oTela)

Return




